#!/sbin/openrc-run

name="ypbind"
description="NIS domain binding daemon"

command="/usr/sbin/$name"
command_args="${nis_client_flags}"

depend()
{
	after modules
	need localmount net rpcbind
	keyword -shutdown -stop
}

start_pre()
{

# wait for network to be actually available
# this has been provided by the net-online service, which has been removed
# to avoid breakage of NIS every time, we add the check directly here

	timeout=${timeout:-30}
	[ "$timeout" -eq 0 ] && infinite=true || infinite=false
	while $infinite || [ "$timeout" -gt 0 ]; do
		nc -uz 255.255.255.255 111 > /dev/null 2>&1 && break
		sleep 1
		: $((timeout -= 1))
	done

	local _domain

	_domain=`domainname`
	if [ -z "$_domain" ]; then
		ewarn "NIS domainname(1) is not set."
		return 1
	fi
}
