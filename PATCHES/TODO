TODO
================================================================================

getboottime()
	- needs  G_ and V_ variant and applied correctly in the right places.
	- failed/xdr
	- xhr,  sys/sys/time.h

hostid?

failed/xej	sysv_msg ...
failed/xek	sysv_sem ...
failed/xel	sysy_shm ...
	}}} all three need proper OSD save/restore if we keep it?

xes -> vfs_cache.c needs review;  just applied blindly so far.
	- compiles now :)

Lots of &prison0 vs. V_prison0  (no &)  but only in some places;  check that!
	- the osd calls take the prison0 argument twice; check those still


vps_pager_getpages()



------------------------------------------
panic while just sitting in a vps shell for a while not doing anything;
I guess it's a lock leak in an error case?

root@rabbit3:~ # spin lock 0xffffffff81cdd700 (sched lock 0) held by 0xfffff80007731000 (tid 100003) too long
panic: spin lock held too long
cpuid = 3
time = 1501167600
KDB: stack backtrace:
db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 0xfffffe085f7cd3c0
vpanic() at vpanic+0x19c/frame 0xfffffe085f7cd440
panic() at panic+0x43/frame 0xfffffe085f7cd4a0
_mtx_lock_spin_cookie() at _mtx_lock_spin_cookie+0x328/frame 0xfffffe085f7cd520
__mtx_lock_spin_flags() at __mtx_lock_spin_flags+0xe0/frame 0xfffffe085f7cd560
sched_add() at sched_add+0xe4/frame 0xfffffe085f7cd5a0
setrunnable() at setrunnable+0x90/frame 0xfffffe085f7cd5c0
sleepq_broadcast() at sleepq_broadcast+0xe8/frame 0xfffffe085f7cd600
wakeupshlk() at wakeupshlk+0x168/frame 0xfffffe085f7cd650
__lockmgr_args() at __lockmgr_args+0x82e/frame 0xfffffe085f7cd6f0
lockmgr_unlock_fast_path() at lockmgr_unlock_fast_path+0x184/frame 0xfffffe085f7cd740
VOP_UNLOCK_APV() at VOP_UNLOCK_APV+0xe0/frame 0xfffffe085f7cd770
vn_statfile() at vn_statfile+0x72/frame 0xfffffe085f7cd7c0
kern_fstat() at kern_fstat+0xa8/frame 0xfffffe085f7cd810
freebsd11_fstat() at freebsd11_fstat+0x1d/frame 0xfffffe085f7cd980
amd64_syscall() at amd64_syscall+0x859/frame 0xfffffe085f7cdab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe085f7cdab0
--- syscall (0, FreeBSD ELF64, nosys), rip = 0x800638fca, rsp = 0x7fffffffd0e8, rbp = 0x7fffffffd190 ---
KDB: enter: panic
[ thread pid 991 tid 100086 ]
Stopped at      kdb_enter+0x3b: movq    $0,kdb_why

------------------------------------------

This keeps happening on vpsctl resume:

root@rabbit3:~ # vps_suspend_relink_delete: get_next_dirent() error=2

------------------------------------------

root@rabbit4:/ # vpsctl suspend testvps
root@rabbit4:/ # vpsctl snapshot testvps /var/tmp/testvps.snap

...

lock order reversal:
 1st 0xfffff801367dd078 vm map (user) (vm map (user)) @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/modules/vps_snapst/../../vps/vps_snapst.c:3225
 2nd 0xfffff800221f5068 nfs (nfs) @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/vfs_cache.c:2192
stack backtrace:
#0 0xffffffff80ac0da0 at witness_debugger+0x70
#1 0xffffffff80ac0c93 at witness_checkorder+0xe23
#2 0xffffffff80a335ee at lockmgr_lock_fast_path+0x6e
#3 0xffffffff81085810 at VOP_LOCK1_APV+0xe0
#4 0xffffffff80b3f68a at _vn_lock+0x6a
#5 0xffffffff80b18c9c at vn_vptocnp+0x12c
#6 0xffffffff80b18773 at vn_fullpath1+0xf3
#7 0xffffffff80b18e7f at vn_fullpath1_failsafe+0x3f
#8 0xffffffff824a9fff at vps_snapshot_vnode+0x7f
#9 0xffffffff824aa688 at vps_snapshot_vmobject+0x558
#10 0xffffffff824a7bdf at vps_snapshot+0x1bdf
#11 0xffffffff8247d0df at vps_ioc_snapshot+0x9f
#12 0xffffffff8092c3b0 at devfs_ioctl+0xc0
#13 0xffffffff810842e0 at VOP_IOCTL_APV+0xe0
#14 0xffffffff80b3e404 at vn_ioctl+0x124
#15 0xffffffff8092ca8f at devfs_ioctl_f+0x1f
#16 0xffffffff80ac69ad at kern_ioctl+0x2cd
#17 0xffffffff80ac666f at sys_ioctl+0x16f
lock order reversal:
 1st 0xfffff801367dd078 vm map (user) (vm map (user)) @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/modules/vps_snapst/../../vps/vps_snapst.c:3225                                        [6/1974]
 2nd 0xfffff8000daa0040 filedesc structure (filedesc structure) @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/vfs_lookup.c:378
stack backtrace:
#0 0xffffffff80ac0da0 at witness_debugger+0x70
#1 0xffffffff80ac0c93 at witness_checkorder+0xe23
#2 0xffffffff80a67d18 at _sx_slock+0x68
#3 0xffffffff80b21673 at namei+0x233
#4 0xffffffff80b3eed9 at vn_open_cred+0x209
#5 0xffffffff80b1d015 at vop_stdvptocnp+0x165
#6 0xffffffff81087a90 at VOP_VPTOCNP_APV+0xe0
#7 0xffffffff80b18cd1 at vn_vptocnp+0x161
#8 0xffffffff80b18773 at vn_fullpath1+0xf3
#9 0xffffffff80b18e7f at vn_fullpath1_failsafe+0x3f
#10 0xffffffff824a9fff at vps_snapshot_vnode+0x7f
#11 0xffffffff824aa688 at vps_snapshot_vmobject+0x558
#12 0xffffffff824a7bdf at vps_snapshot+0x1bdf
#13 0xffffffff8247d0df at vps_ioc_snapshot+0x9f
#14 0xffffffff8092c3b0 at devfs_ioctl+0xc0
#15 0xffffffff810842e0 at VOP_IOCTL_APV+0xe0
#16 0xffffffff80b3e404 at vn_ioctl+0x124
#17 0xffffffff8092ca8f at devfs_ioctl_f+0x1f
sched_switch() at sched_switch+0x4e0/frame 0xfffffe086075c900
mi_switch() at mi_switch+0x18b/frame 0xfffffe086075c930
thread_suspend_check() at thread_suspend_check+0x93/frame 0xfffffe086075c980
amd64_syscall() at amd64_syscall+0x160/frame 0xfffffe086075cab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe086075cab0
--- syscall (240, FreeBSD ELF64, sys_nanosleep), rip = 0x4236ba, rsp = 0x7fffffffe608, rbp = 0x7fffffffe640 ---
sched_switch() at sched_switch+0x4e0/frame 0xfffffe0860018900
mi_switch() at mi_switch+0x18b/frame 0xfffffe0860018930
thread_suspend_check() at thread_suspend_check+0x93/frame 0xfffffe0860018980
amd64_syscall() at amd64_syscall+0x160/frame 0xfffffe0860018ab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe0860018ab0
--- syscall (240, FreeBSD ELF64, sys_nanosleep), rip = 0x80093a75a, rsp = 0x7fffffffecc8, rbp = 0x7fffffffed10 ---
vps_snapshot: error=22

vps_snapshot_proc: vps_snapshot_proc_one(p=0xfffff8000d84b540) returned error

vps_snapshot_fdset: unsupported cap_rights: fc_nioctls=2 fc_fcntls=00000008

ioctl VPS_IOC_SNAPST: Invalid argument
Kernel error messages:
------------------------
vps_snapshot: error=22
vps_snapshot_proc: vps_snapshot_proc_one(p=0xfffff8000d84b540) returned error
vps_snapshot_fdset: unsupported cap_rights: fc_nioctls=2 fc_fcntls=00000008
------------------------

------------------------------------------

root@rabbit4:/ # spin lock 0xfffff8000772d000 (vps accounting) held by 0xfffff8004f37c000 (tid 100186) too long
panic: spin lock held too long
cpuid = 0
time = 1501268453
KDB: stack backtrace:
db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 0xfffffe083cb93700
vpanic() at vpanic+0x19c/frame 0xfffffe083cb93780
panic() at panic+0x43/frame 0xfffffe083cb937e0
_mtx_lock_spin_cookie() at _mtx_lock_spin_cookie+0x328/frame 0xfffffe083cb93860
__mtx_lock_spin_flags() at __mtx_lock_spin_flags+0xe0/frame 0xfffffe083cb938a0
_vps_account_runnable() at _vps_account_runnable+0x45/frame 0xfffffe083cb938d0
choosethread() at choosethread+0x69/frame 0xfffffe083cb938f0
sched_switch() at sched_switch+0x3d0/frame 0xfffffe083cb93950
mi_switch() at mi_switch+0x18b/frame 0xfffffe083cb93980
critical_exit() at critical_exit+0x96/frame 0xfffffe083cb939a0
sched_idletd() at sched_idletd+0xde/frame 0xfffffe083cb93a70
fork_exit() at fork_exit+0x84/frame 0xfffffe083cb93ab0
fork_trampoline() at fork_trampoline+0xe/frame 0xfffffe083cb93ab0
--- trap 0, rip = 0, rsp = 0, rbp = 0 ---
KDB: enter: panic
[ thread pid 11 tid 100003 ]
Stopped at      kdb_enter+0x3b: movq    $0,kdb_why
db> show alllocks
Process 1357 (cron) thread 0xfffff8004f37c000 (100186)
exclusive rw vm object (vm object) r = 0 (0xfffff8004f8e05a0) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/vm/vm_fault.c:570
shared sx vm map (user) (vm map (user)) r = 0 (0xfffff8004f87e078) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/vm/vm_map.c:4011
Process 1356 (cron) thread 0xfffff8000dd44580 (100192)
exclusive sleep mutex vnode interlock (vnode interlock) r = 0 (0xfffff8000dd48098) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/vfs_subr.c:3046
Process 1355 (cron) thread 0xfffff8000d0da580 (100113)
shared lockmgr nfs (nfs) r = 0 (0xfffff8000bf2c068) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/vfs_subr.c:2604
db>

------------------------------------------

on snapshot machine:

root@rabbit3:~ # panic: Bad link elm 0xfffff8000d873540 next->prev != elm
cpuid = 1
time = 1504193100
KDB: stack backtrace:
db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 0xfffffe085f974560
vpanic() at vpanic+0x19c/frame 0xfffffe085f9745e0
panic() at panic+0x43/frame 0xfffffe085f974640
proc_reap() at proc_reap+0x657/frame 0xfffffe085f974690
proc_to_reap() at proc_to_reap+0x383/frame 0xfffffe085f9746e0
kern_wait6() at kern_wait6+0x2fd/frame 0xfffffe085f974790
sys_wait4() at sys_wait4+0x78/frame 0xfffffe085f974980
amd64_syscall() at amd64_syscall+0x859/frame 0xfffffe085f974ab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe085f974ab0
--- syscall (7, FreeBSD ELF64, sys_wait4), rip = 0x800d645da, rsp = 0x7fffffffe538, rbp = 0x7fffffffe560 ---
KDB: enter: panic
[ thread pid 983 tid 100132 ]
Stopped at      kdb_enter+0x3b: movq    $0,kdb_why


on restored machine:

vps_suspend_relink_delete: get_next_dirent() error=2
trap_pfault: proc=0xfffff8000dcc2540/2 map=0xfffff8000dc64000 eva=0000000000000000 prot=4 rv=1
trap_pfault: proc=0xfffff8000dcc2540/2 map=0xfffff8000dc64000 eva=0000000000000000 prot=4 rv=1
panic: Bad link elm 0xfffff8000dcc2540 next->prev != elm
cpuid = 3
time = 1504192997
KDB: stack backtrace:
db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 0xfffffe08602e4560
vpanic() at vpanic+0x19c/frame 0xfffffe08602e45e0
panic() at panic+0x43/frame 0xfffffe08602e4640
proc_reap() at proc_reap+0x657/frame 0xfffffe08602e4690
proc_to_reap() at proc_to_reap+0x383/frame 0xfffffe08602e46e0
kern_wait6() at kern_wait6+0x2fd/frame 0xfffffe08602e4790
sys_wait4() at sys_wait4+0x78/frame 0xfffffe08602e4980
amd64_syscall() at amd64_syscall+0x859/frame 0xfffffe08602e4ab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe08602e4ab0
--- syscall (7, FreeBSD ELF64, sys_wait4), rip = 0x42353a, rsp = 0x7fffffffe778, rbp = 0x7fffffffe810 ---
KDB: enter: panic
[ thread pid 1 tid 100185 ]
Stopped at      kdb_enter+0x3b: movq    $0,kdb_why


(kgdb) l *proc_reap+0x657
0xffffffff80a1b147 is at atomic.h:442.
437     ATOMIC_ASM(add,      short, "addw %w1,%0", "ir",  v);
438     ATOMIC_ASM(subtract, short, "subw %w1,%0", "ir",  v);
439
440     ATOMIC_ASM(set,      int,   "orl %1,%0",   "ir",  v);
441     ATOMIC_ASM(clear,    int,   "andl %1,%0",  "ir", ~v);
442     ATOMIC_ASM(add,      int,   "addl %1,%0",  "ir",  v);
443     ATOMIC_ASM(subtract, int,   "subl %1,%0",  "ir",  v);
444
445     ATOMIC_ASM(set,      long,  "orq %1,%0",   "ir",  v);
446     ATOMIC_ASM(clear,    long,  "andq %1,%0",  "ir", ~v);

(kgdb) l *proc_reap+0x630
0xffffffff80a1b120 is in proc_reap (/tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/kern_exit.c:1011).
1006            /*
1007             * Free any domain policy that's still hiding around.
1008             */
1009            vm_domain_policy_cleanup(&p->p_vm_dom_policy);
1010
1011            KASSERT(FIRST_THREAD_IN_PROC(p),
1012                ("proc_reap: no residual thread!"));
1013            uma_zfree(proc_zone, p);
1014            atomic_add_int(&V_nprocs, -1);
1015    #ifdef VPS



on reboot:
panic: Bad link elm 0xfffff80007735540 prev->next != elm
cpuid = 3
time = 1504262883
KDB: stack backtrace:
db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 0xfffffe083cb6e560
vpanic() at vpanic+0x19c/frame 0xfffffe083cb6e5e0
panic() at panic+0x43/frame 0xfffffe083cb6e640
proc_reap() at proc_reap+0x678/frame 0xfffffe083cb6e690
proc_to_reap() at proc_to_reap+0x383/frame 0xfffffe083cb6e6e0
kern_wait6() at kern_wait6+0x2fd/frame 0xfffffe083cb6e790
sys_wait4() at sys_wait4+0x78/frame 0xfffffe083cb6e980
amd64_syscall() at amd64_syscall+0x859/frame 0xfffffe083cb6eab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe083cb6eab0
--- syscall (7, FreeBSD ELF64, sys_wait4), rip = 0x42353a, rsp = 0x7fffffffe7a8, rbp = 0x7fffffffe810 ---
KDB: enter: panic
[ thread pid 1 tid 100002 ]
Stopped at      kdb_enter+0x3b: movq    $0,kdb_why
db> show reg
cs                        0x20
ds                        0x3b
es                        0x3b
fs                        0x13
gs                        0x1b
ss                        0x28
rax                       0x12
rcx                       0x80
rdx         0xfffffe083cb6e450
rbx         0xffffffff8147ce08  thread_off_td_plist+0x2aa0
rsp         0xfffffe083cb6e550
rbp         0xfffffe083cb6e560
rsi                       0x80
rdi         0xffffffff81cc39e0  cnputs_mtx+0x18
r8          0xffffffff80aa7690  putchar
r9                       0x1d0
r10         0xffffffff81bb5640  vga_conssoftc
r11                       0x10
r12         0xfffff80007737601
r13         0xfffff80007735678
r14         0xfffffe083cb6e620
r15         0xfffff8000773b580
rip         0xffffffff80aa132b  kdb_enter+0x3b
rflags                    0x82
kdb_enter+0x3b: movq    $0,kdb_why
db> show alllocks
Process 1 (init) thread 0xfffff8000773b580 (100002)
exclusive sx proctree_0xfffff80007199800 (proctree_0xfffff80007199800) r = 0 (0xfffffe0000da92c8) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/kern_exit.c:1287
db> show allpcpu
Current CPU: 3

cpuid        = 0
dynamic pcpu = 0x9b7c00
curthread    = 0xfffff8000773b000: pid 11 tid 100003 "idle: cpu0"
curpcb       = 0xfffffe083cb73b80
fpcurthread  = none
idlethread   = 0xfffff8000773b000: tid 100003 "idle: cpu0"
curpmap      = 0xffffffff81ee4548
tssp         = 0xffffffff81f16d10
commontssp   = 0xffffffff81f16d10
rsp0         = 0xfffffe083cb73b80
gs32p        = 0xffffffff81f1d568
ldt          = 0xffffffff81f1d5a8
tss          = 0xffffffff81f1d598
curvnet      = 0
spin locks held:
cpuid        = 1
dynamic pcpu = 0xfffffe08bb0efc00
curthread    = 0xfffff8000773a580: pid 11 tid 100004 "idle: cpu1"
curpcb       = 0xfffffe083cb78b80
fpcurthread  = none
idlethread   = 0xfffff8000773a580: tid 100004 "idle: cpu1"
curpmap      = 0xffffffff81ee4548
tssp         = 0xffffffff81f16d78
commontssp   = 0xffffffff81f16d78
rsp0         = 0xfffffe083cb78b80
gs32p        = 0xffffffff81f1d5d0
ldt          = 0xffffffff81f1d610
tss          = 0xffffffff81f1d600
curvnet      = 0
spin locks held:

cpuid        = 2
dynamic pcpu = 0xfffffe08bb0f7c00
curthread    = 0xfffff8000773a000: pid 11 tid 100005 "idle: cpu2"
curpcb       = 0xfffffe083cb7db80
fpcurthread  = none
idlethread   = 0xfffff8000773a000: tid 100005 "idle: cpu2"
curpmap      = 0xffffffff81ee4548
tssp         = 0xffffffff81f16de0
commontssp   = 0xffffffff81f16de0
rsp0         = 0xfffffe083cb7db80
gs32p        = 0xffffffff81f1d638
ldt          = 0xffffffff81f1d678
tss          = 0xffffffff81f1d668
curvnet      = 0
spin locks held:
cpuid        = 3
dynamic pcpu = 0xfffffe08bb0ffc00
curthread    = 0xfffff8000773b580: pid 1 tid 100002 "init"
curpcb       = 0xfffffe083cb6eb80
fpcurthread  = none
idlethread   = 0xfffff80007739580: tid 100006 "idle: cpu3"
curpmap      = 0xfffff8000d4f1130
tssp         = 0xffffffff81f16e48
commontssp   = 0xffffffff81f16e48
rsp0         = 0xfffffe083cb6eb80
gs32p        = 0xffffffff81f1d6a0
ldt          = 0xffffffff81f1d6e0
tss          = 0xffffffff81f1d6d0
curvnet      = 0
spin locks held:

db>
db> trace 100002
Tracing pid 1 tid 100002 td 0xfffff8000773b580
kdb_enter() at kdb_enter+0x3b/frame 0xfffffe083cb6e560
vpanic() at vpanic+0x1b9/frame 0xfffffe083cb6e5e0
panic() at panic+0x43/frame 0xfffffe083cb6e640
proc_reap() at proc_reap+0x678/frame 0xfffffe083cb6e690
proc_to_reap() at proc_to_reap+0x383/frame 0xfffffe083cb6e6e0
kern_wait6() at kern_wait6+0x2fd/frame 0xfffffe083cb6e790
sys_wait4() at sys_wait4+0x78/frame 0xfffffe083cb6e980
amd64_syscall() at amd64_syscall+0x859/frame 0xfffffe083cb6eab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe083cb6eab0
--- syscall (7, FreeBSD ELF64, sys_wait4), rip = 0x42353a, rsp = 0x7fffffffe7a8, rbp = 0x7fffffffe810 ---


------------------------------------------

After migration the dead VPS hangs around.  Seems the interface count is still up..

root@rabbit3:~ # vpsctl list
Active VPS instaXXX-BZ proc_reap:1011 proc 0xfffff8000dcbfa80 threads 0xfffff8000dcbfa90
nces: 1
Name                 State    VFS Root                     %CPU   Virtual Size
dead_testvps         dead                                     0              0
root@rabbit3:~ # vpsctl show dead_testvps
Name:          dXXX-BZ proc_reap:1011 proc 0xfffff8000dcbfa80 threads 0xfffff8000dcbfa90
ead_testvps
Status:        dead
VFS root:
Processes:            0
Sockets:              0
Interfaces:           2
Restore count:        0

* still two interfaces;  never hit vps_destroy, need to add a panic there and trace back how we should get there next
* printfs are there not seen so trace the callgraph on how to get there

* also seeing two references left and I assume those are the two interfaces.

--------------------------------------------------------------------------------






# end
