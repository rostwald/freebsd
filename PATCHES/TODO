TODO
================================================================================

getboottime()
	- needs  G_ and V_ variant and applied correctly in the right places.
	- failed/xdr
	- xhr,  sys/sys/time.h

hostid?

failed/xej	sysv_msg ...
failed/xek	sysv_sem ...
failed/xel	sysy_shm ...
	}}} all three need proper OSD save/restore if we keep it?

xes -> vfs_cache.c needs review;  just applied blindly so far.
	- compiles now :)

Lots of &prison0 vs. V_prison0  (no &)  but only in some places;  check that!
	- the osd calls take the prison0 argument twice; check those still


vps_pager_getpages()



------------------------------------------
panic while just sitting in a vps shell for a while not doing anything;
I guess it's a lock leak in an error case?

root@rabbit3:~ # spin lock 0xffffffff81cdd700 (sched lock 0) held by 0xfffff80007731000 (tid 100003) too long
panic: spin lock held too long
cpuid = 3
time = 1501167600
KDB: stack backtrace:
db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 0xfffffe085f7cd3c0
vpanic() at vpanic+0x19c/frame 0xfffffe085f7cd440
panic() at panic+0x43/frame 0xfffffe085f7cd4a0
_mtx_lock_spin_cookie() at _mtx_lock_spin_cookie+0x328/frame 0xfffffe085f7cd520
__mtx_lock_spin_flags() at __mtx_lock_spin_flags+0xe0/frame 0xfffffe085f7cd560
sched_add() at sched_add+0xe4/frame 0xfffffe085f7cd5a0
setrunnable() at setrunnable+0x90/frame 0xfffffe085f7cd5c0
sleepq_broadcast() at sleepq_broadcast+0xe8/frame 0xfffffe085f7cd600
wakeupshlk() at wakeupshlk+0x168/frame 0xfffffe085f7cd650
__lockmgr_args() at __lockmgr_args+0x82e/frame 0xfffffe085f7cd6f0
lockmgr_unlock_fast_path() at lockmgr_unlock_fast_path+0x184/frame 0xfffffe085f7cd740
VOP_UNLOCK_APV() at VOP_UNLOCK_APV+0xe0/frame 0xfffffe085f7cd770
vn_statfile() at vn_statfile+0x72/frame 0xfffffe085f7cd7c0
kern_fstat() at kern_fstat+0xa8/frame 0xfffffe085f7cd810
freebsd11_fstat() at freebsd11_fstat+0x1d/frame 0xfffffe085f7cd980
amd64_syscall() at amd64_syscall+0x859/frame 0xfffffe085f7cdab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe085f7cdab0
--- syscall (0, FreeBSD ELF64, nosys), rip = 0x800638fca, rsp = 0x7fffffffd0e8, rbp = 0x7fffffffd190 ---
KDB: enter: panic
[ thread pid 991 tid 100086 ]
Stopped at      kdb_enter+0x3b: movq    $0,kdb_why

------------------------------------------

This keeps happening on vpsctl resume:

root@rabbit3:~ # vps_suspend_relink_delete: get_next_dirent() error=2

------------------------------------------

root@rabbit4:/ # vpsctl suspend testvps
root@rabbit4:/ # vpsctl snapshot testvps /var/tmp/testvps.snap

...

lock order reversal:
 1st 0xfffff801367dd078 vm map (user) (vm map (user)) @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/modules/vps_snapst/../../vps/vps_snapst.c:3225
 2nd 0xfffff800221f5068 nfs (nfs) @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/vfs_cache.c:2192
stack backtrace:
#0 0xffffffff80ac0da0 at witness_debugger+0x70
#1 0xffffffff80ac0c93 at witness_checkorder+0xe23
#2 0xffffffff80a335ee at lockmgr_lock_fast_path+0x6e
#3 0xffffffff81085810 at VOP_LOCK1_APV+0xe0
#4 0xffffffff80b3f68a at _vn_lock+0x6a
#5 0xffffffff80b18c9c at vn_vptocnp+0x12c
#6 0xffffffff80b18773 at vn_fullpath1+0xf3
#7 0xffffffff80b18e7f at vn_fullpath1_failsafe+0x3f
#8 0xffffffff824a9fff at vps_snapshot_vnode+0x7f
#9 0xffffffff824aa688 at vps_snapshot_vmobject+0x558
#10 0xffffffff824a7bdf at vps_snapshot+0x1bdf
#11 0xffffffff8247d0df at vps_ioc_snapshot+0x9f
#12 0xffffffff8092c3b0 at devfs_ioctl+0xc0
#13 0xffffffff810842e0 at VOP_IOCTL_APV+0xe0
#14 0xffffffff80b3e404 at vn_ioctl+0x124
#15 0xffffffff8092ca8f at devfs_ioctl_f+0x1f
#16 0xffffffff80ac69ad at kern_ioctl+0x2cd
#17 0xffffffff80ac666f at sys_ioctl+0x16f
lock order reversal:
 1st 0xfffff801367dd078 vm map (user) (vm map (user)) @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/modules/vps_snapst/../../vps/vps_snapst.c:3225                                        [6/1974]
 2nd 0xfffff8000daa0040 filedesc structure (filedesc structure) @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/vfs_lookup.c:378
stack backtrace:
#0 0xffffffff80ac0da0 at witness_debugger+0x70
#1 0xffffffff80ac0c93 at witness_checkorder+0xe23
#2 0xffffffff80a67d18 at _sx_slock+0x68
#3 0xffffffff80b21673 at namei+0x233
#4 0xffffffff80b3eed9 at vn_open_cred+0x209
#5 0xffffffff80b1d015 at vop_stdvptocnp+0x165
#6 0xffffffff81087a90 at VOP_VPTOCNP_APV+0xe0
#7 0xffffffff80b18cd1 at vn_vptocnp+0x161
#8 0xffffffff80b18773 at vn_fullpath1+0xf3
#9 0xffffffff80b18e7f at vn_fullpath1_failsafe+0x3f
#10 0xffffffff824a9fff at vps_snapshot_vnode+0x7f
#11 0xffffffff824aa688 at vps_snapshot_vmobject+0x558
#12 0xffffffff824a7bdf at vps_snapshot+0x1bdf
#13 0xffffffff8247d0df at vps_ioc_snapshot+0x9f
#14 0xffffffff8092c3b0 at devfs_ioctl+0xc0
#15 0xffffffff810842e0 at VOP_IOCTL_APV+0xe0
#16 0xffffffff80b3e404 at vn_ioctl+0x124
#17 0xffffffff8092ca8f at devfs_ioctl_f+0x1f
sched_switch() at sched_switch+0x4e0/frame 0xfffffe086075c900
mi_switch() at mi_switch+0x18b/frame 0xfffffe086075c930
thread_suspend_check() at thread_suspend_check+0x93/frame 0xfffffe086075c980
amd64_syscall() at amd64_syscall+0x160/frame 0xfffffe086075cab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe086075cab0
--- syscall (240, FreeBSD ELF64, sys_nanosleep), rip = 0x4236ba, rsp = 0x7fffffffe608, rbp = 0x7fffffffe640 ---
sched_switch() at sched_switch+0x4e0/frame 0xfffffe0860018900
mi_switch() at mi_switch+0x18b/frame 0xfffffe0860018930
thread_suspend_check() at thread_suspend_check+0x93/frame 0xfffffe0860018980
amd64_syscall() at amd64_syscall+0x160/frame 0xfffffe0860018ab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe0860018ab0
--- syscall (240, FreeBSD ELF64, sys_nanosleep), rip = 0x80093a75a, rsp = 0x7fffffffecc8, rbp = 0x7fffffffed10 ---
vps_snapshot: error=22

vps_snapshot_proc: vps_snapshot_proc_one(p=0xfffff8000d84b540) returned error

vps_snapshot_fdset: unsupported cap_rights: fc_nioctls=2 fc_fcntls=00000008

ioctl VPS_IOC_SNAPST: Invalid argument
Kernel error messages:
------------------------
vps_snapshot: error=22
vps_snapshot_proc: vps_snapshot_proc_one(p=0xfffff8000d84b540) returned error
vps_snapshot_fdset: unsupported cap_rights: fc_nioctls=2 fc_fcntls=00000008
------------------------

------------------------------------------

root@rabbit4:/ # spin lock 0xfffff8000772d000 (vps accounting) held by 0xfffff8004f37c000 (tid 100186) too long
panic: spin lock held too long
cpuid = 0
time = 1501268453
KDB: stack backtrace:
db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 0xfffffe083cb93700
vpanic() at vpanic+0x19c/frame 0xfffffe083cb93780
panic() at panic+0x43/frame 0xfffffe083cb937e0
_mtx_lock_spin_cookie() at _mtx_lock_spin_cookie+0x328/frame 0xfffffe083cb93860
__mtx_lock_spin_flags() at __mtx_lock_spin_flags+0xe0/frame 0xfffffe083cb938a0
_vps_account_runnable() at _vps_account_runnable+0x45/frame 0xfffffe083cb938d0
choosethread() at choosethread+0x69/frame 0xfffffe083cb938f0
sched_switch() at sched_switch+0x3d0/frame 0xfffffe083cb93950
mi_switch() at mi_switch+0x18b/frame 0xfffffe083cb93980
critical_exit() at critical_exit+0x96/frame 0xfffffe083cb939a0
sched_idletd() at sched_idletd+0xde/frame 0xfffffe083cb93a70
fork_exit() at fork_exit+0x84/frame 0xfffffe083cb93ab0
fork_trampoline() at fork_trampoline+0xe/frame 0xfffffe083cb93ab0
--- trap 0, rip = 0, rsp = 0, rbp = 0 ---
KDB: enter: panic
[ thread pid 11 tid 100003 ]
Stopped at      kdb_enter+0x3b: movq    $0,kdb_why
db> show alllocks
Process 1357 (cron) thread 0xfffff8004f37c000 (100186)
exclusive rw vm object (vm object) r = 0 (0xfffff8004f8e05a0) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/vm/vm_fault.c:570
shared sx vm map (user) (vm map (user)) r = 0 (0xfffff8004f87e078) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/vm/vm_map.c:4011
Process 1356 (cron) thread 0xfffff8000dd44580 (100192)
exclusive sleep mutex vnode interlock (vnode interlock) r = 0 (0xfffff8000dd48098) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/vfs_subr.c:3046
Process 1355 (cron) thread 0xfffff8000d0da580 (100113)
shared lockmgr nfs (nfs) r = 0 (0xfffff8000bf2c068) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/vfs_subr.c:2604
db>

------------------------------------------

on snapshot machine:

root@rabbit3:~ # panic: Bad link elm 0xfffff8000d873540 next->prev != elm
cpuid = 1
time = 1504193100
KDB: stack backtrace:
db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 0xfffffe085f974560
vpanic() at vpanic+0x19c/frame 0xfffffe085f9745e0
panic() at panic+0x43/frame 0xfffffe085f974640
proc_reap() at proc_reap+0x657/frame 0xfffffe085f974690
proc_to_reap() at proc_to_reap+0x383/frame 0xfffffe085f9746e0
kern_wait6() at kern_wait6+0x2fd/frame 0xfffffe085f974790
sys_wait4() at sys_wait4+0x78/frame 0xfffffe085f974980
amd64_syscall() at amd64_syscall+0x859/frame 0xfffffe085f974ab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe085f974ab0
--- syscall (7, FreeBSD ELF64, sys_wait4), rip = 0x800d645da, rsp = 0x7fffffffe538, rbp = 0x7fffffffe560 ---
KDB: enter: panic
[ thread pid 983 tid 100132 ]
Stopped at      kdb_enter+0x3b: movq    $0,kdb_why


on restored machine:

vps_suspend_relink_delete: get_next_dirent() error=2
trap_pfault: proc=0xfffff8000dcc2540/2 map=0xfffff8000dc64000 eva=0000000000000000 prot=4 rv=1
trap_pfault: proc=0xfffff8000dcc2540/2 map=0xfffff8000dc64000 eva=0000000000000000 prot=4 rv=1
panic: Bad link elm 0xfffff8000dcc2540 next->prev != elm
cpuid = 3
time = 1504192997
KDB: stack backtrace:
db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 0xfffffe08602e4560
vpanic() at vpanic+0x19c/frame 0xfffffe08602e45e0
panic() at panic+0x43/frame 0xfffffe08602e4640
proc_reap() at proc_reap+0x657/frame 0xfffffe08602e4690
proc_to_reap() at proc_to_reap+0x383/frame 0xfffffe08602e46e0
kern_wait6() at kern_wait6+0x2fd/frame 0xfffffe08602e4790
sys_wait4() at sys_wait4+0x78/frame 0xfffffe08602e4980
amd64_syscall() at amd64_syscall+0x859/frame 0xfffffe08602e4ab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe08602e4ab0
--- syscall (7, FreeBSD ELF64, sys_wait4), rip = 0x42353a, rsp = 0x7fffffffe778, rbp = 0x7fffffffe810 ---
KDB: enter: panic
[ thread pid 1 tid 100185 ]
Stopped at      kdb_enter+0x3b: movq    $0,kdb_why

This seems to be p_reaplist not properly saved and restored.

(kgdb) l *proc_reap+0x657
0xffffffff80a1b147 is at atomic.h:442.
437     ATOMIC_ASM(add,      short, "addw %w1,%0", "ir",  v);
438     ATOMIC_ASM(subtract, short, "subw %w1,%0", "ir",  v);
439
440     ATOMIC_ASM(set,      int,   "orl %1,%0",   "ir",  v);
441     ATOMIC_ASM(clear,    int,   "andl %1,%0",  "ir", ~v);
442     ATOMIC_ASM(add,      int,   "addl %1,%0",  "ir",  v);
443     ATOMIC_ASM(subtract, int,   "subl %1,%0",  "ir",  v);
444
445     ATOMIC_ASM(set,      long,  "orq %1,%0",   "ir",  v);
446     ATOMIC_ASM(clear,    long,  "andq %1,%0",  "ir", ~v);

(kgdb) l *proc_reap+0x630
0xffffffff80a1b120 is in proc_reap (/tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/kern_exit.c:1011).
1006            /*
1007             * Free any domain policy that's still hiding around.
1008             */
1009            vm_domain_policy_cleanup(&p->p_vm_dom_policy);
1010
1011            KASSERT(FIRST_THREAD_IN_PROC(p),
1012                ("proc_reap: no residual thread!"));
1013            uma_zfree(proc_zone, p);
1014            atomic_add_int(&V_nprocs, -1);
1015    #ifdef VPS



on reboot:
panic: Bad link elm 0xfffff80007735540 prev->next != elm
cpuid = 3
time = 1504262883
KDB: stack backtrace:
db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 0xfffffe083cb6e560
vpanic() at vpanic+0x19c/frame 0xfffffe083cb6e5e0
panic() at panic+0x43/frame 0xfffffe083cb6e640
proc_reap() at proc_reap+0x678/frame 0xfffffe083cb6e690
proc_to_reap() at proc_to_reap+0x383/frame 0xfffffe083cb6e6e0
kern_wait6() at kern_wait6+0x2fd/frame 0xfffffe083cb6e790
sys_wait4() at sys_wait4+0x78/frame 0xfffffe083cb6e980
amd64_syscall() at amd64_syscall+0x859/frame 0xfffffe083cb6eab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe083cb6eab0
--- syscall (7, FreeBSD ELF64, sys_wait4), rip = 0x42353a, rsp = 0x7fffffffe7a8, rbp = 0x7fffffffe810 ---
KDB: enter: panic
[ thread pid 1 tid 100002 ]
Stopped at      kdb_enter+0x3b: movq    $0,kdb_why
db> show reg
cs                        0x20
ds                        0x3b
es                        0x3b
fs                        0x13
gs                        0x1b
ss                        0x28
rax                       0x12
rcx                       0x80
rdx         0xfffffe083cb6e450
rbx         0xffffffff8147ce08  thread_off_td_plist+0x2aa0
rsp         0xfffffe083cb6e550
rbp         0xfffffe083cb6e560
rsi                       0x80
rdi         0xffffffff81cc39e0  cnputs_mtx+0x18
r8          0xffffffff80aa7690  putchar
r9                       0x1d0
r10         0xffffffff81bb5640  vga_conssoftc
r11                       0x10
r12         0xfffff80007737601
r13         0xfffff80007735678
r14         0xfffffe083cb6e620
r15         0xfffff8000773b580
rip         0xffffffff80aa132b  kdb_enter+0x3b
rflags                    0x82
kdb_enter+0x3b: movq    $0,kdb_why
db> show alllocks
Process 1 (init) thread 0xfffff8000773b580 (100002)
exclusive sx proctree_0xfffff80007199800 (proctree_0xfffff80007199800) r = 0 (0xfffffe0000da92c8) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/kern_exit.c:1287
db> show allpcpu
Current CPU: 3

cpuid        = 0
dynamic pcpu = 0x9b7c00
curthread    = 0xfffff8000773b000: pid 11 tid 100003 "idle: cpu0"
curpcb       = 0xfffffe083cb73b80
fpcurthread  = none
idlethread   = 0xfffff8000773b000: tid 100003 "idle: cpu0"
curpmap      = 0xffffffff81ee4548
tssp         = 0xffffffff81f16d10
commontssp   = 0xffffffff81f16d10
rsp0         = 0xfffffe083cb73b80
gs32p        = 0xffffffff81f1d568
ldt          = 0xffffffff81f1d5a8
tss          = 0xffffffff81f1d598
curvnet      = 0
spin locks held:
cpuid        = 1
dynamic pcpu = 0xfffffe08bb0efc00
curthread    = 0xfffff8000773a580: pid 11 tid 100004 "idle: cpu1"
curpcb       = 0xfffffe083cb78b80
fpcurthread  = none
idlethread   = 0xfffff8000773a580: tid 100004 "idle: cpu1"
curpmap      = 0xffffffff81ee4548
tssp         = 0xffffffff81f16d78
commontssp   = 0xffffffff81f16d78
rsp0         = 0xfffffe083cb78b80
gs32p        = 0xffffffff81f1d5d0
ldt          = 0xffffffff81f1d610
tss          = 0xffffffff81f1d600
curvnet      = 0
spin locks held:

cpuid        = 2
dynamic pcpu = 0xfffffe08bb0f7c00
curthread    = 0xfffff8000773a000: pid 11 tid 100005 "idle: cpu2"
curpcb       = 0xfffffe083cb7db80
fpcurthread  = none
idlethread   = 0xfffff8000773a000: tid 100005 "idle: cpu2"
curpmap      = 0xffffffff81ee4548
tssp         = 0xffffffff81f16de0
commontssp   = 0xffffffff81f16de0
rsp0         = 0xfffffe083cb7db80
gs32p        = 0xffffffff81f1d638
ldt          = 0xffffffff81f1d678
tss          = 0xffffffff81f1d668
curvnet      = 0
spin locks held:
cpuid        = 3
dynamic pcpu = 0xfffffe08bb0ffc00
curthread    = 0xfffff8000773b580: pid 1 tid 100002 "init"
curpcb       = 0xfffffe083cb6eb80
fpcurthread  = none
idlethread   = 0xfffff80007739580: tid 100006 "idle: cpu3"
curpmap      = 0xfffff8000d4f1130
tssp         = 0xffffffff81f16e48
commontssp   = 0xffffffff81f16e48
rsp0         = 0xfffffe083cb6eb80
gs32p        = 0xffffffff81f1d6a0
ldt          = 0xffffffff81f1d6e0
tss          = 0xffffffff81f1d6d0
curvnet      = 0
spin locks held:

db>
db> trace 100002
Tracing pid 1 tid 100002 td 0xfffff8000773b580
kdb_enter() at kdb_enter+0x3b/frame 0xfffffe083cb6e560
vpanic() at vpanic+0x1b9/frame 0xfffffe083cb6e5e0
panic() at panic+0x43/frame 0xfffffe083cb6e640
proc_reap() at proc_reap+0x678/frame 0xfffffe083cb6e690
proc_to_reap() at proc_to_reap+0x383/frame 0xfffffe083cb6e6e0
kern_wait6() at kern_wait6+0x2fd/frame 0xfffffe083cb6e790
sys_wait4() at sys_wait4+0x78/frame 0xfffffe083cb6e980
amd64_syscall() at amd64_syscall+0x859/frame 0xfffffe083cb6eab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe083cb6eab0
--- syscall (7, FreeBSD ELF64, sys_wait4), rip = 0x42353a, rsp = 0x7fffffffe7a8, rbp = 0x7fffffffe810 ---


Further debugging seeing this on the original machine
after migrating a VPS off.

 354355 root@rabbit3:~ # ps ax^M^M
 354356  PID TT  STAT     TIME COMMAND^M
 354357 XXX-BZ proc_reap:937 p 0xfffff80008e05000^M
 354358 XXX-BZ proc_reap:939 p 0xfffff80008e05000^M
 354359 XXX-BZ reaper_abandon_children:139 proc 0xfffff80008e05000 exiting 1^M
 354360 XXX-BZ proc_reap:941 p 0xfffff80008e05000^M
 354361 panic: proc_reap:943 Bad link elm 0xfffff80008e05000 next->prev != elm^M
 354362 cpuid = 2^M
 354363 time = 1505213136^M
 354364 KDB: stack backtrace:^M
 354365 db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 0xfffffe085f69a560^M
 354366 vpanic() at vpanic+0x19c/frame 0xfffffe085f69a5e0^M
 354367 panic() at panic+0x43/frame 0xfffffe085f69a640^M
 354368 proc_reap() at proc_reap+0x712/frame 0xfffffe085f69a690^M
 354369 proc_to_reap() at proc_to_reap+0x383/frame 0xfffffe085f69a6e0^M
 354370 kern_wait6() at kern_wait6+0x2fd/frame 0xfffffe085f69a790^M
 354371 sys_wait4() at sys_wait4+0x78/frame 0xfffffe085f69a980^M

    937 printf("XXX-BZ %s:%d p %p\n", __func__, __LINE__, p);
    938         LIST_REMOVE(p, p_sibling);
    939 printf("XXX-BZ %s:%d p %p\n", __func__, __LINE__, p);
    940         reaper_abandon_children(p, true);
    941 printf("XXX-BZ %s:%d p %p\n", __func__, __LINE__, p);
    942 #if 1
    943         LIST_REMOVE(p, p_reapsibling);                          // XXX-BZ kaboom due to list corruption
    944 #endif
    945 printf("XXX-BZ %s:%d p %p\n", __func__, __LINE__, p);

Getting the panic for a process in the base system.
db> show all proc
shows an early abort running out of processes.

Seems we are exactly 1 process short on the V_allproc
list compared to V_nprocs.

So the question is where on snpashot or "teardown" do we
get this one process out of sync (corrupted) on the base system?
Will that be all problems?  Best lead for the moment to go after
these two data structures.

XXX-BZ fork1:885 V_nprocs ++46, nprocs_new 46
XXX-BZ fork1:885 V_nprocs ++47, nprocs_new 47
XXX-BZ exit1:467 ++V_nprocs_zomb --1
XXX-BZ proc_reap:938 p 0xfffff800586bb540
XXX-BZ proc_reap:940 p 0xfffff800586bb540
XXX-BZ reaper_abandon_children:139 proc 0xfffff800586bb540 exiting 1
XXX-BZ proc_reap:942 p 0xfffff800586bb540
XXX-BZ proc_reap:946 p 0xfffff800586bb540
XXX-BZ proc_reap:950 p 0xfffff800586bb540
XXX-BZ proc_reap:1029 V_nprocs --46
XXX-BZ proc_reap:1031 V_nprocs_zomb 1--
XXX-BZ exit1:467 ++V_nprocs_zomb --1
XXX-BZ proc_reap:938 p 0xfffff80058e49540
XXX-BZ proc_reap:940 p 0xfffff80058e49540
XXX-BZ reaper_abandon_children:139 proc 0xfffff80058e49540 exiting 1
XXX-BZ proc_reap:942 p 0xfffff80058e49540
XXX-BZ proc_reap:946 p 0xfffff80058e49540
XXX-BZ proc_reap:950 p 0xfffff80058e49540
XXX-BZ proc_reap:1029 V_nprocs --45
XXX-BZ proc_reap:1031 V_nprocs_zomb 1--
XXX-BZ exit1:467 ++V_nprocs_zomb --1
XXX-BZ proc_reap:938 p 0xfffff800586c0540
XXX-BZ proc_reap:940 p 0xfffff800586c0540
XXX-BZ reaper_abandon_children:139 proc 0xfffff800586c0540 exiting 1
XXX-BZ proc_reap:942 p 0xfffff800586c0540
panic: proc_reap:944 Bad link elm 0xfffff800586c0540 next->prev != elm
cpuid = 3
time = 1505218797
KDB: stack backtrace:
db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 0xfffffe085f924560
vpanic() at vpanic+0x19c/frame 0xfffffe085f9245e0
panic() at panic+0x43/frame 0xfffffe085f924640
proc_reap() at proc_reap+0x76e/frame 0xfffffe085f924690
proc_to_reap() at proc_to_reap+0x383/frame 0xfffffe085f9246e0
kern_wait6() at kern_wait6+0x2fd/frame 0xfffffe085f924790
sys_wait4() at sys_wait4+0x78/frame 0xfffffe085f924980
amd64_syscall() at amd64_syscall+0x859/frame 0xfffffe085f924ab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe085f924ab0
--- syscall (7, FreeBSD ELF64, sys_wait4), rip = 0x800e185da, rsp = 0x7fffffffe058, rbp = 0x7fffffffe130 ---
KDB: enter: panic
[ thread pid 1049 tid 100121 ]
Stopped at      kdb_enter+0x3b: movq    $0,kdb_why
db> show proc 0xfffff800586c0540
Process 1111 (sleep) at 0xfffff800586c0540:
 state: ZOMBIE
 uid: 0  gids: 0, 5
 parent: pid 1049 at 0xfffff8000d91da80
 ABI: FreeBSD ELF64
 arguments: sleep 3600
 threads: 1
100133                   Inactv                              sleep
 repear: 0xfffff80007737540
 reapsubtree: 1042
db> show proc 0xfffff80007737540
Process 1 (init) at 0xfffff80007737540:
 state: NORMAL
 uid: 0  gids: 0
 parent: pid 0 at 0xffffffff81ef1940
 ABI: FreeBSD ELF64
 arguments: /sbin/init --
 threads: 1
100002                   S       wait    0xfffff80007737540  [init]
 repear: 0xffffffff81ef1940
 reapsubtree: 1
db> show proc 1042
Process 1042 (login) at 0xfffff80007735a80:
 state: NORMAL
 uid: 0  gids: 0, 5
 parent: pid 1 at 0xfffff80007737540
 ABI: FreeBSD ELF64
 arguments: login [pam]
 threads: 1
100094                   S       wait    0xfffff80007735a80  login
 repear: 0xfffff80007737540
 reapsubtree: 1042
db> show all proc
  pid  ppid  pgrp   uid  state   wmesg   wchan               cmd
 1075     0     0     0  DL      bored   0xffffffff80dad830  [vps_console]
 1059     0     0     0  DL      pause   0xffffffff81cd4032  [vps_account]
 1049  1042  1049     0  R+      CPU 3                       csh
 1042     1  1042     0  Ss+     wait    0xfffff80007735a80  login
 1041     1  1041     0  Ss+     ttyin   0xfffff8000d09b0b0  getty
 1040     1  1040     0  Ss+     ttyin   0xfffff8000d09b4b0  getty
 1039     1  1039     0  Ss+     ttyin   0xfffff8000d09b8b0  getty
 1038     1  1038     0  Ss+     ttyin   0xfffff8000d09bcb0  getty
 1037     1  1037     0  Ss+     ttyin   0xfffff8000d09d0b0  getty
 1036     1  1036     0  Ss+     ttyin   0xfffff8000d09d4b0  getty
 1035     1  1035     0  Ss+     ttyin   0xfffff8000d09d8b0  getty
 1034     1  1034     0  Ss+     ttyin   0xfffff8000d09dcb0  getty
  991     1   991     0  Ss      nanslp  0xffffffff81cd52c1  cron
  987     1   987     0  Ss      select  0xfffff8000d01cb40  sshd
  956     1   956     0  Ss      select  0xfffff8000d01cbc0  powerd
  917     1   917     0  Ss      rpcsvc  0xfffff8000bffa8a0  NLM: master
  913     1   913     0  Ss      select  0xfffff8000d02d8c0  rpc.statd
  792     1   792     0  Ss      select  0xfffff8000d02dac0  rpcbind
  782     1   782     0  Ss      select  0xfffff8000d01d340  syslogd
  668     1   668     0  Ss      select  0xfffff8000dbeb840  devd
   34     0     0     0  SL      -       0xffffffff81ee7850  [newnfs 0]
   22     0     0     0  DL      vlruwt  0xfffff8000d0dea80  [vnlru]
   21     0     0     0  DL      syncer  0xffffffff81e6e780  [syncer]
   20     0     0     0  DL      -       0xffffffff81e6dc0c  [bufspacedaemon]
   19     0     0     0  DL      psleep  0xffffffff81e6cf04  [bufdaemon]
   18     0     0     0  DL      psleep  0xffffffff81e76d9c  [vmdaemon]
   17     0     0     0  DL      (threaded)                  [pagedaemon]
100079                   D       psleep  0xffffffff81f23f05  [pagedaemon]
100080                   D       launds  0xffffffff81e76d44  [laundry: dom0]
100082                   D       umarcl  0xffffffff81e766e8  [uma]
   16     0     0     0  DL      idle    0xfffff80007736540  [enc_daemon0]
   15     0     0     0  DL      -       0xffffffff81ba8338  [rand_harvestq]
    9     0     0     0  DL      waiting 0xffffffff81f18e70  [sctp_iterator]
    8     0     0     0  DL      -       0xffffffff81e6c774  [soaiod4]
    7     0     0     0  DL      -       0xffffffff81e6c774  [soaiod3]
    6     0     0     0  DL      -       0xffffffff81e6c774  [soaiod2]    5     0     0     0  DL      -       0xffffffff81e6c774  [soaiod1]
   14     0     0     0  DL      (threaded)                  [usb]
100055                   D       -       0xfffffe0000f32d10  [usbus0]
100056                   D       -       0xfffffe0000f32d68  [usbus0]
100057                   D       -       0xfffffe0000f32dc0  [usbus0]
100058                   D       -       0xfffffe0000f32e18  [usbus0]
100059                   D       -       0xfffffe0000f32e70  [usbus0]
100061                   D       -       0xfffffe0001018d10  [usbus1]
100062                   D       -       0xfffffe0001018d68  [usbus1]
100063                   D       -       0xfffffe0001018dc0  [usbus1]
100064                   D       -       0xfffffe0001018e18  [usbus1]
100065                   D       -       0xfffffe0001018e70  [usbus1]
    4     0     0     0  DL      (threaded)                  [cam]
100037                   D       -       0xffffffff81a7b600  [doneq0]
100077                   D       -       0xffffffff81a7b448  [scanner]
    3     0     0     0  DL      crypto_ 0xffffffff81e74af0  [crypto returns]
    2     0     0     0  DL      crypto_ 0xffffffff81e74998  [crypto]
   13     0     0     0  DL      (threaded)                  [geom]
100028                   D       -       0xffffffff81ef1900  [g_event]
100029                   D       -       0xffffffff81ef1908  [g_up]
100030                   D       -       0xffffffff81ef1910  [g_down]
   12     0     0     0  WL      (threaded)                  [intr]
100007                   I                                   [swi1: netisr 0]
100008                   I                                   [swi3: vm]
100009                   I                                   [swi4: clock (0)]
100010                   I                                   [swi4: clock (1)]
100011                   I                                   [swi4: clock (2)]
100012                   I                                   [swi4: clock (3)]
100022                   I                                   [swi5: fast taskq]
100024                   I                                   [swi6: task queue]
100025                   I                                   [swi6: Giant taskq]
100038                   I                                   [irq264: t5nex0:err]
100039                   I                                   [irq265: t5nex0:evt]
100040                   I                                   [irq266: t5nex0:0a0]
100041                   I                                   [irq267: t5nex0:0a1]
100042                   I                                   [irq268: t5nex0:0a2]
100043                   I                                   [irq269: t5nex0:0a3]
100044                   I                                   [irq270: t5nex0:0A0]
100045                   I                                   [irq271: t5nex0:0A1]
100046                   I                                   [irq272: t5nex0:1a0]
100047                   I                                   [irq273: t5nex0:1a1]
100048                   I                                   [irq274: t5nex0:1a2]
100049                   I                                   [irq275: t5nex0:1a3]
100050                   I                                   [irq276: t5nex0:1A0]
100051                   I                                   [irq277: t5nex0:1A1]
100052                   I                                   [irq278: isci0]
100053                   I                                   [irq279: isci0]
100054                   I                                   [irq16: ehci0]
100060                   I                                   [irq23: ehci1]
100066                   I                                   [irq290: ahci0]
100067                   I                                   [swi0: uart uart]
   11     0     0     0  RL      (threaded)                  [idle]
100003                   Run     CPU 0                       [idle: cpu0]
100004                   Run     CPU 1                       [idle: cpu1]
100005                   Run     CPU 2                       [idle: cpu2]
100006                   CanRun                              [idle: cpu3]
    1     0     1     0  SLs     wait    0xfffff80007737540  [init]
   10     0     0     0  DL      audit_w 0xffffffff81f19b58  [audit]
    0     0     0     0  DLs     (threaded)                  [kernel]
100000                   D       swapin  0xffffffff81ef1940  [swapper]
100013                   D       -       0xfffff8000770bd00  [softirq_0]
100014                   D       -       0xfffff8000770bb00  [softirq_1]
100015                   D       -       0xfffff8000770b900  [softirq_2]
100016                   D       -       0xfffff8000770b700  [softirq_3]
100017                   D       -       0xfffff800077a5100  [if_io_tqg_0]
100018                   D       -       0xfffff800077a4e00  [if_io_tqg_1]
100019                   D       -       0xfffff800077a4c00  [if_io_tqg_2]
100020                   D       -       0xfffff800077a4a00  [if_io_tqg_3]
100021                   D       -       0xfffff800077a4800  [if_config_tqg_0]
100023                   D       -       0xfffff800077a4400  [kqueue_ctx taskq]
100026                   D       -       0xfffff800077a3d00  [thread taskq]
100027                   D       -       0xfffff800077a3b00  [aiod_kick taskq]
100031                   D       -       0xfffff800077a3500  [firmware taskq]
100034                   D       -       0xfffff800077a2e00  [acpi_task_0]
100035                   D       -       0xfffff800077a2e00  [acpi_task_1]
100036                   D       -       0xfffff800077a2e00  [acpi_task_2]
100068                   D       -       0xfffff80008d22200  [mca taskq]
100073                   D       -       0xffffffff81cd4030  [deadlkres]
100076                   D       -       0xfffff800077a2a00  [CAM taskq]
100115                   D       -       0xfffff8000770a200  [t5nex0 tq0]
100116                   D       -       0xfffff80007709e00  [t5nex0 tq1]
100117                   D       -       0xfffff8000770a100  [t5nex0 tq2]
100118                   D       -       0xfffff8000770b400  [t5nex0 tq3]
oops, ran out of processes early!
nprocs = 45, np = 0
db> show proc 1049
Process 1049 (csh) at 0xfffff8000d91da80:
 state: NORMAL
 uid: 0  gids: 0, 5
 parent: pid 1042 at 0xfffff80007735a80
 ABI: FreeBSD ELF64
 arguments: -csh
 threads: 1
100121                   Run     CPU 3                       csh
 repear: 0xfffff80007737540
 reapsubtree: 1042



------------------------------------------

After migration the dead VPS hangs around.  Seems the interface count is still up..

root@rabbit3:~ # vpsctl list
Active VPS instaXXX-BZ proc_reap:1011 proc 0xfffff8000dcbfa80 threads 0xfffff8000dcbfa90
nces: 1
Name                 State    VFS Root                     %CPU   Virtual Size
dead_testvps         dead                                     0              0
root@rabbit3:~ # vpsctl show dead_testvps
Name:          dXXX-BZ proc_reap:1011 proc 0xfffff8000dcbfa80 threads 0xfffff8000dcbfa90
ead_testvps
Status:        dead
VFS root:
Processes:            0
Sockets:              0
Interfaces:           2
Restore count:        0

* still two interfaces;  never hit vps_destroy, need to add a panic there and trace back how we should get there next
* printfs are there not seen so trace the callgraph on how to get there

* also seeing two references left and I assume those are the two interfaces.

--------------------------------------------------------------------------------

Fatal trap 12: page fault while in kernel mode
cpuid = 4; apic id = 06
fault virtual address   = 0x28
fault code              = supervisor read data, page not present
instruction pointer     = 0x20:0xffffffff80a161e9
stack pointer           = 0x28:0xfffffe085ffba630
frame pointer           = 0x28:0xfffffe085ffba640
code segment            = base 0x0, limit 0xfffff, type 0x1b
                        = DPL 0, pres 1, long 1, def32 0, gran 1
processor eflags        = interrupt enabled, resume, IOPL = 0
current process         = 1 ()
[ thread pid 1 tid 100184 ]
Stopped at      knlist_detach+0x9:      movq    0x28(%rbx),%rdi
db> where
Tracing pid 1 tid 100184 td 0xfffff8000df85000
knlist_detach() at knlist_detach+0x9/frame 0xfffffe085ffba640
proc_reap() at proc_reap+0x2d3/frame 0xfffffe085ffba690
proc_to_reap() at proc_to_reap+0x383/frame 0xfffffe085ffba6e0
kern_wait6() at kern_wait6+0x2fd/frame 0xfffffe085ffba790
sys_wait4() at sys_wait4+0x78/frame 0xfffffe085ffba980
amd64_syscall() at amd64_syscall+0x859/frame 0xfffffe085ffbaab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe085ffbaab0
--- syscall (7, FreeBSD ELF64, sys_wait4), rip = 0x42353a, rsp = 0x7fffffffe778, rbp = 0x7fffffffe810 ---

(kgdb) l *proc_reap+0x2d3
0xffffffff80a1c7a3 is in proc_reap (/tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/kern_exit.c:950).
945                     procdesc_reap(p);
946             sx_xunlock(&V_proctree_lock);
947
948             PROC_LOCK(p);
949             knlist_detach(p->p_klist);
950             p->p_klist = NULL;
951             PROC_UNLOCK(p);
952
953             /*
954              * Removal from allproc list and process group list paired with
(kgdb) l *knlist_detach+0x9
0xffffffff80a161e9 is in knlist_detach (/tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/kern_event.c:2427).
2422
2423    void
2424    knlist_detach(struct knlist *knl)
2425    {
2426
2427            KNL_ASSERT_LOCKED(knl);
2428            knl->kl_autodestroy = 1;
2429            if (knlist_empty(knl)) {
2430                    knlist_destroy(knl);
2431                    free(knl, M_KQUEUE);

--------------------------------------------------------------------------------

Not all processes are restored on the far end it seems; well or they exit..

5782574 XXX-BZ proc_reap:942 p 0xfffff8001702d000^M
5782575 XXX-BZ proc_reap:946 p 0xfffff8001702d000^M
5782576 XXX-BZ proc_reap:950 p 0xfffff8001702d000^M
5782577 XXX-BZ proc_reap:1029 V_nprocs --46^M
5782578 XXX-BZ proc_reap:1031 V_nprocs_zomb 1--^M
5782579 XXX-BZ fork1:885 V_nprocs ++47, nprocs_new 47^M
5782580 XXX-BZ fork1:885 V_nprocs ++48, nprocs_new 48^M
5782581 vps1: bpf attached^M
5782582 XXX-BZ fork1:885 V_nprocs ++49, nprocs_new 49^M
5782583 XXX-BZ vps_restore_proc_one:3887 p 0xfffff80008d66000 pid 14^M
5782584 XXX-BZ fork1:885 V_nprocs ++50, nprocs_new 50^M
5782585 XXX-BZ vps_restore_proc_one:3887 p 0xfffff8000bfda540 pid 10^M
5782586 XXX-BZ exit1:467 V_nprocs_zomb ++1^M
5782587 XXX-BZ proc_reap:938 p 0xfffff80008d6b000^M
5782588 XXX-BZ proc_reap:940 p 0xfffff80008d6b000^M
5782589 XXX-BZ reaper_abandon_children:139 proc 0xfffff80008d6b000 exiting 1^M
5782590 XXX-BZ proc_reap:942 p 0xfffff80008d6b000^M
5782591 XXX-BZ proc_reap:946 p 0xfffff80008d6b000^M
5782592 XXX-BZ proc_reap:950 p 0xfffff80008d6b000^M
5782593 XXX-BZ vps_restore_proc_one:3887 p 0xfffff8000d1ad540 pid 2^M
5782594 XXX-BZ proc_reap:1029 V_nprocs --49^M
5782595 XXX-BZ proc_reap:1031 V_nprocs_zomb 1--^M
5782596 XXX-BZ vps_restore_proc_one:3887 p 0xfffff8000d1ad000 pid 1^M
5782597 lock order reversal:^M


This also seems to indicate that they are attached to the wrong VPS
initially as the process count (which I assume the base system)
goes up by 4 at the same time we restore the 4 processes.


--------------------------------------------------------------------------------


XXX-BZ proc_reap:946 p 0xfffff8003a1ba540
XXX-BZ proc_reap:950 p 0xfffff8003a1ba540
XXX-BZ proc_reap:1029 V_nprocs --46
XXX-BZ proc_reap:1031 V_nprocs_zomb 1--
XXX-BZ fork1:885 V_nprocs ++47, nprocs_new 47
spin lock 0xfffff80007712000 (vps accounting) held by 0xfffff8000d7d7580 (tid 100133) too long
panic: spin lock held too long
cpuid = 2
time = 1505392988
KDB: stack backtrace:
db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 0xfffffe085f68a620
vpanic() at vpanic+0x19c/frame 0xfffffe085f68a6a0
panic() at panic+0x43/frame 0xfffffe085f68a700
_mtx_lock_spin_cookie() at _mtx_lock_spin_cookie+0x328/frame 0xfffffe085f68a780
__mtx_lock_spin_flags() at __mtx_lock_spin_flags+0xe0/frame 0xfffffe085f68a7c0
_vps_account_runnable() at _vps_account_runnable+0x45/frame 0xfffffe085f68a7f0
choosethread() at choosethread+0x69/frame 0xfffffe085f68a810
sched_switch() at sched_switch+0x3d0/frame 0xfffffe085f68a870
mi_switch() at mi_switch+0x18b/frame 0xfffffe085f68a8a0
sleepq_switch() at sleepq_switch+0x10f/frame 0xfffffe085f68a8e0
sleepq_catch_signals() at sleepq_catch_signals+0x308/frame 0xfffffe085f68a950
sleepq_timedwait_sig() at sleepq_timedwait_sig+0x14/frame 0xfffffe085f68a990
_sleep() at _sleep+0x304/frame 0xfffffe085f68aa30
nfssvc_iod() at nfssvc_iod+0x109/frame 0xfffffe085f68aa70
fork_exit() at fork_exit+0x84/frame 0xfffffe085f68aab0
fork_trampoline() at fork_trampoline+0xe/frame 0xfffffe085f68aab0
--- trap 0, rip = 0, rsp = 0, rbp = 0 ---
KDB: enter: panic
[ thread pid 34 tid 100089 ]
Stopped at      kdb_enter+0x3b: movq    $0,kdb_why
db>
db>
db> show alllocks
Process 1096 (sh) thread 0xfffff8000d7d7580 (100133)
exclusive sleep mutex vm page (vm page) r = 0 (0xffffffff81f20080) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/vm/vm_page.c:1523
exclusive rw vm object (vm object) r = 0 (0xfffff8003a2ac2d0) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/vm/vm_object.c:1757
exclusive rw vm object (vm object) r = 0 (0xfffff8003a2ac000) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/vm/vm_object.c:629
Process 793 (syslogd) thread 0xfffff8000db4b000 (100117)
exclusive sleep mutex ncl_iod_mutex (ncl_iod_mutex) r = 0 (0xffffffff81eec818) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/fs/nfsclient/nfs_clbio.c:1435
exclusive lockmgr nfs (nfs) r = 0 (0xfffff8000dd79068) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/vfs_vnops.c:881
db> show reg
cs                        0x20
ds                        0x3b
es                        0x3b
fs                        0x13
gs                        0x1b
ss                        0x28
rax                       0x12
rcx                       0x80
rdx         0xfffffe085f68a510
rbx         0xffffffff8148c8a9  thread_off_td_plist+0x2b81
rsp         0xfffffe085f68a610
rbp         0xfffffe085f68a620
rsi                       0x80
rdi         0xffffffff81cd69e0  cnputs_mtx+0x18
r8          0xffffffff80aad710  putchar
r9                       0x1d0
r10         0xffffffff81bc8640  vga_conssoftc
r11                       0x10
r12         0xfffff8000d7d7501
r13         0xfffff80007712018
r14         0xfffffe085f68a6e0
r15         0xfffff8000bf5b000
rip         0xffffffff80aa736b  kdb_enter+0x3b
rflags                    0x86
kdb_enter+0x3b: movq    $0,kdb_why


--------------------------------------------------------------------------------

Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe085f97fab0
--- syscall (4, FreeBSD ELF64, sys_write), rip = 0x80158a65a, rsp = 0x7fffffffd8e8, rbp = 0x7fffffffd910 ---
vn_fullpath1_fallback: WARNING: looking up by vn_fullpath1_findparentdir(vp=0xfffff800338e7ce8, ...)
XXX-BZ vps_deref:883 vps 0xfffff80008f81800 last 0 vps_refcnt 17 ucred 0xffffffff809fd430
XXX-BZ vps_deref:883 vps 0xfffff80008f81800 last 0 vps_refcnt 17 ucred 0xffffffff809fd430
XXX-BZ vps_deref:883 vps 0xfffff80008f81800 last 0 vps_refcnt 17 ucred 0xffffffff809fd430
sched_switch() at sched_switch+0x4e0/frame 0xfffffe085f8ec900
mi_switch() at mi_switch+0x18b/frame 0xfffffe085f8ec930
thread_suspend_check() at thread_suspend_check+0x93/frame 0xfffffe085f8ec980
amd64_syscall() at amd64_syscall+0x160/frame 0xfffffe085f8ecab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe085f8ecab0
--- syscall (93, FreeBSD ELF64, sys_select), rip = 0x8015fa61a, rsp = 0x7fffffffce78, rbp = 0x7fffffffd8f0 ---


Fatal trap 12: page fault while in kernel mode
cpuid = 2; apic id = 06
fault virtual address   = 0x408
fault code              = supervisor read data, page not present
instruction pointer     = 0x20:0xffffffff80a6cd1d
stack pointer           = 0x28:0xfffffe085f984400
frame pointer           = 0x28:0xfffffe085f9844b0
code segment            = base 0x0, limit 0xfffff, type 0x1b
                        = DPL 0, pres 1, long 1, def32 0, gran 1
processor eflags        = interrupt enabled, resume, IOPL = 0
current process         = 1131 (vpsctl)
[ thread pid 1131 tid 100139 ]
Stopped at      _sx_xlock_hard+0x4ad:   movl    0x408(%r15),%eax
db> where
Tracing pid 1131 tid 100139 td 0xfffff8000dc42580
_sx_xlock_hard() at _sx_xlock_hard+0x4ad/frame 0xfffffe085f9844b0
_sx_xlock() at _sx_xlock+0xc5/frame 0xfffffe085f9844f0
sblock() at sblock+0x9d/frame 0xfffffe085f984510
vps_snapshot_socket() at vps_snapshot_socket+0x8d/frame 0xfffffe085f984580
vps_snapshot() at vps_snapshot+0x22d5/frame 0xfffffe085f984660
vps_ioc_snapshot() at vps_ioc_snapshot+0x9f/frame 0xfffffe085f984690
devfs_ioctl() at devfs_ioctl+0xc0/frame 0xfffffe085f9846e0
VOP_IOCTL_APV() at VOP_IOCTL_APV+0xe0/frame 0xfffffe085f984710
vn_ioctl() at vn_ioctl+0x124/frame 0xfffffe085f984820
devfs_ioctl_f() at devfs_ioctl_f+0x1f/frame 0xfffffe085f984840
kern_ioctl() at kern_ioctl+0x2cd/frame 0xfffffe085f9848a0
sys_ioctl() at sys_ioctl+0x16f/frame 0xfffffe085f984980
amd64_syscall() at amd64_syscall+0x859/frame 0xfffffe085f984ab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe085f984ab0
--- syscall (54, FreeBSD ELF64, sys_ioctl), rip = 0x8009bb6da, rsp = 0x7fffffffb2a8, rbp = 0x7fffffffb550 ---

db> show alllocks
Process 1131 (vpsctl) thread 0xfffff8000dc42580 (100139)
exclusive sx filedesc structure (filedesc structure) r = 0 (0xfffff8000defa040) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/modules/vps_snapst/../../vps/vps_snapst.c:2687
shared sx allproc_0xfffff80008f81800 (allproc_0xfffff80008f81800) r = 0 (0xfffffe0002bbe2a8) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/modules/vps_snapst/../../vps/vps_snapst.c:1930
exclusive sx vps instance 0xfffff80008f81800 lock (vps instance 0xfffff80008f81800 lock) r = 0 (0xfffff80008f81838) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/modules/vps_dev/../../vps/vps_user.c:431
shared sx lock of all vps instances (lock of all vps instances) r = 0 (0xffffffff81f29c60) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/modules/vps_dev/../../vps/vps_user.c:425
Process 789 (syslogd) thread 0xfffff8000dc45580 (100122)
exclusive sleep mutex vm inactive pagequeue (vm pagequeue) r = 0 (0xffffffff81f27200) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/vm/vm_page.c:2963
exclusive sleep mutex vm page (vm page) r = 0 (0xffffffff81f21500) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/vfs_bio.c:2639
exclusive rw vm object (vm object) r = 0 (0xfffff8000dc0fd20) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/vfs_bio.c:2747
exclusive lockmgr bufwait (bufwait) r = 0 (0xfffffe07c63f7a50) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/vfs_subr.c:1756
exclusive lockmgr nfs (nfs) r = 0 (0xfffff8000de3f5f0) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/vfs_vnops.c:881
db> show reg
cs                        0x20
ds                        0x3b
es                        0x3b
fs                        0x13
gs                        0x1b
ss                        0x28
rax                        0x3
rcx                          0
rdx                          0
rbx         0xfffff8000df745b0
rsp         0xfffffe085f984400
rbp         0xfffffe085f9844b0
rsi                          0
rdi         0xfffff8000df745b0
r8          0xffffffff8149d5f8  ttystates+0x2118
r9                       0x118
r10                          0
r11                        0x2
r12                          0
r13                          0
r14         0xfffff8000dc42580
r15                          0
rip         0xffffffff80a6cd1d  _sx_xlock_hard+0x4ad
rflags                 0x10246  _binary_t5fw_cfg_uwire_txt_size+0xace7
_sx_xlock_hard+0x4ad:   movl    0x408(%r15),%eax

db> ps
  pid  ppid  pgrp   uid  state   wmesg   wchan               cmd
 1132  1131  1129     0  S+      select  0xfffff8000da57d40  ssh
 1131  1129  1129     0  R+      CPU 2                       vpsctl
 1129  1060  1129     0  S+      wait    0xfffff80008e00000  sh
 1085     0     0     0  SL      select  0xfffff8000d060ec0  [vps_console]
 1070     0     0     0  DL      pause   0xffffffff81cd9031  [vps_account]
 1060  1045  1060     0  S+      pause   0xfffff8000d0e5b28  csh
 1045     1  1045     0  Ss+     wait    0xfffff8000bf50000  login
 1044     1  1044     0  Ss+     ttyin   0xfffff80007937cb0  getty
 1043     1  1043     0  Ss+     ttyin   0xfffff800079380b0  getty
 1042     1  1042     0  Ss+     ttyin   0xfffff800079384b0  getty
 1041     1  1041     0  Ss+     ttyin   0xfffff800079388b0  getty
 1040     1  1040     0  Ss+     ttyin   0xfffff80007938cb0  getty
 1039     1  1039     0  Ss+     ttyin   0xfffff800079390b0  getty
 1038     1  1038     0  Ss+     ttyin   0xfffff800079394b0  getty
 1037     1  1037     0  Ss+     ttyin   0xfffff800079398b0  getty
  994     1   994     0  Ss      nanslp  0xffffffff81cda2c1  cron
  990     1   990     0  Ss      select  0xfffff8000d07d540  sshd
  959     1   959     0  Ss      select  0xfffff80008fc90c0  powerd
  920     1   920     0  Ss      rpcsvc  0xfffff8000d06c7a0  NLM: master
  916     1   916     0  Ss      select  0xfffff80008f93b40  rpc.statd
  799     1   799     0  Ss      select  0xfffff80008f93a40  rpcbind
  789     1   789     0  Rs      CPU 0                       syslogd
  675     1   675     0  Ss      select  0xfffff8000d07d4c0  devd
   34     0     0     0  SL      -       0xffffffff81eec850  [newnfs 0]
   22     0     0     0  DL      vlruwt  0xfffff8000d0e6a80  [vnlru]
   21     0     0     0  DL      syncer  0xffffffff81e73780  [syncer]
   20     0     0     0  DL      -       0xffffffff81e72c0c  [bufspacedaemon]
   19     0     0     0  DL      psleep  0xffffffff81e71f04  [bufdaemon]
   18     0     0     0  DL      psleep  0xffffffff81e7bd9c  [vmdaemon]
   17     0     0     0  DL      (threaded)                  [pagedaemon]
100079                   D       psleep  0xffffffff81f28f05  [pagedaemon]
100085                   D       launds  0xffffffff81e7bd44  [laundry: dom0]
100086                   D       umarcl  0xffffffff81e7b6e8  [uma]
   16     0     0     0  DL      idle    0xfffff8000bf50a80  [enc_daemon0]
   15     0     0     0  DL      -       0xffffffff81bad338  [rand_harvestq]
    9     0     0     0  DL      waiting 0xffffffff81f1de70  [sctp_iterator]
    8     0     0     0  DL      -       0xffffffff81e71774  [soaiod4]
    7     0     0     0  DL      -       0xffffffff81e71774  [soaiod3]
    6     0     0     0  DL      -       0xffffffff81e71774  [soaiod2]
    5     0     0     0  DL      -       0xffffffff81e71774  [soaiod1]
   14     0     0     0  DL      (threaded)                  [usb]
100055                   D       -       0xfffffe0000f32d10  [usbus0]
100056                   D       -       0xfffffe0000f32d68  [usbus0]
100057                   D       -       0xfffffe0000f32dc0  [usbus0]
100058                   D       -       0xfffffe0000f32e18  [usbus0]
100059                   D       -       0xfffffe0000f32e70  [usbus0]
100061                   D       -       0xfffffe0001018d10  [usbus1]
100062                   D       -       0xfffffe0001018d68  [usbus1]
100063                   D       -       0xfffffe0001018dc0  [usbus1]
100064                   D       -       0xfffffe0001018e18  [usbus1]
100065                   D       -       0xfffffe0001018e70  [usbus1]
    4     0     0     0  DL      (threaded)                  [cam]
100037                   D       -       0xffffffff81a80600  [doneq0]
100077                   D       -       0xffffffff81a80448  [scanner]
    3     0     0     0  DL      crypto_ 0xffffffff81e79af0  [crypto returns]
    2     0     0     0  DL      crypto_ 0xffffffff81e79998  [crypto]
   13     0     0     0  DL      (threaded)                  [geom]
100028                   D       -       0xffffffff81ef6900  [g_event]
100029                   D       -       0xffffffff81ef6908  [g_up]
100030                   D       -       0xffffffff81ef6910  [g_down]
   12     0     0     0  WL      (threaded)                  [intr]
100007                   I                                   [swi1: netisr 0]
100008                   I                                   [swi3: vm]
100009                   I                                   [swi4: clock (0)]
100010                   I                                   [swi4: clock (1)]
100011                   I                                   [swi4: clock (2)]
100012                   I                                   [swi4: clock (3)]
100022                   I                                   [swi5: fast taskq]
100024                   I                                   [swi6: task queue]
100025                   I                                   [swi6: Giant taskq]
100038                   I                                   [irq264: t5nex0:err]
100039                   I                                   [irq265: t5nex0:evt]
100040                   I                                   [irq266: t5nex0:0a0]
100041                   I                                   [irq267: t5nex0:0a1]
100042                   I                                   [irq268: t5nex0:0a2]
100043                   I                                   [irq269: t5nex0:0a3]
100044                   I                                   [irq270: t5nex0:0A0]
100045                   I                                   [irq271: t5nex0:0A1]
100046                   I                                   [irq272: t5nex0:1a0]
100047                   I                                   [irq273: t5nex0:1a1]
100048                   I                                   [irq274: t5nex0:1a2]
100049                   I                                   [irq275: t5nex0:1a3]
100050                   I                                   [irq276: t5nex0:1A0]
100051                   I                                   [irq277: t5nex0:1A1]
100052                   I                                   [irq278: isci0]
100053                   I                                   [irq279: isci0]
100054                   I                                   [irq16: ehci0]
100060                   I                                   [irq23: ehci1]
100066                   I                                   [irq290: ahci0]
100067                   I                                   [swi0: uart uart]
   11     0     0     0  RL      (threaded)                  [idle]
100003                   CanRun                              [idle: cpu0]
100004                   Run     CPU 1                       [idle: cpu1]
100005                   CanRun                              [idle: cpu2]
100006                   Run     CPU 3                       [idle: cpu3]
    1     0     1     0  SLs     wait    0xfffff80007737540  [init]
   10     0     0     0  DL      audit_w 0xffffffff81f1eb58  [audit]
    0     0     0     0  DLs     (threaded)                  [kernel]
100000                   D       swapin  0xffffffff81ef6940  [swapper]
100013                   D       -       0xfffff8000770bd00  [softirq_0]
100014                   D       -       0xfffff8000770bb00  [softirq_1]
100015                   D       -       0xfffff8000770b900  [softirq_2]
100016                   D       -       0xfffff8000770b700  [softirq_3]
100017                   D       -       0xfffff8000770b500  [if_io_tqg_0]
100018                   D       -       0xfffff8000770b300  [if_io_tqg_1]
100019                   D       -       0xfffff8000770b100  [if_io_tqg_2]
100020                   D       -       0xfffff8000770ae00  [if_io_tqg_3]
100021                   D       -       0xfffff800077a7100  [if_config_tqg_0]
100023                   D       -       0xfffff800077a6c00  [kqueue_ctx taskq]
100026                   D       -       0xfffff800077a6600  [thread taskq]
100027                   D       -       0xfffff800077a6400  [aiod_kick taskq]
100031                   D       -       0xfffff800077a5d00  [firmware taskq]
100034                   D       -       0xfffff800077a5700  [acpi_task_0]
100035                   D       -       0xfffff800077a5700  [acpi_task_1]
100036                   D       -       0xfffff800077a5700  [acpi_task_2]
100068                   D       -       0xfffff80008d16200  [mca taskq]
100073                   D       -       0xffffffff81cd9033  [deadlkres]
100076                   D       -       0xfffff800077a5300  [CAM taskq]
100101                   D       -       0xfffff80008d15a00  [t5nex0 tq0]
100102                   D       -       0xfffff80008d15500  [t5nex0 tq1]
100103                   D       -       0xfffff80008d15900  [t5nex0 tq2]
100104                   D       -       0xfffff800077a4200  [t5nex0 tq3]
nprocs = 47, np = -1


--------------------------------------------------------------------------------

vpsctl shell   gives a weird process number for the csh that enters
which probably can conflict;  that is a process moving between the
vps systems (and possibly the reason for proc list corruption).

--------------------------------------------------------------------------------

Another panic on restore;  looks like inappropriate error handling.

vps_restore_iface_ifaddr: ifa: have_addr=1 have_dstaddr=1 have_netmask=1
vps_restore_iface_ifaddr: AF_INET: if_name=[lo0] addr=[0100007f] dst=[0100007f] mask=[000000ff]
vps_restore_iface_ifaddr: in_control() error = 22
vps_restore_iface_ifaddr: in_control() error = 22

vps_restore: va->msgbase=0x8007f3980 va->msglen=65536
vps_restore: error = 22
vps_restore: total time: 0 seconds


Fatal trap 12: page fault while in kernel mode
cpuid = 7; apic id = 09
fault virtual address   = 0x30
XXX-BZ exit1:467 V_nprocs_zomb ++1
fault code              = supervisor read data, page not present
instruction pointer     = 0x20:0xffffffff8263c527
stack pointer           = 0x28:0xfffffe0860312a00
frame pointer           = 0x28:0xfffffe0860312a60
code segment            = base 0x0, limit 0xfffff, type 0x1b
XXX-BZ reaper_abandon_children:139 proc 0xfffff8001313e540 exiting 1
XXX-BZ proc_reap:940 p 0xfffff8001313e540
XXX-BZ proc_reap:944 p 0xfffff8001313e540
XXX-BZ proc_reap:1026 V_nprocs --46
XXX-BZ proc_reap:1028 V_nprocs_zomb 1--
                        = DPL 0, pres 1, long 1, def32 0, gran 1
processor eflags        = interrupt enabled, resume, IOPL = 0
current process         = 1046 (vps_account)
[ thread pid 1046 tid 100173 ]
Stopped at      vps_account_threads+0x1c7:      movq    0x30(%rax),%rdi
db> where
Tracing pid 1046 tid 100173 td 0xfffff8006817f000
vps_account_threads() at vps_account_threads+0x1c7/frame 0xfffffe0860312a60
vps_account_kproc() at vps_account_kproc+0x15/frame 0xfffffe0860312a70
fork_exit() at fork_exit+0x84/frame 0xfffffe0860312ab0
fork_trampoline() at fork_trampoline+0xe/frame 0xfffffe0860312ab0
--- trap 0, rip = 0, rsp = 0, rbp = 0 ---
db>

--------------------------------------------------------------------------------

vps1: bpf attached
vps_restore_iface_ifaddr: AF_LINK: ignoring
vps_restore_vnet_route: fibnum=0 af=2
vps_restore_vnet_route_one: rt_have_mask=0 rt_have_gateway=1 rt_have_ifa=1
XXX-BZ fork1:885 V_nprocs ++46, nprocs_new 46
vps_restore_vnet_route: fibnum=0 af=28
vps_restore_vnet_route_one: rt_have_mask=1 rt_have_gateway=1 rt_have_ifa=1
vps_restore_vnet_route_one: rtrequest_fib: error=51
vps_restore_vnet_route_one: rtrequest_fib: error=51

vps_restore: va->msgbase=0x800672980 va->msglen=65536
vps_restore: error = 51
vps_restore: total time: 0 seconds


Fatal trap 12: page fault while in kernel mode
cpuid = 0; apic id = 02
fault virtual address   = 0x30
fault code              = supervisor read data, page not present
instruction pointer     = 0x20:0xffffffff8263c527
stack pointer           = 0x28:0xfffffe085ff02a00
frame pointer           = 0x28:0xfffffe085ff02a60
code segment            = base 0x0, limit 0xfffff, type 0x1b
                        = DPL 0, pres 1, long 1, def32 0, gran 1
processor eflags        = interrupt enabled, resume, IOPL = 0
current process         = 1005 (vps_account)
[ thread pid 1005 tid 100085 ]
Stopped at      vps_account_threads+0x1c7:      movq    0x30(%rax),%rdi
db> where
Tracing pid 1005 tid 100085 td 0xfffff80034b1b000
vps_account_threads() at vps_account_threads+0x1c7/frame 0xfffffe085ff02a60
vps_account_kproc() at vps_account_kproc+0x15/frame 0xfffffe085ff02a70
fork_exit() at fork_exit+0x84/frame 0xfffffe085ff02ab0
fork_trampoline() at fork_trampoline+0xe/frame 0xfffffe085ff02ab0
--- trap 0, rip = 0, rsp = 0, rbp = 0 ---
db> show reg
cs                        0x20
ds                        0x3b
es                        0x3b
fs                        0x13
gs                        0x1b
ss                        0x28
rax                          0
rcx                      0x234
rdx                        0x2
rbx         0xfffff80008ddf000
rsp         0xfffffe085ff02a00
rbp         0xfffffe085ff02a60
rsi                          0
rdi                          0
r8          0xfffff80034b1b000
r9          0xffffffff81ef7548  vmspace0+0x130
r10                 0x7ffc135a
r11                          0
r12                          0
r13         0xfffff80034ceca80
r14         0xfffffe085ff02ac0
r15                          0
rip         0xffffffff8263c527  vps_account_threads+0x1c7
rflags                 0x10286  _binary_t5fw_cfg_uwire_txt_size+0xad27
vps_account_threads+0x1c7:      movq    0x30(%rax),%rdi

--------------------------------------------------------------------------------

vps_restore_ucred_lookup: found ucred 0xfffff80034998b00 for 0xfffff80034bd9e00, ncr->ref=60                                                                                       [32/1815]
vps_restore_vmobject: proc 0xfffff80034e92540 vdvmp=0xfffffe085dba1350 count=1 vdvmpr=0xfffffe085dba1358
vps_restore_vmobject: proc 0xfffff80034e92540 found backing object 0xfffff80034e50d20 for object 0xfffff80034e50c30
vps_restore_vmobject: proc 0xfffff80034e92540 object=0xfffff80034e50c30 put in list of vm objects, orig_ptr=0xfffff80034fa32d0
vps_restore_vmobject: proc 0xfffff80034e92540 old obj=0xfffffe085dba1398: size=32 flags=3000 type=00 cred=0xfffff80034bd9e00 origptr=0xfffff80034fa2690
vps_restore_ucred_lookup: found ucred 0xfffff80034998b00 for 0xfffff80034bd9e00, ncr->ref=61
vps_restore_vmobject: proc 0xfffff80034e92540 vdvmp=0xfffffe085dba1400 count=2 vdvmpr=0xfffffe085dba1408
vps_restore_vmobject: proc 0xfffff80034e92540 found backing object 0xfffff80034e50c30 for object 0xfffff80034eb7000
vps_restore_vmobject: proc 0xfffff80034e92540 object=0xfffff80034eb7000 put in list of vm objects, orig_ptr=0xfffff80034fa2690
vps_restore_vmspace: proc 0xfffff80034e92540 entry (00007ffffffdf000-00007ffffffff000, size=0000000000020000, prot=03, max_prot=07, object=0xfffff80034fa2690, offset=0000000000000000) efla
gs=00001004; nvo=0xfffff80034eb7000
vps_restore_vmspace: proc 0xfffff80034e92540 vm_map_entry=0xfffffe085dba1458: start=0x7ffffffff000 end=0x800000000000 orig_objXXX-BZ exit1:467 V_nprocs_zomb ++1
=0xfffff8000773da50
vps_restore_vmspace: proc 0xfffff80034e92540 ncr=0
vps_restore_vmobject: proc 0xfffff80034e92540 old obj=0xfffffe085dba14b8: size=1 flags=0006 type=04 cred=0 origptr=0xfffff8000773da50
vps_restore_vmobject: proc 0xfffff80034e92540 shared_page_obj
vps_restore_vmobject: proc 0xfffff80034e92540 object=0xfffff8000775da50 put in list of vm objects, orig_ptr=0xfffff8000773da50XXX-BZ reaper_abandon_children:139 proc 0xfffff80034e91540 exi
ting 1
XXX-BZ proc_reap:940 p 0xfffff80034e91540
XXX-BZ proc_reap:944 p 0xfffff80034e91540
XXX-BZ proc_reap:1026 V_nprocs --48
XXX-BZ proc_reap:1028 V_nprocs_zomb 1--
XXX-BZ exit1:467 V_nprocs_zomb ++1

vps_restore_vmspace: proc 0xfffff80034e92540 entry (00007ffffffff000-0000800000000000, size=0000000000001000, prot=05, max_prot=05, object=0xfffff8000773da50, offset=0000000000000000) efla
gs=00000000; nvo=0xfffff8000775da50
vps_restore_vmspace: proc 0xfffff80034e92540 restored vmspace orig=0xfffff80034ee3000 new=0xfffff80034a12000
XXX-BZ vps_restore_proc_one:3749 vps0 0xfffff800071ae800 vps 0xfffff80008df4800 ctd->td_vps 0xfffff80008df4800 cred_vps 0xffffXXX-BZ reaper_abandon_children:139 proc 0xfffff80034e92000 exi
ting 1
XXX-BZ proc_reap:940 p 0xfffff80034e92000
XXX-BZ proc_reap:944 p 0xfffff80034e92000
XXX-BZ proc_reap:1026 V_nprocs --47
XXX-BZ proc_reap:1028 V_nprocs_zomb 1--
f80008df4800 ctx 0xfffff8000772c000 nproc 0xfffff80034e92540
vps_restore_thread: old thread: tid=100107
vps_restore_thread: created thread=0xfffff8003490f580 tid=100098
vps_restore_fdset: fdset has 20 entries
vps_restore_file: index= origidx= origptr=0xfffff800343b21e0 type=3 flag=00000003 offset=0
vps_restore_ucred_lookup: found ucred 0xfffff80034998b00 for 0xfffff80034bd9e00, ncr->ref=63
vps_restore_pipe: vdp: pi_have_dumped_pipe=1 pi_localend=0xfffff800343edbe0 pi_pair=0xfffff800343edbe0 pi_rpipe=0xfffff800343edbe0 pi_wpipe=0xfffff800343edd48


Fatal trap 12: page fault while in kernel mode
cpuid = 0; apic id = 02
fault virtual address   = 0x0
fault code              = supervisor read data, page not present
instruction pointer     = 0x20:0xffffffff80aa0837
stack pointer           = 0x28:0xfffffe085fde3c10
frame pointer           = 0x28:0xfffffe085fde3c30
code segment            = base 0x0, limit 0xfffff, type 0x1b
                        = DPL 0, pres 1, long 1, def32 0, gran 1
processor eflags        = interrupt enabled, resume, IOPL = 0
current process         = 1096 (vpsctl)
[ thread pid 1096 tid 100071 ]
Stopped at      cap_rights_contains+0x27:       movq    (%r14),%rax
db> where
Tracing pid 1096 tid 100071 td 0xfffff800340d4000
cap_rights_contains() at cap_rights_contains+0x27/frame 0xfffffe085fde3c30
cap_check() at cap_check+0x15/frame 0xfffffe085fde3c60
fget_unlocked() at fget_unlocked+0x15e/frame 0xfffffe085fde3cd0
_fget() at _fget+0x35/frame 0xfffffe085fde3d10
vps_restore_file() at vps_restore_file+0x777/frame 0xfffffe085fde3dd0
vps_restore_proc() at vps_restore_proc+0xdae/frame 0xfffffe085fde40b0
vps_restore() at vps_restore+0x1d52/frame 0xfffffe085fde4660
vps_ioc_restore() at vps_ioc_restore+0x73/frame 0xfffffe085fde4690
devfs_ioctl() at devfs_ioctl+0xc0/frame 0xfffffe085fde46e0
VOP_IOCTL_APV() at VOP_IOCTL_APV+0xe0/frame 0xfffffe085fde4710
vn_ioctl() at vn_ioctl+0x124/frame 0xfffffe085fde4820
devfs_ioctl_f() at devfs_ioctl_f+0x1f/frame 0xfffffe085fde4840
kern_ioctl() at kern_ioctl+0x2cd/frame 0xfffffe085fde48a0
sys_ioctl() at sys_ioctl+0x16f/frame 0xfffffe085fde4980
amd64_syscall() at amd64_syscall+0x859/frame 0xfffffe085fde4ab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe085fde4ab0
--- syscall (54, FreeBSD ELF64, sys_ioctl), rip = 0x8009bb6da, rsp = 0x7fffffffcec8, rbp = 0x7fffffffead0 ---
db>
db> show reg
cs                        0x20
ds                        0x3b
es                        0x3b
fs                        0x13
gs                        0x1b
ss                        0x28
rax                          0
rcx          0x20007ffffffffff
rdx                          0
rbx         0x3fffffffffffffff
rsp         0xfffffe085fde3c10
rbp         0xfffffe085fde3c30
rsi                          0
rdi         0xfffffe085fde3c78
r8                           0
r9                           0
r10                          0
r11                          0
r12         0xfffff80034e1b148
r13         0xfffff80034e1b174
r14                          0
r15         0xfffffe085fde3c78
rip         0xffffffff80aa0837  cap_rights_contains+0x27
rflags                 0x10246  _binary_t5fw_cfg_uwire_txt_size+0xace7
cap_rights_contains+0x27:       movq    (%r14),%rax

--------------------------------------------------------------------------------

Freed UMA keg (rtentry) was not empty (16 items).  Lost 1 pages of memory.

Why do we see this on the restore machine?

keg_dtor() at keg_dtor+0x35/frame 0xfffffe085ff38f20
zone_dtor() at zone_dtor+0x50c/frame 0xfffffe085ff38f80
uma_zdestroy() at uma_zdestroy+0x53/frame 0xfffffe085ff38fa0
vnet_route_uninit() at vnet_route_uninit+0x12e/frame 0xfffffe085ff38fd0
vps_restore_vnet() at vps_restore_vnet+0x9af/frame 0xfffffe085ff390b0
vps_restore() at vps_restore+0x15af/frame 0xfffffe085ff39660
vps_ioc_restore() at vps_ioc_restore+0x73/frame 0xfffffe085ff39690
devfs_ioctl() at devfs_ioctl+0xc0/frame 0xfffffe085ff396e0

--------------------------------------------------------------------------------



XXX-BZ vps_restore_proc_one:3745 vps0 0xfffff800071ae800 vps 0xfffff80008ddf000 ctd->td_vps 0xfffff80008ddf000 cred_vps 0xfffff80008ddf000 ctx 0xfffff8000772c000 nproc 0xfffff80034e78000
vps_restore_vmspace: proc 0xfffff80034e78000 map=0xfffff80034a03000
vps_restore_vmspace: proc 0xfffff80034e78000 vm_map_entry=0xfffffe085db9e488: start=0x400000 end=0x428000 orig_obj=0xfffff80034f5b690
vps_restore_vmspace: proc 0xfffff80034e78000 ncr=0
vps_restore_vmobject: proc 0xfffff80034e78000 old obj=0xfffffe085db9e4e8: size=47 flags=1000 type=02 cred=0 origptr=0xfffff80034f5b690
vps_restore_vmobject: proc 0xfffff80034e78000 path [/sbin/ifconfig] got vnode 0xfffff80034e75000 v_object 0xfffff80034dc95a0
vps_restore_vmobject: proc 0xfffff80034e78000 object=0xfffff80034dc95a0 put in list of vm objects, orig_ptr=0xfffff80034f5b690
vps_restore_vmspace: proc 0xfffff80034e78000 entry (0000000000400000-0000000000428000, size=0000000000028000, prot=05, max_prot=07, object=0xfffff80034f5b690, offset=0000000000000000) eflags=0000040c; nvo=0xfffff80034dc95a0
vps_restore_vmspace: proc 0xfffff80034e78000 vm_map_entry=0xfffffe085db9e598: start=0x627000 end=0x62e000 orig_obj=0xfffff80034f92690
vps_restore_vmspace: proc 0xfffff80034e78000 ncr=0
vps_restore_vmobject: proc 0xfffff80034e78000 old obj=0xfffffe085db9e5f8: size=7 flags=3000 type=00 cred=0xfffff80034ccf500 origptr=0xfffff80034f92690
vps_restore_vmobject: proc 0xfffff80034e78000 vdvmp=0xfffffe085db9e660 count=1 vdvmpr=0xfffffe085db9e668
vps_restore_vmobject: proc 0xfffff80034e78000 found backing object 0xfffff80034dc95a0 for object 0xfffff800348a05a0
vps_restore_vmobject: proc 0xfffff80034e78000 object=0xfffff800348a05a0 put in list of vm objects, orig_ptr=0xfffff80034f92690
vps_restore_vmspace: proc 0xfffff80034e78000 entry (0000000000627000-000000000062e000, size=0000000000007000, prot=03, max_prot=07, object=0xfffff80034f92690, offset=0000000000000000) eflags=00000004; nvo=0xfffff800348a05a0
vps_restore_vmspace: proc 0xfffff80034e78000 vm_map_entry=0xfffffe085db9e6a8: start=0x62e000 end=0x631000 orig_obj=0xfffff80034f5e870
vps_restore_vmspace: proc 0xfffff80034e78000 ncr=0
vps_restore_vmobject: proc 0xfffff80034e78000 old obj=0xfffffe085db9e708: size=3 flags=3000 type=00 cred=0xfffff80034ccf500 origptr=0xfffff80034f5e870
vps_restore_vmobject: proc 0xfffff80034e78000 vdvmp=0xfffffe085db9e770 count=1 vdvmpr=0xfffffe085db9e778
vps_restore_vmobject: proc 0xfffff80034e78000 object=0xfffff80034dc92d0 put in list of vm objects, orig_ptr=0xfffff80034f5e870
vps_restore_vmspace: proc 0xfffff80034e78000 entry (000000000062e000-0000000000631000, size=0000000000003000, prot=03, max_prot=07, object=0xfffff80034f5e870, offset=0000000000000000) eflags=00000000; nvo=0xfffff80034dc92d0
vps_restore_vmspace: proc 0xfffff80034e78000 vm_map_entry=0xfffffe085db9e7b8: start=0x800627000 end=0x800649000 orig_obj=0xfffff80034dda690
vps_restore_vmspace: proc 0xfffff80034e78000 ncr=0
vps_restore_vmobject: proc 0xfffff80034e78000 old obj=0xfffffe085db9e818: size=36 flags=1000 type=02 cred=0 origptr=0xfffff80034dda690
vps_restore_vmobject: proc 0xfffff80034e78000 path [/libexec/ld-elf.so.1] got vnode 0xfffff80034e74b10 v_object 0xfffff80034e60000
vps_restore_vmobject: proc 0xfffff80034e78000 object=0xfffff80034e60000 put in list of vm objects, orig_ptr=0xfffff80034dda690
vps_restore_vmspace: proc 0xfffff80034e78000 entry (0000000800627000-0000000800649000, size=0000000000022000, prot=05, max_prot=07, object=0xfffff80034dda690, offset=0000000000000000) eflags=0000040c; nvo=0xfffff80034e60000
vps_restore_vmspace: proc 0xfffff80034e78000 vm_map_entry=0xfffffe085db9e8d0: start=0x800649000 end=0x800651000 orig_obj=0xfffff80034f91b40
vps_restore_vmspace: proc 0xfffff80034e78000 ncr=0
vps_restore_vmobject: proc 0xfffff80034e78000 old obj=0xfffffe085db9e930: size=8 flags=3000 type=00 cred=0xfffff80034ccf500 origptr=0xfffff80034f91b40
vps_restore_vmobject: proc 0xfffff80034e78000 vdvmp=0xfffffe085db9e998 count=5 vdvmpr=0xfffffe085db9e9a0
vps_restore_vmobject: proc 0xfffff80034e78000 object=0xfffff800345e5870 put in list of vm objects, orig_ptr=0xfffff80034f91b40
vps_restore_vmspace: proc 0xfffff80034e78000 entry (0000000800649000-0000000800651000, size=0000000000008000, prot=03, max_prot=07, object=0xfffff80034f91b40, offset=0000000000000000) eflags=00000000; nvo=0xfffff800345e5870
vps_restore_vmspace: proc 0xfffff80034e78000 vm_map_entry=0xfffffe085db9ea20: start=0x800849000 end=0x80084b000 orig_obj=0xfffff80034f930f0
vps_restore_vmspace: proc 0xfffff80034e78000 ncr=0
vps_restore_vmobject: proc 0xfffff80034e78000 old obj=0xfffffe085db9ea80: size=2 flags=3000 type=00 cred=0xfffff80034ccf500 origptr=0xfffff80034f930f0
vps_restore_vmobject: proc 0xfffff80034e78000 vdvmp=0xfffffe085db9eae8 count=2 vdvmpr=0xfffffe085db9eaf0
vps_restore_vmobject: proc 0xfffff80034e78000 object=0xfffff80034870780 put in list of vm objects, orig_ptr=0xfffff80034f930f0
vps_restore_vmspace: proc 0xfffff80034e78000 entry (0000000800849000-000000080084b000, size=0000000000002000, prot=03, max_prot=07, object=0xfffff80034f930f0, offset=0000000000000000) eflags=00000000; nvo=0xfffff80034870780
vps_restore_vmspace: proc 0xfffff80034e78000 vm_map_entry=0xfffffe085db9eb40: start=0x7fffdffff000 end=0x7ffffffdf000 orig_obj=0
vps_restore_vmspace: proc 0xfffff80034e78000 no object
vps_restore_vmspace: proc 0xfffff80034e78000 ncr=0
vps_restore_vmspace: proc 0xfffff80034e78000 entry (00007fffdffff000-00007ffffffdf000, size=000000001ffe0000, prot=00, max_pro
XXX-BZ fork1:885 V_nprocs ++48, nprocs_new 48
vps_restore_vmspace: proc 0xfffff80034e78000 vm_map_entry=0xfffffe085db9eba0: start=0x7ffffffdf000 end=0x7ffffffff000 orig_obj=0xfffff80034f91d20
vps_restore_vmspace: proc 0xfffff80034e78000 ncr=0
vps_restore_vmobject: proc 0xfffff80034e78000 old obj=0xfffffe085db9ec00: size=32 flags=3000 type=00 cred=0xfffff80034ccf500 origptr=0xfffff80034f91d20
vps_restore_vmobject: proc 0xfffff80034e78000 vdvmp=0xfffffe085db9ec68 count=3 vdvmpr=0xfffffe085db9ec70
vps_restore_vmobject: proc 0xfffff80034e78000 object=0xfffff80034ea9e10 put in list of vm objects, orig_ptr=0xfffff80034f91d20
vps_restore_vmspace: proc 0xfffff80034e78000 entry (00007ffffffdf000-00007ffffffff000, size=0000000000020000, prot=03, max_prot=07, object=0xfffff80034f91d20, offset=0000000000000000) eflags=00001000; nvo=0xfffff80034ea9e10
vps_restore_vmspace: proc 0xfffff80034e78000 vm_map_entry=0xfffffe085db9ecd0: start=0x7ffffffff000 end=0x800000000000 orig_obj=0xfffff8000773da50
vps_restore_vmspace: proc 0xfffff80034e78000 ncr=0
vps_restore_vmobject: proc 0xfffff80034e78000 old obj=0xfffffe085db9ed30: size=1 flags=0006 type=04 cred=0 origptr=0xfffff8000773da50
vps_restore_vmobject: proc 0xfffff80034e78000 shared_page_obj
vps_restore_vmobject: proc 0xfffff80034e78000 object=0xfffff8000775da50 put in list of vm objects, orig_ptr=0xfffff8000773da50
vps_restore_vmspace: proc 0xfffff80034e78000 entry (00007ffffffff000-0000800000000000, size=0000000000001000, prot=05, max_prot=05, object=0xfffff8000773da50, offset=0000000000000000) eflags=00000000; nvo=0xfffff8000775da50
vps_restore_vmspace: proc 0xfffff80034e78000 restored vmspace orig=0xfffff80034f3f000 new=0xfffff80034a03000
XXX-BZ vps_restore_proc_one:3750 vps0 0xfffff800071ae800 vps 0xfffff80008ddf000 ctd->td_vps 0xfffff80008ddf000 cred_vps 0xfffff80008ddf000 ctx 0xfffff8000772c000 nproc 0xfffff80034e78000
XXX-BZ vps_restore_proc_one:3894 vps0 0xfffff800071ae800 vps 0xfffff80008ddf000 ctd->td_vps 0xfffff80008ddf000 cred_vps 0xfffff80008ddf000 ctx 0xfffff8000772c000 p 0xfffff80034e78000 pid 164
vps_restore_proc: fixed up proc=0xfffff80034e78000/164 p->p_pgrp=0xfffff8000793e900 p->p_session=0xfffff800071b2200 p->p_pptr=0xfffff80034e77540 p->p_stype=00000000
trap_pfault: proc=0xfffff80034e78000/164 map=0xfffff80034a03000 eva=0000000000000000 prot=4 rv=1

db> show proc 0xfffff80034e78000
Process 164 (ifconfig) at 0xfffff80034e78000:
 state: NORMAL
 uid: 0  gids: 0, 5
 parent: pid 126 at 0xfffff80034e77540
 ABI: FreeBSD ELF64
 arguments: /sbin/ifconfig lo0 inet 127.0.0.1/8 alias
 threads: 1
100100                   Run     CPU 0                       ifconfig
 repear: 0xfffff80034490a80
 reapsubtree: 1037

--------------------------------------------------------------------------------

Call fpuexit(..) before saving the snapshot.

--------------------------------------------------------------------------------

vps_snapshot_vnodepath: vnode=0xfffff80034dc5b10 path=[/dev/null] error=0
vps_snapshot_fdset: idx=1 fp=0xfffff800343b2280
vps_snapshot_fdset: file=0xfffff800343b2280 flags=00000002 offset=0
vps_snapshot_ucred: cr=0xfffff80034c64800
vps_snapshot_vnodepath: vnode=0xfffff80034dc5b10 path=[/dev/null] error=0
vps_snapshot_fdset: idx=2 fp=0xfffff800343b2280
vps_snapshot_fdset: fp 0xfffff800343b2280 already dumped
vps_snapshot_fdset: idx=3 fp=0xfffff800343b20f0
vps_snapshot_fdset: file=0xfffff800343b20f0 flags=00000003 offset=0
vps_snapshot_ucred: cr=0xfffff80034c64800


Fatal trap 12: page fault while in kernel mode
cpuid = 0; apic id = 02
fault virtual address   = 0x408
fault code              = supervisor read data, page not present
instruction pointer     = 0x20:0xffffffff80a6cc5d
stack pointer           = 0x28:0xfffffe085f7333f0
frame pointer           = 0x28:0xfffffe085f7334a0
code segment            = base 0x0, limit 0xfffff, type 0x1b
                        = DPL 0, pres 1, long 1, def32 0, gran 1
processor eflags        = interrupt enabled, resume, IOPL = 0
current process         = 1091 (vpsctl)
[ thread pid 1091 tid 100094 ]
Stopped at      _sx_xlock_hard+0x4ad:   movl    0x408(%r15),%eax
db> where
Tracing pid 1091 tid 100094 td 0xfffff80034cdd580
_sx_xlock_hard() at _sx_xlock_hard+0x4ad/frame 0xfffffe085f7334a0
_sx_xlock() at _sx_xlock+0xc5/frame 0xfffffe085f7334e0
sblock() at sblock+0x9d/frame 0xfffffe085f733500
vps_snapshot_socket() at vps_snapshot_socket+0x23d/frame 0xfffffe085f733570
vps_snapshot() at vps_snapshot+0x2793/frame 0xfffffe085f733660
vps_ioc_snapshot() at vps_ioc_snapshot+0x9f/frame 0xfffffe085f733690
devfs_ioctl() at devfs_ioctl+0xc0/frame 0xfffffe085f7336e0
VOP_IOCTL_APV() at VOP_IOCTL_APV+0xe0/frame 0xfffffe085f733710
vn_ioctl() at vn_ioctl+0x124/frame 0xfffffe085f733820
devfs_ioctl_f() at devfs_ioctl_f+0x1f/frame 0xfffffe085f733840
kern_ioctl() at kern_ioctl+0x2cd/frame 0xfffffe085f7338a0
sys_ioctl() at sys_ioctl+0x16f/frame 0xfffffe085f733980
amd64_syscall() at amd64_syscall+0x859/frame 0xfffffe085f733ab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe085f733ab0
--- syscall (54, FreeBSD ELF64, sys_ioctl), rip = 0x8009bb6da, rsp = 0x7fffffffb2a8, rbp = 0x7fffffffb550 ---
db> show reg
cs                        0x20
ds                        0x3b
es                        0x3b
fs                        0x13
gs                        0x1b
ss                        0x28
rax                        0x3
rcx                          0
rdx                          0
rbx         0xfffff80034bf6908
rsp         0xfffffe085f7333f0
rbp         0xfffffe085f7334a0
rsi                          0
rdi         0xfffff80034bf6908
r8          0xffffffff8149d9d8  ttystates+0x2118
r9                       0x118
r10                        0x1
r11                       0x1e
r12                          0
r13                          0
r14         0xfffff80034cdd580
r15                          0
rip         0xffffffff80a6cc5d  _sx_xlock_hard+0x4ad
rflags                 0x10246  _binary_t5fw_cfg_uwire_txt_size+0xace7
_sx_xlock_hard+0x4ad:   movl    0x408(%r15),%eax
db> show alllocks
Process 1091 (vpsctl) thread 0xfffff80034cdd580 (100094)
exclusive sx filedesc structure (filedesc structure) r = 0 (0xfffff80034f4f8e0) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/modules/vps_snapst/../../vps/vps_snapst.c:2698
shared sx allproc_0xfffff80008ddf000 (allproc_0xfffff80008ddf000) r = 0 (0xfffffe0002eb42a8) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/modules/vps_snapst/../../vps/vps_snapst.c:1941
exclusive sx vps instance 0xfffff80008ddf000 lock (vps instance 0xfffff80008ddf000 lock) r = 0 (0xfffff80008ddf038) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/modules/vps_dev/../../vps/vps_user.c:431
shared sx lock of all vps instances (lock of all vps instances) r = 0 (0xffffffff81f29d60) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/modules/vps_dev/../../vps/vps_user.c:425
Process 782 (syslogd) thread 0xfffff8003445d580 (100076)
exclusive lockmgr nfs (nfs) r = 0 (0xfffff800344e2240) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/vfs_vnops.c:881
db> show proc 1091
Process 1091 (vpsctl) at 0xfffff80034e10a80:
 state: NORMAL
 uid: 0  gids: 0, 5
 parent: pid 1089 at 0xfffff800340c1540
 ABI: FreeBSD ELF64
 arguments: vpsctl migrate testvps 192.0.2.4 norsync noconfsync
 threads: 1
100094                   Run     CPU 0                       vpsctl
 repear: 0xfffff80007737540
 reapsubtree: 1037


(kgdb) l *_sx_xlock_hard+0x4ad
0xffffffff80a6cc5d is in _sx_xlock_hard (/tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/kern_sx.c:577).
572                      * running or the state of the lock changes.
573                      */
574                     if ((sx->lock_object.lo_flags & SX_NOADAPTIVE) == 0) {
575                             if ((x & SX_LOCK_SHARED) == 0) {
576                                     owner = lv_sx_owner(x);
577                                     if (TD_IS_RUNNING(owner)) {
578                                             if (LOCK_LOG_TEST(&sx->lock_object, 0))
579                                                     CTR3(KTR_LOCK,
580                                                 "%s: spinning on %p held by %p",
581                                                         __func__, sx, owner);
(kgdb) p (*(struct thread *)0)->td_state
Cannot access memory at address 0x408

--------------------------------------------------------------------------------

During snapshot:


Fatal trap 12: page fault while in kernel mode
cpuid = 0; apic id = 02
fault virtual address   = 0x408
fault code              = supervisor read data, page not present
instruction pointer     = 0x20:0xffffffff80a6cc4d
stack pointer           = 0x28:0xfffffe085f4a43f0
frame pointer           = 0x28:0xfffffe085f4a44a0
code segment            = base 0x0, limit 0xfffff, type 0x1b
                        = DPL 0, pres 1, long 1, def32 0, gran 1
processor eflags        = interrupt enabled, resume, IOPL = 0
current process         = 49911 (vpsctl)
[ thread pid 49911 tid 100263 ]
Stopped at      _sx_xlock_hard+0x4ad:   movl    0x408(%r15),%eax
db> where
Tracing pid 49911 tid 100263 td 0xfffff8077674c000
_sx_xlock_hard() at _sx_xlock_hard+0x4ad/frame 0xfffffe085f4a44a0
_sx_xlock() at _sx_xlock+0xc5/frame 0xfffffe085f4a44e0
sblock() at sblock+0x9d/frame 0xfffffe085f4a4500
vps_snapshot_socket() at vps_snapshot_socket+0x23d/frame 0xfffffe085f4a4570
vps_snapshot() at vps_snapshot+0x27e2/frame 0xfffffe085f4a4660
vps_ioc_snapshot() at vps_ioc_snapshot+0x9f/frame 0xfffffe085f4a4690
devfs_ioctl() at devfs_ioctl+0xc0/frame 0xfffffe085f4a46e0
VOP_IOCTL_APV() at VOP_IOCTL_APV+0xe0/frame 0xfffffe085f4a4710
vn_ioctl() at vn_ioctl+0x124/frame 0xfffffe085f4a4820
devfs_ioctl_f() at devfs_ioctl_f+0x1f/frame 0xfffffe085f4a4840
kern_ioctl() at kern_ioctl+0x2cd/frame 0xfffffe085f4a48a0
sys_ioctl() at sys_ioctl+0x16f/frame 0xfffffe085f4a4980
amd64_syscall() at amd64_syscall+0x859/frame 0xfffffe085f4a4ab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe085f4a4ab0
--- syscall (54, FreeBSD ELF64, sys_ioctl), rip = 0x8009bb6da, rsp = 0x7fffffffe878, rbp = 0x7fffffffeb20 ---

                                                                                                                                                                                    [26/1898]
Fatal trap 12: page fault while in kernel mode
cpuid = 0; apic id = 02
fault virtual address   = 0x100000408
fault code              = supervisor read data, page not present
instruction pointer     = 0x20:0xffffffff80a6cc4d
stack pointer           = 0x28:0xfffffe085f1cb380
frame pointer           = 0x28:0xfffffe085f1cb430
code segment            = base 0x0, limit 0xfffff, type 0x1b
                        = DPL 0, pres 1, long 1, def32 0, gran 1
processor eflags        = interrupt enabled, resume, IOPL = 0
current process         = 1067 (vpsctl)
[ thread pid 1067 tid 100098 ]
Stopped at      _sx_xlock_hard+0x4ad:   movl    0x408(%r15),%eax
db> where
Tracing pid 1067 tid 100098 td 0xfffff8000dc17580
_sx_xlock_hard() at _sx_xlock_hard+0x4ad/frame 0xfffffe085f1cb430
_sx_xlock() at _sx_xlock+0xc5/frame 0xfffffe085f1cb470
sblock() at sblock+0x9d/frame 0xfffffe085f1cb490
vps_snapshot_socket() at vps_snapshot_socket+0x23d/frame 0xfffffe085f1cb500
vps_snapshot_socket() at vps_snapshot_socket+0x17d/frame 0xfffffe085f1cb570
vps_snapshot() at vps_snapshot+0x27eb/frame 0xfffffe085f1cb660
vps_ioc_snapshot() at vps_ioc_snapshot+0x9f/frame 0xfffffe085f1cb690
devfs_ioctl() at devfs_ioctl+0xc0/frame 0xfffffe085f1cb6e0
VOP_IOCTL_APV() at VOP_IOCTL_APV+0xe0/frame 0xfffffe085f1cb710
vn_ioctl() at vn_ioctl+0x124/frame 0xfffffe085f1cb820
devfs_ioctl_f() at devfs_ioctl_f+0x1f/frame 0xfffffe085f1cb840
kern_ioctl() at kern_ioctl+0x2cd/frame 0xfffffe085f1cb8a0
sys_ioctl() at sys_ioctl+0x16f/frame 0xfffffe085f1cb980
amd64_syscall() at amd64_syscall+0x859/frame 0xfffffe085f1cbab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe085f1cbab0
--- syscall (54, FreeBSD ELF64, sys_ioctl), rip = 0x800bcf6da, rsp = 0x7fffffffe878, rbp = 0x7fffffffeb20 ---
db> show alllocks
Process 1067 (vpsctl) thread 0xfffff8000dc17580 (100098)
exclusive sx filedesc structure (filedesc structure) r = 0 (0xfffff8000dd448e0) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/modules/vps_snapst/../../vps/vps_snapst.c:2698
shared sx allproc_0xfffff8000d001000 (allproc_0xfffff8000d001000) r = 0 (0xfffffe0002f092a8) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/modules/vps_snapst/../../vps/vps_snapst.c:194
1
exclusive sx vps instance 0xfffff8000d001000 lock (vps instance 0xfffff8000d001000 lock) r = 0 (0xfffff8000d001038) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/modules/vps_dev/../../
vps/vps_user.c:431
shared sx lock of all vps instances (lock of all vps instances) r = 0 (0xffffffff81f29d60) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/modules/vps_dev/../../vps/vps_user.c:425
Process 758 (syslogd) thread 0xfffff8000d54c000 (100077)
exclusive lockmgr nfs (nfs) r = 0 (0xfffff8000dae3068) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/vfs_vnops.c:881
db> show reg
cs                        0x20
ds                        0x3b
es                        0x3b
fs                        0x13
gs                        0x1b
ss                        0x28
rax                        0x3
rcx                0x100000000
rdx                          0
rbx         0xfffffe0000c04a58
rsp         0xfffffe085f1cb380
rbp         0xfffffe085f1cb430
rsi                0x100000000
rdi         0xfffffe0000c04a58
r8          0xffffffff8149d9d8  ttystates+0x2118
r9                       0x118
r10                        0x1
r11                       0x1e
r12                          0
r13                          0
r14         0xfffff8000dc17580
r15                0x100000000
rip         0xffffffff80a6cc4d  _sx_xlock_hard+0x4ad
rflags                 0x10206  _binary_t5fw_cfg_uwire_txt_size+0xaca7
_sx_xlock_hard+0x4ad:   movl    0x408(%r15),%eax

--------------------------------------------------------------------------------

On the one process left in a VPS after stop:

db> show all proc
  pid  ppid  pgrp   uid  state   wmesg   wchan               cmd
    0     0     0     0  DLsJ    (threaded)                  [kernel]
100000                   D       swapin  0xffffffff81f14820  [swapper]
100007                   D       -       0xfffff80007724400  [softirq_0]
100008                   D       -       0xfffff80007724200  [if_io_tqg_0]
100009                   D       -       0xfffff80007724000  [if_config_tqg_0]
100011                   D       -       0xfffff80007723b00  [kqueue_ctx taskq]
100014                   D       -       0xfffff80007723500  [thread taskq]
100015                   D       -       0xfffff80007723300  [aiod_kick taskq]
100019                   D       -       0xfffff80007722c00  [firmware taskq]
100023                   D       -       0xfffff80007722400  [acpi_task_0]
100024                   D       -       0xfffff80007722400  [acpi_task_1]
100025                   D       -       0xfffff80007722400  [acpi_task_2]
100048                   D       -       0xfffff80008ccda00  [mca taskq]
100049                   D       -       0xffffffff81cf6e30  [deadlkres]
100053                   D       -       0xfffff80007722600  [CAM taskq]
100078                   D       -       0xfffff80008ccb900  [t5nex0 tq0]
100079                   D       -       0xfffff80008ccb600  [t5nex0 tq1]
100080                   D       -       0xfffff80008ccb500  [t5nex0 tq2]
100081                   D       -       0xfffff80008ccb300  [t5nex0 tq3]
nprocs = 1, np = -1

db> show all ifnets
vnet=0xfffff8000771f780
                 lo0 ifp=0xfffff8000d432800
                vps0 ifp=0xfffff8000d432000

db> show all lltab
vnet=0xfffff8000771f780
llt=0xfffff8000d1d4300 llt_af=28 llt_ifp=0xfffff8000d432000(vps0)
llt=0xfffff8000df1b400 llt_af=2 llt_ifp=0xfffff8000d432000(vps0)
llt=0xfffff8000d1d4500 llt_af=28 llt_ifp=0xfffff8000d432800(lo0)
llt=0xfffff8000d1d4700 llt_af=2 llt_ifp=0xfffff8000d432800(lo0)

--------------------------------------------------------------------------------

On startup:

[a] vps_alloc:277 XXX-BZ _vps_ref vps 0xfffff8000d009000 ucred 0xfffff8022701a400 refcnt 2
[x] shm_vpsalloc_hook:990 XXX-BZ _vps_ref vps 0xfffff8000d009000 ucred 0 refcnt 3
[x] sem_vpsalloc_hook:478 XXX-BZ _vps_ref vps 0xfffff8000d009000 ucred 0 refcnt 4
[x] msg_vpsalloc_hook:276 XXX-BZ _vps_ref vps 0xfffff8000d009000 ucred 0 refcnt 5
vps_switch_proc:1454 XXX-BZ _vps_ref vps 0xfffff8000d009000 ucred 0xfffff8022701a500 refcnt 6
[b] crcopy:1939 XXX-BZ _vps_ref vps 0xfffff8000d009000 ucred 0xfffff80227019a00 refcnt 7

On stop:

[b] crfree:1907 XXX-BZ _vps_deref vps 0xfffff8000d009000 ucred 0xfffff80227019a00 last 0 refcnt 6
[x] shm_vpsfree_hook:1006 XXX-BZ _vps_deref vps 0xfffff8000d009000 ucred 0 last 0 refcnt 5
[x] sem_vpsfree_hook:498 XXX-BZ _vps_deref vps 0xfffff8000d009000 ucred 0 last 0 refcnt 4
[x] msg_vpsfree_hook:290 XXX-BZ _vps_deref vps 0xfffff8000d009000 ucred 0 last 0 refcnt 3
vps_free_locked:688 XXX-BZ _vps_deref vps 0xfffff8000d009000 ucred 0xdeadbeef last 0 refcnt 2
and after some delay:
[a] crfree:1907 XXX-BZ _vps_deref vps 0xfffff8000d009000 ucred 0xfffff8022701a400 last 0 refcnt 1

--------------------------------------------------------------------------------

XXX-BZ uifind:1290 new_uip 0xfffff8000771de80
KDB: stack backtrace:
db_fetch_ksymtab() at db_fetch_ksymtab+0x14b/frame 0xfffffe085f49d530
uifind() at uifind+0x13c/frame 0xfffffe085f49d580
vps_switch_proc() at vps_switch_proc+0x73a/frame 0xfffffe085f49d660
vps_ioc_switch() at vps_ioc_switch+0x5e/frame 0xfffffe085f49d690
dev2udev() at dev2udev+0x2650/frame 0xfffffe085f49d6e0
VOP_IOCTL_APV() at VOP_IOCTL_APV+0xe0/frame 0xfffffe085f49d710
sys_posix_fadvise() at sys_posix_fadvise+0x4e4/frame 0xfffffe085f49d820
dev2udev() at dev2udev+0x2d2f/frame 0xfffffe085f49d840
kern_ioctl() at kern_ioctl+0x2cd/frame 0xfffffe085f49d8a0
sys_ioctl() at sys_ioctl+0x16f/frame 0xfffffe085f49d980

--------------------------------------------------------------------------------


root@rabbit3:~ # vpsctl abort testvps
vps_suspend_relink_delete: get_next_dirent() error=2
root@rabbit3:~ # VNASSERT failed
0xfffff8000db473b0: tag nfs, type VREG
    usecount 0, writecount 1, refcount 0 mountedhere 0
    flags (VI_FREE)
    v_object 0xfffff8000db28d20 ref 0 pages 0 cleanbuf 0 dirtybuf 0
    lock type nfs: UNLOCKED
        fileid 32158566 fsid 0x3a3a00ff01
panic: vn_lock: zero hold count
cpuid = 0
time = 1509380681
KDB: stack backtrace:
db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 0xfffffe085f1bb4e0
vpanic() at vpanic+0x19c/frame 0xfffffe085f1bb560
kassert_panic() at kassert_panic+0x126/frame 0xfffffe085f1bb5d0
_vn_lock() at _vn_lock+0x142/frame 0xfffffe085f1bb640
vn_write() at vn_write+0x196/frame 0xfffffe085f1bb6c0
vn_io_fault1() at vn_io_fault1+0x1b0/frame 0xfffffe085f1bb810
vn_io_fault() at vn_io_fault+0x197/frame 0xfffffe085f1bb890
dofilewrite() at dofilewrite+0xa7/frame 0xfffffe085f1bb8e0
kern_writev() at kern_writev+0x68/frame 0xfffffe085f1bb930
sys_write() at sys_write+0x86/frame 0xfffffe085f1bb980
amd64_syscall() at amd64_syscall+0x859/frame 0xfffffe085f1bbab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe085f1bbab0
--- syscall (4, FreeBSD ELF64, sys_write), rip = 0x800c085fa, rsp = 0x7fffffffd1d8, rbp = 0x7fffffffd210 ---
KDB: enter: panic
[ thread pid 24 tid 100104 ]
Stopped at      kdb_enter+0x3b: movq    $0,kdb_why
db> show proc 24
Process 24 (sh) at 0xfffff8003c90b540:
 state: NORMAL
 uid: 0  gids: 0, 5
 parent: pid 16 at 0xfffff8000db13540
 ABI: FreeBSD ELF64
 arguments: sh /etc/rc
 threads: 1
100104                   Run     CPU 0                       sh
 repear: 0xfffff8000d081000
 reapsubtree: 16
 vmspace: 0xfffff8000dbd6000
   (map 0xfffff8000dbd6000)
     (pmap 0xfffff8000dbd60d8)
   (pmap 0xfffff8000dbd6130)



--------------------------------------------------------------------------------

on the restored system:
- do we have a parent process on resume when creating the vps after migration?
- do we properly restore the reaper in these cases?

panic: exit1: child procs exists but q->p_reaper == NULL, p=0xfffff8000ed35540 q=0xfffff8000ed35a80
cpuid = 0
time = 1510594135
KDB: stack backtrace:
db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 0xfffffe085f418670
vpanic() at vpanic+0x19c/frame 0xfffffe085f4186f0
kassert_panic() at kassert_panic+0x126/frame 0xfffffe085f418760
exit1() at exit1+0xf59/frame 0xfffffe085f4187d0
sigexit() at sigexit+0xb2c/frame 0xfffffe085f4189a0
postsig() at postsig+0x2a6/frame 0xfffffe085f418a70
ast() at ast+0x4c8/frame 0xfffffe085f418ab0
doreti_ast() at doreti_ast+0x1f/frame 0x7fffffffe0e0
KDB: enter: panic
[ thread pid 1 tid 100095 ]
Stopped at      kdb_enter+0x3b: movq    $0,kdb_why
db> ps
  pid  ppid  pgrp   uid  state   wmesg   wchan               cmd
    0     0     0     0  DLsJ    (threaded)                  [kernel]
100000                   D       swapin  0xffffffff81f25840  [swapper]
100007                   D       -       0xfffff80007721400  [softirq_0]
100008                   D       -       0xfffff80007721200  [if_io_tqg_0]
100009                   D       -       0xfffff80007721000  [if_config_tqg_0]
100010                   D       -       0xfffff80007720d00  [kqueue_ctx taskq]
100013                   D       -       0xfffff80007720700  [thread taskq]
100014                   D       -       0xfffff80007720500  [aiod_kick taskq]
100019                   D       -       0xfffff8000771fc00  [firmware taskq]
100022                   D       -       0xfffff8000771f600  [acpi_task_0]
100023                   D       -       0xfffff8000771f600  [acpi_task_1]
100024                   D       -       0xfffff8000771f600  [acpi_task_2]
100048                   D       -       0xfffff80008cbea00  [mca taskq]
100049                   D       -       0xffffffff81d07e30  [deadlkres]
100053                   D       -       0xfffff8000771f200  [CAM taskq]
100078                   D       -       0xfffff80008cbc800  [t5nex0 tq0]
100079                   D       -       0xfffff80008cbc700  [t5nex0 tq1]
100080                   D       -       0xfffff80008cbc500  [t5nex0 tq2]
100081                   D       -       0xfffff80008cbc300  [t5nex0 tq3]
    1     1     1     0  RE+     CPU 0                       init
nprocs = 2, np = -1
db> show proc 0xfffff8000ed35540
Process 1 (init) at 0xfffff8000ed35540:
 state: NORMAL
 uid: 0  gids: 0, 5
 ABI: FreeBSD ELF64
 arguments: /sbin/init
 threads: 1
100095                   Run     CPU 0                       init
 pptr: 0
 repear: 0
 reapsubtree: 956
 sigparent: 20
 vmspace: 0xffffffff81f26318
   (map 0xffffffff81f26318)
     (pmap 0xffffffff81f263f0)
   (pmap 0xffffffff81f26448)
db> show proc 0xfffff8000ed35a80
Process 2 (init) at 0xfffff8000ed35a80:
 state: ZOMBIE
 uid: 0  gids: 0, 5
 parent: pid 1 at 0xfffff8000ed35540
 ABI: FreeBSD ELF64
 arguments: /sbin/init
 threads: 1
100094                   Inactv                              init
 pptr: 0xfffff8000ed35540
 repear: 0
 reapsubtree: 956
 sigparent: 20
 vmspace: 0xffffffff81f26318
   (map 0xffffffff81f26318)
     (pmap 0xffffffff81f263f0)
   (pmap 0xffffffff81f26448)

--------------------------------------------------------------------------------

root@rabbit3:~ # vpsctl stop testvps
XXX-BZ vps_free_locked:588 vps 0xfffff8000bfff000 vps_name testvps vps_status 4
XXX-BZ vps_free_locked:659 vps 0xfffff8000bfff000 V_proctree_lock 0xfffffe0002ea92c8 p2 0 p 0xfffff8000e0c6000
XXX-BZ vps_proc_release:1065 vps1 0xfffff8000bfff000 vps2 0xfffff8000bfff000 V_proctree_lock 0xfffffe0002ea92c8
panic: _sx_xlock_hard: recursed on non-recursive sx vps instance 0xfffff8000bfff000 lock @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/vps/vps_core.c:908

cpuid = 0
time = 1510901361
KDB: stack backtrace:
db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 0xfffffe085ebd63c0
vpanic() at vpanic+0x19c/frame 0xfffffe085ebd6440
kassert_panic() at kassert_panic+0x126/frame 0xfffffe085ebd64b0
_sx_xlock_hard() at _sx_xlock_hard+0x75a/frame 0xfffffe085ebd6580
_sx_xlock() at _sx_xlock+0xc5/frame 0xfffffe085ebd65c0
vps_deref() at vps_deref+0x106/frame 0xfffffe085ebd6600
vps_free_locked() at vps_free_locked+0x68e/frame 0xfffffe085ebd6650
vps_free() at vps_free+0x2c/frame 0xfffffe085ebd6670
vps_ioc_destroy() at vps_ioc_destroy+0x53/frame 0xfffffe085ebd6690
devfs_ioctl() at devfs_ioctl+0xc0/frame 0xfffffe085ebd66e0
VOP_IOCTL_APV() at VOP_IOCTL_APV+0xe0/frame 0xfffffe085ebd6710
vn_ioctl() at vn_ioctl+0x124/frame 0xfffffe085ebd6820
devfs_ioctl_f() at devfs_ioctl_f+0x1f/frame 0xfffffe085ebd6840
kern_ioctl() at kern_ioctl+0x2cd/frame 0xfffffe085ebd68a0
sys_ioctl() at sys_ioctl+0x16f/frame 0xfffffe085ebd6980
amd64_syscall() at amd64_syscall+0x37b/frame 0xfffffe085ebd6ab0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe085ebd6ab0
--- syscall (54, FreeBSD ELF64, sys_ioctl), rip = 0x800bcf6da, rsp = 0x7fffffffcfb8, rbp = 0x7fffffffeb40 ---
KDB: enter: panic
[ thread pid 17111 tid 100101 ]
Stopped at      kdb_enter+0x3b: movq    $0,kdb_why
db>



After stop, when the timer happens:

panic: Lock vps instance 0xfffff80008df4800 lock not exclusively locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/vps/vps_core.c:912

cpuid = 0
time = 1511108522
KDB: stack backtrace:
db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 0xfffffe085e8fb840
vpanic() at vpanic+0x19c/frame 0xfffffe085e8fb8c0
panic() at panic+0x43/frame 0xfffffe085e8fb920
_sx_assert() at _sx_assert+0xb2/frame 0xfffffe085e8fb930
vps_deref() at vps_deref+0x106/frame 0xfffffe085e8fb970
_crfree() at _crfree+0x111/frame 0xfffffe085e8fb9b0
brelse() at brelse+0x66a/frame 0xfffffe085e8fba00
buf_recycle() at buf_recycle+0x20d/frame 0xfffffe085e8fba50
bufspace_daemon() at bufspace_daemon+0x72/frame 0xfffffe085e8fba70
fork_exit() at fork_exit+0x88/frame 0xfffffe085e8fbab0
fork_trampoline() at fork_trampoline+0xe/frame 0xfffffe085e8fbab0
--- trap 0, rip = 0, rsp = 0, rbp = 0 ---
KDB: enter: panic
[ thread pid 20 tid 100062 ]
Stopped at      kdb_enter+0x3b: movq    $0,kdb_why
db>


--------------------------------------------------------------------------------

pid 2   sh?             0xfffff8000473d540
        pptr            0xfffff8000473da80
        sibling         next 0x0, prev 0xfffff8000473db78       <<< pid 0, has sinbling prev/next, children 0x1; no threads; bogus
        children        first 0x0
        reaper          0xfffff8000473da80
        reaplist        first 0x0
        reaplsibling    next 0x0, prev 0x0
        reapsubtree     0x1

pid 1   init?           0xfffff8000473da80
        pptr            0xfffff8000473ea80
        siblings        next 0x0, prev 0xfffff8000473e0f8       <<< pid 0, cred 4, ... looks bogus
        children        first 0xfffff8000473d540
        reaper          0xfffff8000473ea80
        reaplist        0x0                                     <<<
        reapsibling     next 0x0, prev 0xfffff8000473eb88       <<< loads of 0s, looks bogus
        reapsubtree     0x2ad

pid 0x2ad   vps1?       0xfffff8000473ea80
        pptr            0xffffffff81f25940
        siblings        0xfffff80004407000, 0xfffff8000473e628
        children        first 0x0                               <<< SHOULD BE FIXED
        reaper          0xffffffff81f25940
        reaplist        first 0xfffff8000473da80
        reapsibling     next 0xfffff80004407000, prev 0xfffff8000473e650
        reapsubtree     0x2ad

--------------------------------------------------------------------------------

in qemu after sh vps.sh, snapshot, abort, stop, then on list it panics:

Stopped at      strlen+0x1f:    movq    (%rcx),%rax
db> where
Tracing pid 793 tid 100076 td 0xfffff80004842580
strlen() at strlen+0x1f/frame 0xfffffe00f6f01220
kvprintf() at kvprintf+0x9bc/frame 0xfffffe00f6f01320
vsnprintf() at vsnprintf+0x31/frame 0xfffffe00f6f01340
kassert_panic() at kassert_panic+0x5a/frame 0xfffffe00f6f013b0
__mtx_lock_flags() at __mtx_lock_flags+0x158/frame 0xfffffe00f6f01400
prison_free() at prison_free+0x27/frame 0xfffffe00f6f01430
_crfree() at _crfree+0xf2/frame 0xfffffe00f6f01470
devfs_free() at devfs_free+0x23/frame 0xfffffe00f6f01490
devfs_populate_loop() at devfs_populate_loop+0x193/frame 0xfffffe00f6f014f0
devfs_populate() at devfs_populate+0x4a/frame 0xfffffe00f6f01510
devfs_populate_vp() at devfs_populate_vp+0x7f/frame 0xfffffe00f6f01560
devfs_lookup() at devfs_lookup+0x2c/frame 0xfffffe00f6f01670
VOP_LOOKUP_APV() at VOP_LOOKUP_APV+0xda/frame 0xfffffe00f6f016a0
lookup() at lookup+0x6d2/frame 0xfffffe00f6f01740
namei() at namei+0x534/frame 0xfffffe00f6f01800
vn_open_cred() at vn_open_cred+0x1fd/frame 0xfffffe00f6f01950
kern_openat() at kern_openat+0x1fe/frame 0xfffffe00f6f01ac0
amd64_syscall() at amd64_syscall+0x37b/frame 0xfffffe00f6f01bf0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe00f6f01bf0
--- syscall (499, FreeBSD ELF64, sys_openat), rip = 0x800b5f73a, rsp = 0x7ffffff
fea88, rbp = 0x7fffffffeb70 ---

--------------------------------------------------------------------------------

On reboot after vps stop:

vps_deref: vps=0xfffff800043c7000 is DEAD and last reference gone --> scheduling
destroy
panic: negative refcount 0xfffff800043c7168
cpuid = 0
time = 1511441536
KDB: stack backtrace:
db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 0xfffffe011b1e9440
vpanic() at vpanic+0x19c/frame 0xfffffe011b1e94c0
kassert_panic() at kassert_panic+0x126/frame 0xfffffe011b1e9530
vps_deref() at vps_deref+0x209/frame 0xfffffe011b1e9570
_crfree() at _crfree+0x113/frame 0xfffffe011b1e95b0
brelse() at brelse+0x66a/frame 0xfffffe011b1e9600
flushbuflist() at flushbuflist+0x167/frame 0xfffffe011b1e9680
bufobj_invalbuf() at bufobj_invalbuf+0x81/frame 0xfffffe011b1e96e0
vgonel() at vgonel+0x15e/frame 0xfffffe011b1e9750
vflush() at vflush+0x368/frame 0xfffffe011b1e98a0
ffs_flushfiles() at ffs_flushfiles+0x161/frame 0xfffffe011b1e9910
ffs_unmount() at ffs_unmount+0x7e/frame 0xfffffe011b1e9960
dounmount() at dounmount+0x5eb/frame 0xfffffe011b1e99e0
vfs_unmountall() at vfs_unmountall+0x7b/frame 0xfffffe011b1e9a10
bufshutdown() at bufshutdown+0x3ab/frame 0xfffffe011b1e9a60
kern_reboot() at kern_reboot+0x189/frame 0xfffffe011b1e9aa0
kern_reboot() at kern_reboot/frame 0xfffffe011b1e9ac0

--------------------------------------------------------------------------------


root@:~ # vpsctl resume testvps
vps_resume: resume vps=0xfffff800043c3800 BEGIN
vps_md_syscall_fixup: proc=0xfffff80004737540/1 elf64_freebsd_sysvec
vps_md_syscall_fixup: code=7/0x7 narg=4 args: 00000000ffffffff 00007fffffffe93c
0000000000000000 0000000000000000 0000000000000000 0000000000000000
SYSCALL: tid=100073 pid=1 syscall=7 retval[0]=0 retval[1]=0 errno=0
vps_md_syscall_fixup: proc=0xfffff80004737a80/2 elf64_freebsd_sysvec
vps_md_syscall_fixup: code=240/0xf0 narg=2 args: 00007fffffffed30 00007fffffffed
30 0000000000000000 0000000000000000 0000000000000000 0000000000000000
SYSCALL: tid=100072 pid=2 syscall=240 retval[0]=0 retval[1]=0 errno=0
vps_access_vmspace: vmspace=0xfffff800047d2000 vaddr=0x7fffffffed30 len=16 buf=0
xfffffe011b1e4728 prot=1
vps_access_vmspace: vaddr=0x7fffffffed30 len=16 map=0xfffff800047d2000 entry=0xf
ffff800047ddb40 object=0xfffff80004707870 pindex=31
vps_syscall_fixup_need_inthread: SYS_nanosleep: suspended at 0
vps_syscall_fixup_need_inthread: SYS_nanosleep: ts: sec=0 nsec=0
p=0xfffff80004737540 pid=1
p=0xfffff80004737a80 pid=2
vps_resume: vnet=0xfffff80003caeec0 clearing VPS_VNET_SUSPENDED
vps_resume: resume vps=0xfffff800043c3800 FINISHED
root@:~ # XXX-BZ fork_exit:1102 p 0xfffff80004737540 td 0xfffff800047f9000 frame
0xfffffe011b1fdc00 td_pcb 0xfffffe011b1fdcc0 td_frame 0xfffffe011b1fdc00
trap_pfault:734 XXX proc=0xfffff80004737540/1 map=0xfffff800047d1000 eva=0000000
800b985da prot=4 tf_rip=0x800b985da


Breakpoint 1, exit1 (td=0xfffff8000450d580, rval=0, signo=11) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/kern_exit.c:197
197     {
(kgdb) where
#0  exit1 (td=0xfffff8000450d580, rval=0, signo=11) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/kern_exit.c:197
#1  0xffffffff80a6d04c in sigexit (td=0xfffff8000450d580, sig=11) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/kern_sig.c:3126
#2  0xffffffff80a6d636 in postsig (sig=11) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/kern_sig.c:3032
#3  0xffffffff80ac1ee8 in ast (framep=<optimized out>) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/subr_trap.c:324
#4  0xffffffff80f22c49 in doreti_ast () at /tank/users/bz/vps_zambcom/vps_zabcom/sys/amd64/amd64/exception.S:686
#5  0x00007fffffffed30 in ?? ()
#6  0x00007fffffffed30 in ?? ()
#7  0x00007fffffffecb8 in ?? ()
#8  0xe390e7a64b7e681f in ?? ()
#9  0x0000000000000004 in ?? ()
#10 0x0000000000000000 in ?? ()

(kgdb) p/x *(struct thread *)0xfffff8000450d580
$3 = {td_lock = 0xffffffff81d1f580, td_proc = 0xfffff80004737a80, td_plist = {tqe_next = 0x0, tqe_prev = 0xfffff80004737a90}, td_runq = {tqe_next = 0x0, tqe_prev = 0xffffffff81d1fcc0},
  td_slpq = {tqe_next = 0x0, tqe_prev = 0x0}, td_lockq = {tqe_next = 0x0, tqe_prev = 0x0}, td_hash = {le_next = 0x0, le_prev = 0xfffffe0000dda740}, td_cpuset = 0xfffff80003cc8000,
  td_sel = 0x0, td_sleepqueue = 0xfffff800037b7e80, td_turnstile = 0xfffff8000450bd80, td_rlqe = 0x0, td_umtxq = 0xfffff80003f54b80, td_vm_dom_policy = {seq = 0x0, p = {policy = 0x0,
      domain = 0xffffffff}}, td_tid = 0x186e8, td_sigqueue = {sq_signals = {__bits = {0x0, 0x0, 0x0, 0x0}}, sq_kill = {__bits = {0x0, 0x0, 0x0, 0x0}}, sq_ptrace = {__bits = {0x0, 0x0, 0x0,
        0x0}}, sq_list = {tqh_first = 0x0, tqh_last = 0xfffff8000450d650}, sq_proc = 0xfffff80004737a80, sq_flags = 0x1}, td_lend_user_pri = 0xff, td_flags = 0x4, td_flags2 = 0x0,
  td_inhibitors = 0x0, td_pflags = 0x0, td_dupfd = 0x0, td_sqqueue = 0x0, td_wchan = 0x0, td_wmesg = 0x0, td_owepreempt = 0x0, td_tsqueue = 0x0, td_locks = 0x0, td_rw_rlocks = 0x0,
  td_lk_slocks = 0x0, td_stopsched = 0x0, td_blocked = 0x0, td_lockname = 0x0, td_contested = {lh_first = 0x0}, td_sleeplocks = 0xffffffff81e48028, td_intr_nesting_level = 0x0,
  td_pinned = 0x0, td_ucred = 0xfffff80003cb4100, td_limit = 0xfffff80003cd7100, td_slptick = 0x0, td_blktick = 0x0, td_swvoltick = 0x0, td_swinvoltick = 0x0, td_cow = 0x0, td_ru = {
    ru_utime = {tv_sec = 0x0, tv_usec = 0x0}, ru_stime = {tv_sec = 0x0, tv_usec = 0x0}, ru_maxrss = 0x0, ru_ixrss = 0x0, ru_idrss = 0x0, ru_isrss = 0x0, ru_minflt = 0x1, ru_majflt = 0x0,
    ru_nswap = 0x0, ru_inblock = 0x0, ru_oublock = 0x0, ru_msgsnd = 0x0, ru_msgrcv = 0x0, ru_nsignals = 0x0, ru_nvcsw = 0x0, ru_nivcsw = 0x0}, td_rux = {rux_runtime = 0x0, rux_uticks = 0x0,
    rux_sticks = 0x0, rux_iticks = 0x0, rux_uu = 0x0, rux_su = 0x0, rux_tu = 0x0}, td_incruntime = 0x0, td_runtime = 0x0, td_pticks = 0x0, td_sticks = 0x0, td_iticks = 0x0, td_uticks = 0x0,
  td_intrval = 0x0, td_oldsigmask = {__bits = {0x0, 0x0, 0x0, 0x0}}, td_generation = 0x0, td_sigstk = {ss_sp = 0x0, ss_size = 0x0, ss_flags = 0x4}, td_xsig = 0x0, td_profil_addr = 0x0,
  td_profil_ticks = 0x0, td_name = {0x0 <repeats 20 times>}, td_fpop = 0x0, td_dbgflags = 0x0, td_si = {si_signo = 0xb, si_errno = 0x0, si_code = 0x1, si_pid = 0x0, si_uid = 0x0,
    si_status = 0x0, si_addr = 0x0, si_value = {sival_int = 0x0, sival_ptr = 0x0, sigval_int = 0x0, sigval_ptr = 0x0}, _reason = {_fault = {_trapno = 0xc}, _timer = {_timerid = 0xc,
        _overrun = 0x0}, _mesgq = {_mqd = 0xc}, _poll = {_band = 0xc}, __spare__ = {__spare1__ = 0xc, __spare2__ = {0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}}}}, td_ng_outbound = 0x0, td_osd = {
    osd_nslots = 0x0, osd_slots = 0x0, osd_next = {le_next = 0x0, le_prev = 0x0}}, td_map_def_user = 0x0, td_dbg_forked = 0x0, td_vp_reserv = 0x0, td_no_sleeping = 0x0, td_dom_rr_idx = 0x0,
  td_su = 0x0, td_sleeptimo = 0x0, td_rtcgen = 0x0, td_sigmask = {__bits = {0x0, 0x0, 0x0, 0x0}}, td_rqindex = 0x29, td_base_pri = 0xac, td_priority = 0xac, td_pri_class = 0x3,
  td_user_pri = 0xac, td_base_user_pri = 0xac, td_rb_list = 0x0, td_rbp_list = 0x0, td_rb_inact = 0x0, td_sa = {code = 0xf0, callp = 0xffffffff81a17f50, args = {0x7fffffffed30,
      0x7fffffffed30, 0x7fffffffecb8, 0xe390e7a64b7e681f, 0x4, 0x0, 0x0, 0x0}, narg = 0x2}, td_pcb = 0xfffffe011b1f8cc0, td_state = 0x4, td_uretoff = {tdu_retval = {0x0, 0x0}, tdu_off = 0x0},
  td_cowgen = 0x0, td_slpcallout = {c_links = {le = {le_next = 0x0, le_prev = 0x0}, sle = {sle_next = 0x0}, tqe = {tqe_next = 0x0, tqe_prev = 0x0}}, c_time = 0x0, c_precision = 0x0,
    c_arg = 0x0, c_func = 0x0, c_lock = 0x0, c_flags = 0x0, c_iflags = 0x10, c_cpu = 0x0}, td_frame = 0xfffffe011b1f8c00, td_kstack_obj = 0xfffff800047f3690, td_kstack = 0xfffffe011b1f5000,
  td_kstack_pages = 0x4, td_critnest = 0x0, td_md = {md_spinlock_count = 0x0, md_saved_flags = 0x246, md_spurflt_addr = 0x0, md_invl_gen = {gen = 0x0, link = {le_next = 0x0, le_prev = 0x0}}},
  td_ar = 0x0, td_lprof = {{lh_first = 0x0}, {lh_first = 0x0}}, td_dtrace = 0xfffff800047b0d00, td_errno = 0xffffffff, td_vnet = 0x0, td_vnet_lpush = 0x0, td_intr_frame = 0x0,
  td_rfppwait_p = 0x0, td_ma = 0x0, td_ma_cnt = 0x0, td_emuldata = 0x0, td_lastcpu = 0xffffffff, td_oncpu = 0x0, td_lkpi_task = 0x0, td_vps = 0xfffff800043c3800,
  td_vps_acc = 0xfffff80003cb7400}


(kgdb) p/x *(struct proc *)0xfffff80004737a80
$4 = {p_list = {le_next = 0x0, le_prev = 0xfffff80004737540}, p_threads = {tqh_first = 0xfffff8000450d580, tqh_last = 0xfffff8000450d590}, p_slock = {lock_object = {
      lo_name = 0xffffffff814af2b5, lo_flags = 0x20030000, lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x4}, p_ucred = 0xfffff80003cb4100, p_fd = 0xfffff800047348a0, p_fdtol = 0x0,
  p_stats = 0xfffff80004427600, p_limit = 0xfffff80003cd7100, p_limco = {c_links = {le = {le_next = 0x0, le_prev = 0x0}, sle = {sle_next = 0x0}, tqe = {tqe_next = 0x0, tqe_prev = 0x0}},
    c_time = 0x0, c_precision = 0x0, c_arg = 0x0, c_func = 0x0, c_lock = 0x0, c_flags = 0x0, c_iflags = 0x0, c_cpu = 0x0}, p_sigacts = 0xfffff800047d7000, p_flag = 0x10004000,
  p_flag2 = 0x10000000, p_state = 0x1, p_pid = 0x2, p_hash = {le_next = 0x0, le_prev = 0xfffffe00017cc010}, p_pglist = {le_next = 0xfffff80004737540, le_prev = 0xfffff80003ec1290},
  p_pptr = 0xfffff80004737540, p_sibling = {le_next = 0x0, le_prev = 0xfffff80004737638}, p_children = {lh_first = 0x0}, p_reaper = 0xfffff80004737540, p_reaplist = {lh_first = 0x0},
  p_reapsibling = {le_next = 0x0, le_prev = 0xfffff80004737648}, p_mtx = {lock_object = {lo_name = 0xffffffff814af2a8, lo_flags = 0x21430000, lo_data = 0x0, lo_witness = 0xfffffe0000c27400},
    mtx_lock = 0x4}, p_statmtx = {lock_object = {lo_name = 0xffffffff814af2c3, lo_flags = 0x20030000, lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x4}, p_itimmtx = {lock_object = {
      lo_name = 0xffffffff814af2ca, lo_flags = 0x20030000, lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x4}, p_profmtx = {lock_object = {lo_name = 0xffffffff814af2d1, lo_flags = 0x20030000,
      lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x4}, p_ksi = 0xfffff800043818c0, p_sigqueue = {sq_signals = {__bits = {0x0, 0x0, 0x0, 0x0}}, sq_kill = {__bits = {0x0, 0x0, 0x0, 0x0}},
    sq_ptrace = {__bits = {0x0, 0x0, 0x0, 0x0}}, sq_list = {tqh_first = 0x0, tqh_last = 0xfffff80004737c58}, sq_proc = 0xfffff80004737a80, sq_flags = 0x1}, p_oppid = 0x0,
  p_vmspace = 0xfffff800047d2000, p_swtick = 0x7ff7c36a, p_cowgen = 0x0, p_realtimer = {it_interval = {tv_sec = 0x0, tv_usec = 0x0}, it_value = {tv_sec = 0x0, tv_usec = 0x0}}, p_ru = {
    ru_utime = {tv_sec = 0x0, tv_usec = 0x0}, ru_stime = {tv_sec = 0x0, tv_usec = 0x0}, ru_maxrss = 0x0, ru_ixrss = 0x0, ru_idrss = 0x0, ru_isrss = 0x0, ru_minflt = 0x0, ru_majflt = 0x0,
    ru_nswap = 0x0, ru_inblock = 0x0, ru_oublock = 0x0, ru_msgsnd = 0x0, ru_msgrcv = 0x0, ru_nsignals = 0x0, ru_nvcsw = 0x0, ru_nivcsw = 0x0}, p_rux = {rux_runtime = 0x0, rux_uticks = 0x0,
    rux_sticks = 0x0, rux_iticks = 0x0, rux_uu = 0x0, rux_su = 0x0, rux_tu = 0x0}, p_crux = {rux_runtime = 0x0, rux_uticks = 0x0, rux_sticks = 0x0, rux_iticks = 0x0, rux_uu = 0x0,
    rux_su = 0x0, rux_tu = 0x0}, p_profthreads = 0x0, p_exitthreads = 0x0, p_traceflag = 0x0, p_tracevp = 0x0, p_tracecred = 0x0, p_textvp = 0xfffff800047eb588, p_lock = 0x0, p_sigiolst = {
    slh_first = 0x0}, p_sigparent = 0x14, p_sig = 0xb, p_code = 0x1, p_stops = 0x0, p_stype = 0x0, p_step = 0x0, p_pfsflags = 0x0, p_ptevents = 0x0, p_nlminfo = 0x0, p_aioinfo = 0x0,
  p_singlethread = 0x0, p_suspcount = 0x0, p_xthread = 0x0, p_boundary_count = 0x0, p_pendingcnt = 0x0, p_itimers = 0x0, p_procdesc = 0x0, p_treeflag = 0x0, p_pendingexits = 0x0,
  p_filemon = 0x0, p_magic = 0xbeefface, p_osrel = 0x0, p_comm = {0x73, 0x6c, 0x65, 0x65, 0x70, 0x0 <repeats 15 times>}, p_sysent = 0xffffffff81a7ffc8, p_args = 0xfffff80003f48a60,
  p_cpulimit = 0x7fffffffffffffff, p_nice = 0x0, p_fibnum = 0x0, p_reapsubtree = 0x1, p_elf_machine = 0x0, p_elf_flags = 0x0, p_xexit = 0x0, p_xsig = 0x0, p_pgrp = 0xfffff80003ec1280,
  p_klist = 0xfffff800037c5c00, p_numthreads = 0x1, p_md = {md_ldt = 0x0, md_ldt_sd = {sd_lolimit = 0x0, sd_lobase = 0x0, sd_type = 0x0, sd_dpl = 0x0, sd_p = 0x0, sd_hilimit = 0x0,
      sd_xx0 = 0x0, sd_gran = 0x0, sd_hibase = 0x0, sd_xx1 = 0x0, sd_mbz = 0x0, sd_xx2 = 0x0}}, p_itcallout = {c_links = {le = {le_next = 0x0, le_prev = 0x0}, sle = {sle_next = 0x0}, tqe = {
        tqe_next = 0x0, tqe_prev = 0x0}}, c_time = 0x0, c_precision = 0x0, c_arg = 0x0, c_func = 0x0, c_lock = 0x0, c_flags = 0x0, c_iflags = 0x10, c_cpu = 0x0}, p_acflag = 0x10,
  p_peers = 0x0, p_leader = 0xfffff80004737a80, p_emuldata = 0x0, p_label = 0x0, p_ktr = {stqh_first = 0x0, stqh_last = 0xfffff80004737f48}, p_mqnotifier = {lh_first = 0x0},
  p_dtrace = 0xfffff800037c5c40, p_pwait = {cv_description = 0xffffffff814b00f0, cv_waiters = 0x0}, p_dbgwait = {cv_description = 0xffffffff814b00f7, cv_waiters = 0x0}, p_prev_runtime = 0x0,
  p_racct = 0x0, p_throttled = 0x0, p_vm_dom_policy = {seq = 0x0, p = {policy = 0x0, domain = 0x0}}, p_orphan = {le_next = 0x0, le_prev = 0x0}, p_orphans = {lh_first = 0x0}}


(kgdb) p/x *(struct proc *)0xfffff80004737540
$5 = {p_list = {le_next = 0xfffff80004737a80, le_prev = 0xfffffe000160f308}, p_threads = {tqh_first = 0xfffff800047f9000, tqh_last = 0xfffff800047f9010}, p_slock = {lock_object = {
      lo_name = 0xffffffff814af2b5, lo_flags = 0x20030000, lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x4}, p_ucred = 0xfffff800047b1200, p_fd = 0xfffff80004734450, p_fdtol = 0x0,
  p_stats = 0xfffff80004427800, p_limit = 0xfffff80003cd7000, p_limco = {c_links = {le = {le_next = 0x0, le_prev = 0x0}, sle = {sle_next = 0x0}, tqe = {tqe_next = 0x0, tqe_prev = 0x0}},
    c_time = 0x0, c_precision = 0x0, c_arg = 0x0, c_func = 0x0, c_lock = 0x0, c_flags = 0x0, c_iflags = 0x0, c_cpu = 0x0}, p_sigacts = 0xfffff800047f6000, p_flag = 0x10004002,
  p_flag2 = 0x10000000, p_state = 0x1, p_pid = 0x1, p_hash = {le_next = 0x0, le_prev = 0xfffffe00017cc008}, p_pglist = {le_next = 0x0, le_prev = 0xfffff80004737b50},
  p_pptr = 0xfffff80004739540, p_sibling = {le_next = 0x0, le_prev = 0xfffff80004739638}, p_children = {lh_first = 0xfffff80004737a80}, p_reaper = 0xfffff80004739540, p_reaplist = {
    lh_first = 0xfffff80004737a80}, p_reapsibling = {le_next = 0x0, le_prev = 0xfffff80004739648}, p_mtx = {lock_object = {lo_name = 0xffffffff814af2a8, lo_flags = 0x21430000, lo_data = 0x0,
      lo_witness = 0xfffffe0000c27400}, mtx_lock = 0x4}, p_statmtx = {lock_object = {lo_name = 0xffffffff814af2c3, lo_flags = 0x20030000, lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x4},
  p_itimmtx = {lock_object = {lo_name = 0xffffffff814af2ca, lo_flags = 0x20030000, lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x4}, p_profmtx = {lock_object = {lo_name = 0xffffffff814af2d1,
      lo_flags = 0x20030000, lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x4}, p_ksi = 0xfffff80004381850, p_sigqueue = {sq_signals = {__bits = {0x0, 0x0, 0x0, 0x0}}, sq_kill = {__bits = {
        0x0, 0x0, 0x0, 0x0}}, sq_ptrace = {__bits = {0x0, 0x0, 0x0, 0x0}}, sq_list = {tqh_first = 0x0, tqh_last = 0xfffff80004737718}, sq_proc = 0xfffff80004737540, sq_flags = 0x1},
  p_oppid = 0x0, p_vmspace = 0xfffff800047d1000, p_swtick = 0x7ff7c1a6, p_cowgen = 0x0, p_realtimer = {it_interval = {tv_sec = 0x0, tv_usec = 0x0}, it_value = {tv_sec = 0x0, tv_usec = 0x0}},
  p_ru = {ru_utime = {tv_sec = 0x0, tv_usec = 0x0}, ru_stime = {tv_sec = 0x0, tv_usec = 0x0}, ru_maxrss = 0x0, ru_ixrss = 0x0, ru_idrss = 0x0, ru_isrss = 0x0, ru_minflt = 0x0,
    ru_majflt = 0x0, ru_nswap = 0x0, ru_inblock = 0x0, ru_oublock = 0x0, ru_msgsnd = 0x0, ru_msgrcv = 0x0, ru_nsignals = 0x0, ru_nvcsw = 0x0, ru_nivcsw = 0x0}, p_rux = {rux_runtime = 0x0,
    rux_uticks = 0x0, rux_sticks = 0x0, rux_iticks = 0x0, rux_uu = 0x0, rux_su = 0x0, rux_tu = 0x0}, p_crux = {rux_runtime = 0x0, rux_uticks = 0x0, rux_sticks = 0x0, rux_iticks = 0x0,
    rux_uu = 0x0, rux_su = 0x0, rux_tu = 0x0}, p_profthreads = 0x0, p_exitthreads = 0x0, p_traceflag = 0x0, p_tracevp = 0x0, p_tracecred = 0x0, p_textvp = 0xfffff800047eab10, p_lock = 0x0,
  p_sigiolst = {slh_first = 0x0}, p_sigparent = 0x14, p_sig = 0xb, p_code = 0x1, p_stops = 0x0, p_stype = 0x0, p_step = 0x0, p_pfsflags = 0x0, p_ptevents = 0x0, p_nlminfo = 0x0,
  p_aioinfo = 0x0, p_singlethread = 0x0, p_suspcount = 0x0, p_xthread = 0x0, p_boundary_count = 0x0, p_pendingcnt = 0x1, p_itimers = 0x0, p_procdesc = 0x0, p_treeflag = 0x0,
  p_pendingexits = 0x0, p_filemon = 0x0, p_magic = 0xbeefface, p_osrel = 0x0, p_comm = {0x73, 0x68, 0x0 <repeats 18 times>}, p_sysent = 0xffffffff81a7ffc8, p_args = 0xfffff800037c5b00,
  p_cpulimit = 0x7fffffffffffffff, p_nice = 0x0, p_fibnum = 0x0, p_reapsubtree = 0x2b5, p_elf_machine = 0x0, p_elf_flags = 0x0, p_xexit = 0x0, p_xsig = 0x0, p_pgrp = 0xfffff80003ec1280,
  p_klist = 0xfffff800037c5b40, p_numthreads = 0x1, p_md = {md_ldt = 0x0, md_ldt_sd = {sd_lolimit = 0x0, sd_lobase = 0x0, sd_type = 0x0, sd_dpl = 0x0, sd_p = 0x0, sd_hilimit = 0x0,
      sd_xx0 = 0x0, sd_gran = 0x0, sd_hibase = 0x0, sd_xx1 = 0x0, sd_mbz = 0x0, sd_xx2 = 0x0}}, p_itcallout = {c_links = {le = {le_next = 0x0, le_prev = 0x0}, sle = {sle_next = 0x0}, tqe = {
        tqe_next = 0x0, tqe_prev = 0x0}}, c_time = 0x0, c_precision = 0x0, c_arg = 0x0, c_func = 0x0, c_lock = 0x0, c_flags = 0x0, c_iflags = 0x10, c_cpu = 0x0}, p_acflag = 0x0,
  p_peers = 0x0, p_leader = 0xfffff80004737540, p_emuldata = 0x0, p_label = 0x0, p_ktr = {stqh_first = 0x0, stqh_last = 0xfffff80004737a08}, p_mqnotifier = {lh_first = 0x0},
  p_dtrace = 0xfffff800037c5b80, p_pwait = {cv_description = 0xffffffff814b00f0, cv_waiters = 0x0}, p_dbgwait = {cv_description = 0xffffffff814b00f7, cv_waiters = 0x0}, p_prev_runtime = 0x0,
  p_racct = 0x0, p_throttled = 0x0, p_vm_dom_policy = {seq = 0x0, p = {policy = 0x0, domain = 0x0}}, p_orphan = {le_next = 0x0, le_prev = 0x0}, p_orphans = {lh_first = 0x0}}


(kgdb) p/x *(struct vps *)0xfffff800043c3800
$8 = {vnet = 0xfffff80003caeec0, vps_all = {le_next = 0xfffff80003ae9800, le_prev = 0xffffffff81f589f0}, vps_sibling = {le_next = 0x0, le_prev = 0xfffff80003ae9828}, vps_child_head = {
    lh_first = 0x0}, vps_parent = 0xfffff80003ae9800, vps_lock = {lock_object = {lo_name = 0xfffff80003cb4800, lo_flags = 0x2330000, lo_data = 0x0, lo_witness = 0xfffffe0000c34100},
    sx_lock = 0x1}, vps_lock_name = 0xfffff80003cb4800, vps_id = 0x1, vps_name = {0x74, 0x65, 0x73, 0x74, 0x76, 0x70, 0x73, 0x0 <repeats 249 times>}, vps_status = 0x4, vps_refcnt = 0x6,
  vps_refcnt_lock = {lock_object = {lo_name = 0xffffffff815187a5, lo_flags = 0x30000, lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x4}, vps_ref_head = {tqh_first = 0xfffff80003f48ba0,
    tqh_last = 0xfffff80003f48b00}, vps_task = {q = 0x0, t = {ta_link = {stqe_next = 0x0}, ta_pending = 0x0, ta_priority = 0x0, ta_func = 0x0, ta_context = 0x0}, c = {c_links = {le = {
          le_next = 0x0, le_prev = 0x0}, sle = {sle_next = 0x0}, tqe = {tqe_next = 0x0, tqe_prev = 0x0}}, c_time = 0x0, c_precision = 0x0, c_arg = 0x0, c_func = 0x0, c_lock = 0x0,
      c_flags = 0x0, c_iflags = 0x0, c_cpu = 0x0}, f = 0x0}, priv_allow_set = {0x20, 0x1, 0x0, 0x0, 0x0, 0x0, 0xfc, 0x1f, 0x0, 0x0, 0x7, 0x0, 0x0, 0xc0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7,
    0x3c, 0x10, 0x0, 0x0, 0x41, 0x0, 0x0, 0xc0, 0x0, 0x6, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xc0, 0xff, 0x44, 0x23, 0xbc, 0x1, 0x0, 0x0, 0x0, 0x0, 0xc0, 0xfc, 0xff, 0xff, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x4, 0xe, 0x3, 0x0 <repeats 22 times>}, priv_impl_set = {0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0xff <repeats 80 times>}, vps_ip4 = 0xfffff80003f49f30,
  vps_ip6 = 0xfffff80003f48a80, vps_ip4_cnt = 0x1, vps_ip6_cnt = 0x1, vps_flags = 0x0, restore_count = 0x1, suspend_time = 0x0, swappertd = 0xfffff80004739540, vps_acc = 0xfffff80003cb7400,
  consolelog = 0x0, console_tty = 0xfffff800043f1000, console_fp_ma = 0xfffff8000446d870, consolelog_refcnt = 0x0, console_flags = 0x0, vps_ucred = 0xfffff80003cb4400,
  devfs_ruleset = 0xfffffe0001627000, _rootvnode = 0xfffff8000469db10, _rootpath = {0x2f, 0x76, 0x70, 0x73, 0x72, 0x6f, 0x6f, 0x74, 0x0 <repeats 1016 times>}}


(kgdb) p/x *(struct proc *)0xfffff80004739540
$9 = {p_list = {le_next = 0xfffff80004405a80, le_prev = 0xfffff80004738a80}, p_threads = {tqh_first = 0xfffff800045e9000, tqh_last = 0xfffff800045e9010}, p_slock = {lock_object = {
      lo_name = 0xffffffff814af2b5, lo_flags = 0x20030000, lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x4}, p_ucred = 0xfffff80003cb3d00, p_fd = 0xfffff800044028a0, p_fdtol = 0x0,
  p_stats = 0xfffff80004426a00, p_limit = 0xfffff80003cda000, p_limco = {c_links = {le = {le_next = 0x0, le_prev = 0x0}, sle = {sle_next = 0x0}, tqe = {tqe_next = 0x0, tqe_prev = 0x0}},
    c_time = 0x0, c_precision = 0x0, c_arg = 0x0, c_func = 0x0, c_lock = 0xfffff80004739660, c_flags = 0x0, c_iflags = 0x0, c_cpu = 0x0}, p_sigacts = 0xfffff800045bd000, p_flag = 0x10000204,
  p_flag2 = 0x0, p_state = 0x1, p_pid = 0x2b5, p_hash = {le_next = 0x0, le_prev = 0xfffffe0000dd05a8}, p_pglist = {le_next = 0xfffff80004407000, le_prev = 0xfffff80004738b50},
  p_pptr = 0xffffffff81f258c0, p_sibling = {le_next = 0xfffff80004407000, le_prev = 0xfffff80004738b68}, p_children = {lh_first = 0xfffff80004737540}, p_reaper = 0xffffffff81f258c0,
  p_reaplist = {lh_first = 0xfffff80004737540}, p_reapsibling = {le_next = 0xfffff80004407000, le_prev = 0xfffff80004738b90}, p_mtx = {lock_object = {lo_name = 0xffffffff814af2a8,
      lo_flags = 0x21430000, lo_data = 0x0, lo_witness = 0xfffffe0000c27400}, mtx_lock = 0x4}, p_statmtx = {lock_object = {lo_name = 0xffffffff814af2c3, lo_flags = 0x20030000, lo_data = 0x0,
      lo_witness = 0x0}, mtx_lock = 0x4}, p_itimmtx = {lock_object = {lo_name = 0xffffffff814af2ca, lo_flags = 0x20030000, lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x4}, p_profmtx = {
    lock_object = {lo_name = 0xffffffff814af2d1, lo_flags = 0x20030000, lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x4}, p_ksi = 0xfffff80004381af0, p_sigqueue = {sq_signals = {__bits = {
        0x0, 0x0, 0x0, 0x0}}, sq_kill = {__bits = {0x0, 0x0, 0x0, 0x0}}, sq_ptrace = {__bits = {0x0, 0x0, 0x0, 0x0}}, sq_list = {tqh_first = 0x0, tqh_last = 0xfffff80004739718},
    sq_proc = 0xfffff80004739540, sq_flags = 0x1}, p_oppid = 0x0, p_vmspace = 0xffffffff81f26398, p_swtick = 0x80010d34, p_cowgen = 0x0, p_realtimer = {it_interval = {tv_sec = 0x0,
      tv_usec = 0x0}, it_value = {tv_sec = 0x0, tv_usec = 0x0}}, p_ru = {ru_utime = {tv_sec = 0x0, tv_usec = 0x0}, ru_stime = {tv_sec = 0x0, tv_usec = 0x0}, ru_maxrss = 0x0, ru_ixrss = 0x0,
    ru_idrss = 0x0, ru_isrss = 0x0, ru_minflt = 0x0, ru_majflt = 0x0, ru_nswap = 0x0, ru_inblock = 0x0, ru_oublock = 0x0, ru_msgsnd = 0x0, ru_msgrcv = 0x0, ru_nsignals = 0x0, ru_nvcsw = 0x0,
    ru_nivcsw = 0x0}, p_rux = {rux_runtime = 0x0, rux_uticks = 0x0, rux_sticks = 0x0, rux_iticks = 0x0, rux_uu = 0x0, rux_su = 0x0, rux_tu = 0x0}, p_crux = {rux_runtime = 0x0,
    rux_uticks = 0x0, rux_sticks = 0x0, rux_iticks = 0x0, rux_uu = 0x0, rux_su = 0x0, rux_tu = 0x0}, p_profthreads = 0x0, p_exitthreads = 0x0, p_traceflag = 0x0, p_tracevp = 0x0,
  p_tracecred = 0x0, p_textvp = 0x0, p_lock = 0x0, p_sigiolst = {slh_first = 0x0}, p_sigparent = 0x14, p_sig = 0x0, p_code = 0x0, p_stops = 0x0, p_stype = 0x0, p_step = 0x0, p_pfsflags = 0x0,
  p_ptevents = 0x0, p_nlminfo = 0x0, p_aioinfo = 0x0, p_singlethread = 0x0, p_suspcount = 0x0, p_xthread = 0x0, p_boundary_count = 0x0, p_pendingcnt = 0x0, p_itimers = 0x0, p_procdesc = 0x0,
  p_treeflag = 0x4, p_pendingexits = 0x0, p_filemon = 0x0, p_magic = 0xbeefface, p_osrel = 0x124fa4, p_comm = {0x76, 0x70, 0x73, 0x31, 0x0, 0x6c, 0x0 <repeats 14 times>},
  p_sysent = 0xffffffff81a14b58, p_args = 0x0, p_cpulimit = 0x7fffffffffffffff, p_nice = 0x0, p_fibnum = 0x0, p_reapsubtree = 0x2b5, p_elf_machine = 0x0, p_elf_flags = 0x0, p_xexit = 0x0,
  p_xsig = 0x0, p_pgrp = 0xffffffff81d05630, p_klist = 0xfffff800037c6340, p_numthreads = 0x1, p_md = {md_ldt = 0x0, md_ldt_sd = {sd_lolimit = 0x0, sd_lobase = 0x0, sd_type = 0x0,
      sd_dpl = 0x0, sd_p = 0x0, sd_hilimit = 0x0, sd_xx0 = 0x0, sd_gran = 0x0, sd_hibase = 0x0, sd_xx1 = 0x0, sd_mbz = 0x0, sd_xx2 = 0x0}}, p_itcallout = {c_links = {le = {le_next = 0x0,
        le_prev = 0x0}, sle = {sle_next = 0x0}, tqe = {tqe_next = 0x0, tqe_prev = 0x0}}, c_time = 0x0, c_precision = 0x0, c_arg = 0x0, c_func = 0x0, c_lock = 0xfffff80004739660,
    c_flags = 0x0, c_iflags = 0x0, c_cpu = 0x0}, p_acflag = 0x1, p_peers = 0x0, p_leader = 0xfffff80004739540, p_emuldata = 0x0, p_label = 0x0, p_ktr = {stqh_first = 0x0,
    stqh_last = 0xfffff80004739a08}, p_mqnotifier = {lh_first = 0x0}, p_dtrace = 0xfffff800037c6240, p_pwait = {cv_description = 0xffffffff814b00f0, cv_waiters = 0x0}, p_dbgwait = {
    cv_description = 0xffffffff814b00f7, cv_waiters = 0x0}, p_prev_runtime = 0x0, p_racct = 0x0, p_throttled = 0x0, p_vm_dom_policy = {seq = 0x2, p = {policy = 0x0, domain = 0xffffffff}},
  p_orphan = {le_next = 0x0, le_prev = 0x0}, p_orphans = {lh_first = 0x0}}



(kgdb) p/x $10->td_pcb
$11 = 0xfffffe011b1f8cc0
(kgdb) p/x *$10->td_pcb
$12 = {pcb_r15 = 0xffffffff81d1f580, pcb_r14 = 0x0, pcb_r13 = 0xfffff8000481c580, pcb_r12 = 0xffffffff80dc9a10, pcb_rbp = 0x0, pcb_rsp = 0xfffffe011b1f8bf8, pcb_rbx = 0xfffff8000450d580,
  pcb_rip = 0xffffffff80f21d20, pcb_fsbase = 0x80063e898, pcb_gsbase = 0x0, pcb_kgsbase = 0x0, pcb_cr0 = 0x0, pcb_cr2 = 0x0, pcb_cr3 = 0x0, pcb_cr4 = 0x0, pcb_dr0 = 0x0, pcb_dr1 = 0x0,
  pcb_dr2 = 0x0, pcb_dr3 = 0x0, pcb_dr6 = 0x0, pcb_dr7 = 0x0, pcb_gdt = {rd_limit = 0x0, rd_base = 0x0}, pcb_idt = {rd_limit = 0x0, rd_base = 0x0}, pcb_ldt = {rd_limit = 0x0, rd_base = 0x0},
  pcb_tr = 0x0, pcb_flags = 0x18, pcb_initial_fpucw = 0x37f, pcb_onfault = 0x0, pcb_pad0 = 0x0, pcb_tssp = 0x0, pcb_efer = 0x0, pcb_star = 0x0, pcb_lstar = 0x0, pcb_cstar = 0x0,
  pcb_sfmask = 0x0, pcb_save = 0xfffffe011b1f8e00, pcb_pad = {0x0, 0x0, 0x0, 0x0, 0x0}}

(kgdb) p/x $13->p_pendingcnt
$14 = 0x0
(kgdb) p/x $13->p_siglist
There is no member named p_siglist.
(kgdb) p/x $13->p_sigqueue.sq_signals
$15 = {__bits = {0x0, 0x0, 0x0, 0x0}}
(kgdb) p/x $16->td_flags
$17 = 0x4

../sys/proc.h:#define   TDF_NEEDSIGCHK  0x00020000 /* Thread may need signal delivery. */

(kgdb) p/x $16->td_sigstk.ss_sp
$18 = 0x0

--------------------------------------------------------------------------------


FOCUS ON THIS ONE I GUESS as it has "vps_restore" specifics imho,
also related the thread_exit();
syscallret
        ->
        vps_md_syscallret
                /* restore rax from code */


This should just work with suspend/resume so that can't be the cause for
vps_restore/resume killing processes:
vps_resume
        ->
        vps_syscall_fixup
                ->
                vps_md_syscall_fixup
                        if 0x80 return
                        else do stuff /* XXX that stuff is probably wrong somewhere */
                                /* stuff == restore syscall "args" regs to some part, not sure why and what for yet */
                ->
                vps_syscall_fixup_need_inthread
                |> vps_md_syscall_fixup_setup_inthread



--------------------------------------------------------------------------------

This happened on snapshot with spinitsel (select call inside vps) and a few
other modifications.  The select has an open socket() nothing else.

Fatal trap 12: page fault while in kernel mode
cpuid = 0; apic id = 00
fault virtual address   = 0x100000408
fault code              = supervisor read data, page not present
instruction pointer     = 0x20:0xffffffff80a71c0d
stack pointer           = 0x28:0xfffffe00f6f06410
frame pointer           = 0x28:0xfffffe00f6f064d0
code segment            = base 0x0, limit 0xfffff, type 0x1b
                = DPL 0, pres 1, long 1, def32 0, gran 1
processor eflags        = interrupt enabled, IOPL = 0
current process         = 783 (vpsctl)
[ thread pid 783 tid 100077 ]
Stopped at      _sx_xlock_hard+0x50d:   movl    0x408(%r15),%eax
db>


db> where
Tracing pid 783 tid 100077 td 0xfffff80004809000
_sx_xlock_hard() at _sx_xlock_hard+0x50d/frame 0xfffffe00f6f064d0
_sx_xlock() at _sx_xlock+0xc5/frame 0xfffffe00f6f06510
sblock() at sblock+0x9d/frame 0xfffffe00f6f06530
vps_snapshot_socket() at vps_snapshot_socket+0x192/frame 0xfffffe00f6f065a0
vps_snapshot_socket() at vps_snapshot_socket+0xee/frame 0xfffffe00f6f06610
vps_snapshot_fdset() at vps_snapshot_fdset+0x3af/frame 0xfffffe00f6f06670
vps_snapshot_proc_one() at vps_snapshot_proc_one+0x7c4/frame 0xfffffe00f6f066b0
vps_snapshot_proc() at vps_snapshot_proc+0x2fa/frame 0xfffffe00f6f06700
vps_snapshot() at vps_snapshot+0x55e/frame 0xfffffe00f6f067a0
vps_ioc_snapshot() at vps_ioc_snapshot+0x9f/frame 0xfffffe00f6f067d0
devfs_ioctl() at devfs_ioctl+0xc0/frame 0xfffffe00f6f06820
VOP_IOCTL_APV() at VOP_IOCTL_APV+0xe0/frame 0xfffffe00f6f06850
vn_ioctl() at vn_ioctl+0x124/frame 0xfffffe00f6f06960
devfs_ioctl_f() at devfs_ioctl_f+0x1f/frame 0xfffffe00f6f06980
kern_ioctl() at kern_ioctl+0x2cd/frame 0xfffffe00f6f069e0
sys_ioctl() at sys_ioctl+0x16f/frame 0xfffffe00f6f06ac0
amd64_syscall() at amd64_syscall+0x36d/frame 0xfffffe00f6f06bf0
Xfast_syscall() at Xfast_syscall+0x104/frame 0xfffffe00f6f06bf0
-- syscall (54, FreeBSD ELF64, sys_ioctl), rip = 0x800bcf6da, rsp = 0x7fffffffe
898, rbp = 0x7fffffffeb40 ---


db> show alllocks
Process 783 (vpsctl) thread 0xfffff80004809000 (100077)
exclusive sx filedesc structure (filedesc structure) r = 0 (0xfffff8000473b040)
locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/vps/vps_snapst.c:2699
shared sx allproc_0xfffff800043c7000 (allproc_0xfffff800043c7000) r = 0 (0xfffff
e000160f2a8) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/vps/vps_snapst.c
:1940
exclusive sx vps instance 0xfffff800043c7000 lock (vps instance 0xfffff800043c70
00 lock) r = 0 (0xfffff800043c7038) locked @ /tank/users/bz/vps_zambcom/vps_zabc
om/sys/vps/vps_user.c:431
shared sx lock of all vps instances (lock of all vps instances) r = 0 (0xfffffff
f81f58ce0) locked @ /tank/users/bz/vps_zambcom/vps_zabcom/sys/vps/vps_user.c:425

db> show reg
cs                        0x20
ds                        0x3b
es                        0x3b
fs                        0x13
gs                        0x1b
ss                        0x28
rax                          0
rcx         0xfffff80004809000
rdx                          0
rbx         0xfffffe0000c27a58
rsp         0xfffffe00f6f06410
rbp         0xfffffe00f6f064d0
rsi                0x100000000
rdi         0xfffffe0000c27a58
r8          0xffffffff814c39d8  ttystates+0x2128
r9                       0x118
r10                        0x1
r11                       0x19
r12                          0
r13                0x100000000
r14         0xfffff80004809000
r15                0x100000000
rip         0xffffffff80a71c0d  _sx_xlock_hard+0x50d
rflags                   0x212
_sx_xlock_hard+0x50d:   movl    0x408(%r15),%eax

Good test case to reproduce the socket locking problem....


(kgdb) break *__bz_dss
Breakpoint 1 at 0xffffffff80dc7560: file /tank/users/bz/vps_zambcom/vps_zabcom/sys/vps/vps_snapst.c, line 2465.
(kgdb) cont
Continuing.

Breakpoint 1, __bz_dss (so=0xfffff8000482f358, ctx=0xfffff80003ef3600, vps=0xfffff800043c7000) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/vps/vps_snapst.c:2465
2465    {
(kgdb) where
#0  __bz_dss (so=0xfffff8000482f358, ctx=0xfffff80003ef3600, vps=0xfffff800043c7000) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/vps/vps_snapst.c:2465
#1  0xffffffff80dc6d74 in vps_snapshot_socket (ctx=0xfffff80003ef3600, vps=0xfffff800043c7000, so=0xfffff8000482f358) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/vps/vps_snapst.c:2494
#2  0xffffffff80dc56ef in vps_snapshot_fdset (ctx=<optimized out>, vps=<optimized out>, p=<optimized out>) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/vps/vps_snapst.c:2819
#3  0xffffffff80dc4a84 in vps_snapshot_proc_one (ctx=0xfffff80003ef3600, vps=<optimized out>, p=0xfffff8000471a000) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/vps/vps_snapst.c:3697
#4  0xffffffff80dc28fa in vps_snapshot_proc (ctx=0xfffff80003ef3600, vps=0xfffff800043c7000) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/vps/vps_snapst.c:1943
#5  0xffffffff80dc11ee in vps_snapshot (dev_ctx=0xfffff80003b3fc00, vps=0xfffff800043c7000, va=<optimized out>) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/vps/vps_snapst.c:565
#6  0xffffffff80dbf1ff in vps_ioc_snapshot (vps=<optimized out>, ctx=0xfffff80003b3fc00, cmd=<optimized out>, data=0xfffff8000442f000 "testvps", flags=<optimized out>, td=<optimized out>)
    at /tank/users/bz/vps_zambcom/vps_zabcom/sys/vps/vps_user.c:432
#7  0xffffffff8092fbb0 in devfs_ioctl (ap=0xfffffe011b1e5868) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/fs/devfs/devfs_vnops.c:808
#8  0xffffffff810b7540 in VOP_IOCTL_APV (vop=<optimized out>, a=0xfffffe011b1e5868) at vnode_if.c:1067
#9  0xffffffff80b4b5b4 in vn_ioctl (fp=0xfffff8000446daa0, com=<optimized out>, data=0xfffff8000442f000, active_cred=0xfffff80003cb4700, td=0x4)
    at /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/vfs_vnops.c:1494
#10 0xffffffff8093028f in devfs_ioctl_f (fp=0xfffff8000482f358, com=18446735277682537984, data=0xfffff800043c7000, cred=0x2, td=0xfffff800045e7580)
    at /tank/users/bz/vps_zambcom/vps_zabcom/sys/fs/devfs/devfs_vnops.c:766
#11 0xffffffff80ad296d in fo_ioctl (fp=<optimized out>, com=3244324626, active_cred=<optimized out>, td=<optimized out>, data=<optimized out>)
    at /tank/users/bz/vps_zambcom/vps_zabcom/sys/sys/file.h:323
#12 kern_ioctl (td=<optimized out>, fd=<optimized out>, com=<optimized out>, data=0xfffff800043c7000 "\200\356\312\003") at /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/sys_generic.c:848
#13 0xffffffff80ad262f in sys_ioctl (td=<optimized out>, uap=0xfffff800045e7938) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/sys_generic.c:757
#14 0xffffffff80f4014d in syscallenter (td=0xfffff800045e7580) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/amd64/amd64/../../kern/subr_syscall.c:137
#15 amd64_syscall (td=0xfffff800045e7580, traced=<optimized out>) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/amd64/amd64/trap.c:948
#16 0xffffffff80f21b54 in Xfast_syscall () at /tank/users/bz/vps_zambcom/vps_zabcom/sys/amd64/amd64/exception.S:399
#17 0x0000000000000003 in ?? ()
#18 0x00000000c1607712 in ?? ()
#19 0x00007fffffffe9b0 in ?? ()
#20 0x0000000000000000 in ?? ()

(kgdb) p/x *so
$2 = {so_lock = {lock_object = {lo_name = 0xffffffff814fd1d0, lo_flags = 0x1430000, lo_data = 0x0, lo_witness = 0xfffffe0000c33e00}, mtx_lock = 0x4}, so_count = 0x1, so_rdsel = {si_tdlist = {
      tqh_first = 0x0, tqh_last = 0xfffff8000482f380}, si_note = {kl_list = {slh_first = 0x0}, kl_lock = 0xffffffff80b00850, kl_unlock = 0xffffffff80b00890,
      kl_assert_locked = 0xffffffff80b008d0, kl_assert_unlocked = 0xffffffff80b00920, kl_lockarg = 0xfffff8000482f358, kl_autodestroy = 0x0}, si_mtx = 0xfffffe000160b270}, so_wrsel = {
    si_tdlist = {tqh_first = 0x0, tqh_last = 0x0}, si_note = {kl_list = {slh_first = 0x0}, kl_lock = 0xffffffff80b00960, kl_unlock = 0xffffffff80b009a0, kl_assert_locked = 0xffffffff80b009e0,
      kl_assert_unlocked = 0xffffffff80b00a30, kl_lockarg = 0xfffff8000482f358, kl_autodestroy = 0x0}, si_mtx = 0x0}, so_type = 0x2, so_options = 0x0, so_linger = 0x0, so_state = 0x0,
  so_pcb = 0xfffff8000479d1a8, so_vnet = 0xfffff80003caee80, so_proto = 0xffffffff81a56e50, so_timeo = 0x0, so_error = 0x0, so_sigio = 0x0, so_cred = 0xfffff8000481e100, so_label = 0x0,
  so_gencnt = 0x806, so_emuldata = 0x0, osd = {osd_nslots = 0x0, osd_slots = 0x0, osd_next = {le_next = 0x0, le_prev = 0x0}}, so_fibnum = 0x0, so_user_cookie = 0x0, so_ts_clock = 0x0,
  so_max_pacing_rate = 0x0, {{so_rcv = {sb_mtx = {lock_object = {lo_name = 0xffffffff814be3c6, lo_flags = 0x1030000, lo_data = 0x0, lo_witness = 0xfffffe0000c27800}, mtx_lock = 0x4}, sb_sx = {
          lock_object = {lo_name = 0xffffffff814a3e0b, lo_flags = 0x2330000, lo_data = 0x0, lo_witness = 0xfffffe0000c33f00}, sx_lock = 0x1}, sb_sel = 0xfffff8000482f380, sb_state = 0x0,
        sb_mb = 0x0, sb_mbtail = 0x0, sb_lastrecord = 0x0, sb_sndptr = 0x0, sb_fnrdy = 0x0, sb_sndptroff = 0x0, sb_acc = 0x0, sb_ccc = 0x0, sb_hiwat = 0xa460, sb_mbcnt = 0x0, sb_mcnt = 0x0,
        sb_ccnt = 0x0, sb_mbmax = 0x52300, sb_ctl = 0x0, sb_lowat = 0x1, sb_timeo = 0x0, sb_flags = 0x8, sb_upcall = 0x0, sb_upcallarg = 0x0, sb_aiojobq = {tqh_first = 0x0,
          tqh_last = 0xfffff8000482f560}, sb_aiotask = {ta_link = {stqe_next = 0x0}, ta_pending = 0x0, ta_priority = 0x0, ta_func = 0xffffffff80adbfb0, ta_context = 0xfffff8000482f358}},
      so_snd = {sb_mtx = {lock_object = {lo_name = 0xffffffff814be3bf, lo_flags = 0x1030000, lo_data = 0x0, lo_witness = 0xfffffe0000c27780}, mtx_lock = 0x4}, sb_sx = {lock_object = {
            lo_name = 0xffffffff814a3e01, lo_flags = 0x2330000, lo_data = 0x0, lo_witness = 0xfffffe0000c33e80}, sx_lock = 0x1}, sb_sel = 0xfffff8000482f3d0, sb_state = 0x0, sb_mb = 0x0,
        sb_mbtail = 0x0, sb_lastrecord = 0x0, sb_sndptr = 0x0, sb_fnrdy = 0x0, sb_sndptroff = 0x0, sb_acc = 0x0, sb_ccc = 0x0, sb_hiwat = 0x2400, sb_mbcnt = 0x0, sb_mcnt = 0x0, sb_ccnt = 0x0,
        sb_mbmax = 0x12000, sb_ctl = 0x0, sb_lowat = 0x800, sb_timeo = 0x0, sb_flags = 0x0, sb_upcall = 0x0, sb_upcallarg = 0x0, sb_aiojobq = {tqh_first = 0x0, tqh_last = 0xfffff8000482f650},
        sb_aiotask = {ta_link = {stqe_next = 0x0}, ta_pending = 0x0, ta_priority = 0x0, ta_func = 0xffffffff80adc720, ta_context = 0xfffff8000482f358}}, so_list = {tqe_next = 0x0,
        tqe_prev = 0x0}, so_listen = 0x0, so_qstate = 0x0, so_peerlabel = 0x0, so_oobmark = 0x0}, {sol_incomp = {tqh_first = 0xffffffff814be3c6, tqh_last = 0x1030000}, sol_comp = {
        tqh_first = 0xfffffe0000c27800, tqh_last = 0x4}, sol_qlen = 0x814a3e0b, sol_incqlen = 0xffffffff, sol_qlimit = 0x2330000, sol_accept_filter = 0xfffffe0000c33f00,
      sol_accept_filter_arg = 0x1, sol_accept_filter_str = 0xfffff8000482f380, sol_upcall = 0x0, sol_upcallarg = 0x0, sol_sbrcv_lowat = 0x0, sol_sbsnd_lowat = 0x0, sol_sbrcv_hiwat = 0x0,
      sol_sbsnd_hiwat = 0x0, sol_sbrcv_flags = 0x0, sol_sbsnd_flags = 0x0, sol_sbrcv_timeo = 0x0, sol_sbsnd_timeo = 0x0}}}


(kgdb) s
2467            printf("XXX-BZ %s:%d so %p ctx %p vps %p\n", __func__, __LINE__, so, ctx, vps);
(kgdb) s
printf (fmt=0xffffffff8151bceb "XXX-BZ %s:%d so %p ctx %p vps %p\n") at /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/subr_prf.c:398
398     {
(kgdb) s
402             va_start(ap, fmt);
(kgdb) n
403             retval = vprintf(fmt, ap);
(kgdb) n
406             return (retval);
(kgdb) n
vps_snapshot_socket (ctx=0xfffff80003ef3600, vps=0xfffff800043c7000, so=0xfffff8000482f358) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/vps/vps_snapst.c:2495
2495            sblock(&so->so_snd, SBL_WAIT | SBL_NOINTR);


(kgdb) s
sblock (sb=0xfffff8000482f590, flags=3) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/uipc_sockbuf.c:274
274             KASSERT((flags & SBL_VALID) == flags,
(kgdb) s
277             if (flags & SBL_WAIT) {
(kgdb) s
278                     if ((sb->sb_flags & SB_NOINTR) ||
(kgdb) s
280                             sx_xlock(&sb->sb_sx);
(kgdb) s
_sx_xlock (sx=0xfffff8000482f5b0, opts=0, file=0xffffffff814c39f8 "/tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/uipc_sockbuf.c", line=280)
    at /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/kern_sx.c:298
298             KASSERT(kdb_active != 0 || SCHEDULER_STOPPED() ||
(kgdb) s
__curthread () at ./machine/pcpu.h:232
232             __asm("movq %%gs:%1,%0" : "=r" (td)
(kgdb) s
_sx_xlock (sx=0xfffff8000482f5b0, opts=0, file=0xffffffff814c39f8 "/tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/uipc_sockbuf.c", line=280)
    at /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/kern_sx.c:298
298             KASSERT(kdb_active != 0 || SCHEDULER_STOPPED() ||
(kgdb) s
302             KASSERT(sx->sx_lock != SX_LOCK_DESTROYED,
(kgdb) s
304             WITNESS_CHECKORDER(&sx->lock_object, LOP_NEWORDER | LOP_EXCLUSIVE, file,
(kgdb) s
witness_checkorder (lock=0xffffffff81d1f700 <tdq_cpu>, flags=11, file=0xffffffff814a3c85 "/tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/kern_clock.c", line=803, interlock=0x0)
    at /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/subr_witness.c:1083
1083            if (witness_cold || witness_watch < 1 || lock->lo_witness == NULL ||
(kgdb) s
1417    }
(kgdb) s
thread_lock_flags_ (td=0xfffff800045e7580, opts=<optimized out>, file=0xffffffff814a3c85 "/tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/kern_clock.c", line=803)
    at /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/kern_mutex.c:830
830                             if (_mtx_obtain_lock_fetch(m, &v, tid))


...

(kgdb) n
witness_checkorder (lock=0xfffff8000482f5b0, flags=9, file=0xffffffff814c39f8 "/tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/uipc_sockbuf.c", line=280, interlock=0x0)
    at /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/subr_witness.c:1075
1075    {
(kgdb) s
1083            if (witness_cold || witness_watch < 1 || lock->lo_witness == NULL ||
(kgdb) s
1084                panicstr != NULL)
(kgdb) s
1088            class = LOCK_CLASS(lock);
(kgdb) s
1089            td = curthread;
(kgdb) s
__curthread () at ./machine/pcpu.h:232
232             __asm("movq %%gs:%1,%0" : "=r" (td)
(kgdb) s
witness_checkorder (lock=0xfffff8000482f5b0, flags=9, file=0xffffffff814c39f8 "/tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/uipc_sockbuf.c", line=280, interlock=0x0)
    at /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/subr_witness.c:1091
1091            if (class->lc_flags & LC_SLEEPLOCK) {
(kgdb) s
1098                    if (td->td_critnest != 0 && !kdb_active)
(kgdb) s
1108                    lock_list = td->td_sleeplocks;
(kgdb) s
1109                    if (lock_list == NULL || lock_list->ll_count == 0)
(kgdb) s
1135            lock1 = find_instance(lock_list, lock);
(kgdb) s
find_instance (lock=<optimized out>, list=<optimized out>) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/subr_witness.c:2163
2163                    for (i = lle->ll_count - 1; i >= 0; i--) {
(kgdb) s
2164                            instance = &lle->ll_children[i];
(kgdb) s
2165                            if (instance->li_lock == lock)
(kgdb) s
2164                            instance = &lle->ll_children[i];
(kgdb) s
2165                            if (instance->li_lock == lock)
2164                            instance = &lle->ll_children[i];
(kgdb) s
2165                            if (instance->li_lock == lock)
(kgdb) s
2164                            instance = &lle->ll_children[i];
(kgdb) s
2165                            if (instance->li_lock == lock)
(kgdb) s
2164                            instance = &lle->ll_children[i];
(kgdb) s
2165                            if (instance->li_lock == lock)
(kgdb) s
2162            for (lle = list; lle != NULL; lle = lle->ll_next)
(kgdb) s
witness_checkorder (lock=0xfffff8000482f5b0, flags=<optimized out>, file=0xffffffff814c39f8 "/tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/uipc_sockbuf.c", line=<optimized out>,
    interlock=<optimized out>) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/subr_witness.c:1159
1159            if (interlock != NULL) {
(kgdb) s
1175            plock = &lock_list->ll_children[lock_list->ll_count - 1];
(kgdb) s
1198            w1 = plock->li_lock->lo_witness;
(kgdb) s
1199            if (witness_lock_order_check(w1, w))
(kgdb) s
witness_lock_order_check (parent=0xfffffe0000c2e380, child=<optimized out>) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/subr_witness.c:2941
2941            if (parent != child &&
(kgdb) s
2942                w_rmatrix[parent->w_index][child->w_index]
(kgdb) s
2943                & WITNESS_LOCK_ORDER_KNOWN &&
(kgdb) s
witness_checkorder (lock=0xfffff8000482f5b0, flags=<optimized out>, file=0xffffffff814c39f8 "/tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/uipc_sockbuf.c", line=<optimized out>,
    interlock=<optimized out>) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/kern/subr_witness.c:1202
1202            mtx_lock_spin(&w_mtx);


...

(kgdb) p/x *(struct socket *)0xfffffe0000c27800
$3 = {so_lock = {lock_object = {lo_name = 0x7663725f6f73, lo_flags = 0x0, lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x0}, so_count = 0x0, so_rdsel = {si_tdlist = {tqh_first = 0x0,
      tqh_last = 0x0}, si_note = {kl_list = {slh_first = 0x0}, kl_lock = 0x10, kl_unlock = 0xffffffff81a25e88, kl_assert_locked = 0xfffffe0000c27780, kl_assert_unlocked = 0xfffffe0000c27780,
      kl_lockarg = 0x0, kl_autodestroy = 0x814c3e90}, si_mtx = 0xb00000ccc}, so_wrsel = {si_tdlist = {tqh_first = 0x200000008001d, tqh_last = 0x6b636c6c6573}, si_note = {kl_list = {
        slh_first = 0x0}, kl_lock = 0x0, kl_unlock = 0x0, kl_assert_locked = 0x0, kl_assert_unlocked = 0x0, kl_lockarg = 0x0, kl_autodestroy = 0x0}, si_mtx = 0x11}, so_type = 0x5e88,
  so_options = 0x81a2, so_linger = 0xffff, so_state = 0xffff, so_pcb = 0xfffffe0000c27800, so_vnet = 0xfffffe0000c27800, so_proto = 0x0, so_timeo = 0xf50f, so_error = 0x814b,
  so_sigio = 0x700000757, so_cred = 0x2a, so_label = 0x6f6e207869646172, so_gencnt = 0x64616568206564, so_emuldata = 0x0, osd = {osd_nslots = 0x0, osd_slots = 0x0, osd_next = {le_next = 0x0,
      le_prev = 0x0}}, so_fibnum = 0x0, so_user_cookie = 0x0, so_ts_clock = 0x12, so_max_pacing_rate = 0x0, {{so_rcv = {sb_mtx = {lock_object = {lo_name = 0xffffffff81a29ef8,
            lo_flags = 0xc27880, lo_data = 0xfffffe00, lo_witness = 0xfffffe0000c27880}, mtx_lock = 0x0}, sb_sx = {lock_object = {lo_name = 0xffffffff814be364, lo_flags = 0x0, lo_data = 0x3,
            lo_witness = 0x5001e}, sx_lock = 0x7972746e657472}, sb_sel = 0x0, sb_state = 0x0, sb_mb = 0x0, sb_mbtail = 0x0, sb_lastrecord = 0x0, sb_sndptr = 0x0, sb_fnrdy = 0x0,
        sb_sndptroff = 0x13, sb_acc = 0x0, sb_ccc = 0x81a25e88, sb_hiwat = 0xffffffff, sb_mbcnt = 0xc27900, sb_mcnt = 0xfffffe00, sb_ccnt = 0xc27900, sb_mbmax = 0xfffffe00, sb_ctl = 0x0,
        sb_lowat = 0x0, sb_timeo = 0xffffffff814d5708, sb_flags = 0x2b1, sb_upcall = 0x40022, sb_upcallarg = 0x726464616669, sb_aiojobq = {tqh_first = 0x0, tqh_last = 0x0}, sb_aiotask = {
          ta_link = {stqe_next = 0x0}, ta_pending = 0x0, ta_priority = 0x0, ta_func = 0x0, ta_context = 0x0}}, so_snd = {sb_mtx = {lock_object = {lo_name = 0x0, lo_flags = 0x14,
            lo_data = 0x0, lo_witness = 0xffffffff81a25e88}, mtx_lock = 0xfffffe0000c27980}, sb_sx = {lock_object = {lo_name = 0xfffffe0000c27980, lo_flags = 0x0, lo_data = 0x0,
            lo_witness = 0xffffffff814be364}, sx_lock = 0x100000000}, sb_sel = 0x23, sb_state = 0x6475, sb_mb = 0x0, sb_mbtail = 0x0, sb_lastrecord = 0x0, sb_sndptr = 0x0, sb_fnrdy = 0x0,
        sb_sndptroff = 0x0, sb_acc = 0x0, sb_ccc = 0x0, sb_hiwat = 0x0, sb_mbcnt = 0x15, sb_mcnt = 0x0, sb_ccnt = 0x81a29ef8, sb_mbmax = 0xffffffff, sb_ctl = 0xc27a00, sb_lowat = 0xfffffe00,
        sb_timeo = 0xfffffe0000c27a00, sb_flags = 0x0, sb_upcall = 0xffffffff8151af73, sb_upcallarg = 0x4b00000954, sb_aiojobq = {tqh_first = 0x140003, tqh_last = 0x69746c756d5f6e69},
        sb_aiotask = {ta_link = {stqe_next = 0x78746d5f}, ta_pending = 0x0, ta_priority = 0x0, ta_func = 0x0, ta_context = 0x0}}, so_list = {tqe_next = 0x0, tqe_prev = 0x0}, so_listen = 0x0,
      so_qstate = 0x16, so_peerlabel = 0xffffffff81a25e88, so_oobmark = 0xfffffe0000c27a80}, {sol_incomp = {tqh_first = 0xffffffff81a29ef8, tqh_last = 0xfffffe0000c27880}, sol_comp = {
        tqh_first = 0xfffffe0000c27880, tqh_last = 0x0}, sol_qlen = 0x814be364, sol_incqlen = 0xffffffff, sol_qlimit = 0x0, sol_accept_filter = 0x5001e,
      sol_accept_filter_arg = 0x7972746e657472, sol_accept_filter_str = 0x0, sol_upcall = 0x0, sol_upcallarg = 0x0, sol_sbrcv_lowat = 0x0, sol_sbsnd_lowat = 0x0, sol_sbrcv_hiwat = 0x0,
      sol_sbsnd_hiwat = 0x0, sol_sbrcv_flags = 0x0, sol_sbsnd_flags = 0x0, sol_sbrcv_timeo = 0x0, sol_sbsnd_timeo = 0x13}}}

(kgdb) p/x $3->so_snd
$4 = {sb_mtx = {lock_object = {lo_name = 0x0, lo_flags = 0x14, lo_data = 0x0, lo_witness = 0xffffffff81a25e88}, mtx_lock = 0xfffffe0000c27980}, sb_sx = {lock_object = {
      lo_name = 0xfffffe0000c27980, lo_flags = 0x0, lo_data = 0x0, lo_witness = 0xffffffff814be364}, sx_lock = 0x100000000}, sb_sel = 0x23, sb_state = 0x6475, sb_mb = 0x0, sb_mbtail = 0x0,
  sb_lastrecord = 0x0, sb_sndptr = 0x0, sb_fnrdy = 0x0, sb_sndptroff = 0x0, sb_acc = 0x0, sb_ccc = 0x0, sb_hiwat = 0x0, sb_mbcnt = 0x15, sb_mcnt = 0x0, sb_ccnt = 0x81a29ef8,
  sb_mbmax = 0xffffffff, sb_ctl = 0xc27a00, sb_lowat = 0xfffffe00, sb_timeo = 0xfffffe0000c27a00, sb_flags = 0x0, sb_upcall = 0xffffffff8151af73, sb_upcallarg = 0x4b00000954, sb_aiojobq = {
    tqh_first = 0x140003, tqh_last = 0x69746c756d5f6e69}, sb_aiotask = {ta_link = {stqe_next = 0x78746d5f}, ta_pending = 0x0, ta_priority = 0x0, ta_func = 0x0, ta_context = 0x0}}


(kgdb) p/x $3->so_rcv
$5 = {sb_mtx = {lock_object = {lo_name = 0xffffffff81a29ef8, lo_flags = 0xc27880, lo_data = 0xfffffe00, lo_witness = 0xfffffe0000c27880}, mtx_lock = 0x0}, sb_sx = {lock_object = {
      lo_name = 0xffffffff814be364, lo_flags = 0x0, lo_data = 0x3, lo_witness = 0x5001e}, sx_lock = 0x7972746e657472}, sb_sel = 0x0, sb_state = 0x0, sb_mb = 0x0, sb_mbtail = 0x0,
  sb_lastrecord = 0x0, sb_sndptr = 0x0, sb_fnrdy = 0x0, sb_sndptroff = 0x13, sb_acc = 0x0, sb_ccc = 0x81a25e88, sb_hiwat = 0xffffffff, sb_mbcnt = 0xc27900, sb_mcnt = 0xfffffe00,
  sb_ccnt = 0xc27900, sb_mbmax = 0xfffffe00, sb_ctl = 0x0, sb_lowat = 0x0, sb_timeo = 0xffffffff814d5708, sb_flags = 0x2b1, sb_upcall = 0x40022, sb_upcallarg = 0x726464616669, sb_aiojobq = {
    tqh_first = 0x0, tqh_last = 0x0}, sb_aiotask = {ta_link = {stqe_next = 0x0}, ta_pending = 0x0, ta_priority = 0x0, ta_func = 0x0, ta_context = 0x0}}


The socket clearly does not look healthy.   So the point is that we are coming from
here:

(kgdb) l *vps_snapshot_fdset+0x3af
0xffffffff80dc56ef is in vps_snapshot_fdset (/tank/users/bz/vps_zambcom/vps_zabcom/sys/vps/vps_snapst.c:2819).
2814                            break;
2815
2816                    case DTYPE_SOCKET:
2817                            if (fp->f_data == NULL)
2818                                    break;
2819                            if ((error = vps_snapshot_socket(ctx, vps,
2820                                fp->f_data)))
2821                                    goto out;
2822                            break;
2823



XXX-BZ vps_snapshot_fdset:2754 fdp 0xfffff800044508a0 fd_nfiles 20 fd_lastfile 0
XXX-BZ vps_snapshot_fdset:2844 so 0xfffff8000450c358 fp 0xfffff80004189960 i 0
XXX-BZ __bz_dss:2467 so 0xfffff8000450c358 ctx 0xfffff80003bdf600 vps 0xfffff800040e2800
XXX-BZ vps_snapshot_socket:2589 so 0xfffff8000450c358

Coming from the sol_qlen / sol_incqlen ...  case; but our original socket as in the
fdset is corrupted...

XXX-BZ __bz_dss:2467 so 0xffffffff814bac7d ctx 0xfffff80003bdf600 vps 0xfffff800040e2800

(kgdb) p/x *(struct socket *)0xfffff8000450c358
$1 = {so_lock = {lock_object = {lo_name = 0xffffffff814f5400, lo_flags = 0x1430000, lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x4}, so_count = 0x1, so_rdsel = {si_tdlist = {
      tqh_first = 0x0, tqh_last = 0xfffff8000450c380}, si_note = {kl_list = {slh_first = 0x0}, kl_lock = 0xffffffff80afa400, kl_unlock = 0xffffffff80afa440,
      kl_assert_locked = 0xffffffff80afa480, kl_assert_unlocked = 0xffffffff80afa4d0, kl_lockarg = 0xfffff8000450c358, kl_autodestroy = 0x0}, si_mtx = 0xfffffe00015d2f90}, so_wrsel = {
    si_tdlist = {tqh_first = 0x0, tqh_last = 0x0}, si_note = {kl_list = {slh_first = 0x0}, kl_lock = 0xffffffff80afa510, kl_unlock = 0xffffffff80afa550, kl_assert_locked = 0xffffffff80afa590,
      kl_assert_unlocked = 0xffffffff80afa5e0, kl_lockarg = 0xfffff8000450c358, kl_autodestroy = 0x0}, si_mtx = 0x0}, so_type = 0x2, so_options = 0x0, so_linger = 0x0, so_state = 0x0,
  so_pcb = 0xfffff8000452c1a8, so_vnet = 0xfffff80003997e80, so_proto = 0xffffffff81a4e7a0, so_timeo = 0x0, so_error = 0x0, so_sigio = 0x0, so_cred = 0xfffff800044b7200, so_label = 0x0,
  so_gencnt = 0x7fa, so_emuldata = 0x0, osd = {osd_nslots = 0x0, osd_slots = 0x0, osd_next = {le_next = 0x0, le_prev = 0x0}}, so_fibnum = 0x0, so_user_cookie = 0x0, so_ts_clock = 0x0,
  so_max_pacing_rate = 0x0, {{so_rcv = {sb_mtx = {lock_object = {lo_name = 0xffffffff814bac7d, lo_flags = 0x1030000, lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x4}, sb_sx = {lock_object = {
            lo_name = 0xffffffff8149dc2b, lo_flags = 0x2330000, lo_data = 0x0, lo_witness = 0x0}, sx_lock = 0x1}, sb_sel = 0xfffff8000450c380, sb_state = 0x0, sb_mb = 0x0, sb_mbtail = 0x0,
        sb_lastrecord = 0x0, sb_sndptr = 0x0, sb_fnrdy = 0x0, sb_sndptroff = 0x0, sb_acc = 0x0, sb_ccc = 0x0, sb_hiwat = 0xa460, sb_mbcnt = 0x0, sb_mcnt = 0x0, sb_ccnt = 0x0,
        sb_mbmax = 0x52300, sb_ctl = 0x0, sb_lowat = 0x1, sb_timeo = 0x0, sb_flags = 0x8, sb_upcall = 0x0, sb_upcallarg = 0x0, sb_aiojobq = {tqh_first = 0x0, tqh_last = 0xfffff8000450c560},
        sb_aiotask = {ta_link = {stqe_next = 0x0}, ta_pending = 0x0, ta_priority = 0x0, ta_func = 0xffffffff80ad5d30, ta_context = 0xfffff8000450c358}}, so_snd = {sb_mtx = {lock_object = {
            lo_name = 0xffffffff814bac84, lo_flags = 0x1030000, lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x4}, sb_sx = {lock_object = {lo_name = 0xffffffff8149dc21, lo_flags = 0x2330000,
            lo_data = 0x0, lo_witness = 0x0}, sx_lock = 0x1}, sb_sel = 0xfffff8000450c3d0, sb_state = 0x0, sb_mb = 0x0, sb_mbtail = 0x0, sb_lastrecord = 0x0, sb_sndptr = 0x0, sb_fnrdy = 0x0,
        sb_sndptroff = 0x0, sb_acc = 0x0, sb_ccc = 0x0, sb_hiwat = 0x2400, sb_mbcnt = 0x0, sb_mcnt = 0x0, sb_ccnt = 0x0, sb_mbmax = 0x12000, sb_ctl = 0x0, sb_lowat = 0x800, sb_timeo = 0x0,
        sb_flags = 0x0, sb_upcall = 0x0, sb_upcallarg = 0x0, sb_aiojobq = {tqh_first = 0x0, tqh_last = 0xfffff8000450c650}, sb_aiotask = {ta_link = {stqe_next = 0x0}, ta_pending = 0x0,
          ta_priority = 0x0, ta_func = 0xffffffff80ad64a0, ta_context = 0xfffff8000450c358}}, so_list = {tqe_next = 0x0, tqe_prev = 0x0}, so_listen = 0x0, so_qstate = 0x0, so_peerlabel = 0x0,
      so_oobmark = 0x0}, {sol_incomp = {tqh_first = 0xffffffff814bac7d, tqh_last = 0x1030000}, sol_comp = {tqh_first = 0x0, tqh_last = 0x4}, sol_qlen = 0x8149dc2b, sol_incqlen = 0xffffffff,
      sol_qlimit = 0x2330000, sol_accept_filter = 0x0, sol_accept_filter_arg = 0x1, sol_accept_filter_str = 0xfffff8000450c380, sol_upcall = 0x0, sol_upcallarg = 0x0, sol_sbrcv_lowat = 0x0,
      sol_sbsnd_lowat = 0x0, sol_sbrcv_hiwat = 0x0, sol_sbsnd_hiwat = 0x0, sol_sbrcv_flags = 0x0, sol_sbsnd_flags = 0x0, sol_sbrcv_timeo = 0x0, sol_sbsnd_timeo = 0x0}}}
(kgdb) p/x $1->sol_qlen
$2 = 0x8149dc2b
(kgdb) p/x $1->sol_incqlen
$3 = 0xffffffff



Problem remains that the socket coming from the fd_data is corrupted:

(kgdb) break *__bz_dss
Breakpoint 1 at 0xffffffff80dc0e90: file /tank/users/bz/vps_zambcom/vps_zabcom/sys/vps/vps_snapst.c, line 2465.
(kgdb) cont
Continuing.

Breakpoint 1, __bz_dss (so=0xfffff80004518358, ctx=0xfffff80003bdf600, vps=0xfffff80003c40000) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/vps/vps_snapst.c:2465
warning: Source file is more recent than executable.
2465    {
(kgdb) p/x *(struct socket *)0xfffff80004518358
$4 = {so_lock = {lock_object = {lo_name = 0xffffffff814f5400, lo_flags = 0x1430000, lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x4}, so_count = 0x1, so_rdsel = {si_tdlist = {
      tqh_first = 0x0, tqh_last = 0xfffff80004518380}, si_note = {kl_list = {slh_first = 0x0}, kl_lock = 0xffffffff80afa400, kl_unlock = 0xffffffff80afa440,
      kl_assert_locked = 0xffffffff80afa480, kl_assert_unlocked = 0xffffffff80afa4d0, kl_lockarg = 0xfffff80004518358, kl_autodestroy = 0x0}, si_mtx = 0xfffffe00015d2950}, so_wrsel = {
    si_tdlist = {tqh_first = 0x0, tqh_last = 0x0}, si_note = {kl_list = {slh_first = 0x0}, kl_lock = 0xffffffff80afa510, kl_unlock = 0xffffffff80afa550, kl_assert_locked = 0xffffffff80afa590,
      kl_assert_unlocked = 0xffffffff80afa5e0, kl_lockarg = 0xfffff80004518358, kl_autodestroy = 0x0}, si_mtx = 0x0}, so_type = 0x2, so_options = 0x0, so_linger = 0x0, so_state = 0x0,
  so_pcb = 0xfffff8000454e1a8, so_vnet = 0xfffff80003997e80, so_proto = 0xffffffff81a4e7a0, so_timeo = 0x0, so_error = 0x0, so_sigio = 0x0, so_cred = 0xfffff8000451ce00, so_label = 0x0,
  so_gencnt = 0xb52, so_emuldata = 0x0, osd = {osd_nslots = 0x0, osd_slots = 0x0, osd_next = {le_next = 0x0, le_prev = 0x0}}, so_fibnum = 0x0, so_user_cookie = 0x0, so_ts_clock = 0x0,
  so_max_pacing_rate = 0x0, {{so_rcv = {sb_mtx = {lock_object = {lo_name = 0xffffffff814bac7d, lo_flags = 0x1030000, lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x4}, sb_sx = {lock_object = {
            lo_name = 0xffffffff8149dc2b, lo_flags = 0x2330000, lo_data = 0x0, lo_witness = 0x0}, sx_lock = 0x1}, sb_sel = 0xfffff80004518380, sb_state = 0x0, sb_mb = 0x0, sb_mbtail = 0x0,
        sb_lastrecord = 0x0, sb_sndptr = 0x0, sb_fnrdy = 0x0, sb_sndptroff = 0x0, sb_acc = 0x0, sb_ccc = 0x0, sb_hiwat = 0xa460, sb_mbcnt = 0x0, sb_mcnt = 0x0, sb_ccnt = 0x0,
        sb_mbmax = 0x52300, sb_ctl = 0x0, sb_lowat = 0x1, sb_timeo = 0x0, sb_flags = 0x8, sb_upcall = 0x0, sb_upcallarg = 0x0, sb_aiojobq = {tqh_first = 0x0, tqh_last = 0xfffff80004518560},
        sb_aiotask = {ta_link = {stqe_next = 0x0}, ta_pending = 0x0, ta_priority = 0x0, ta_func = 0xffffffff80ad5d30, ta_context = 0xfffff80004518358}}, so_snd = {sb_mtx = {lock_object = {
            lo_name = 0xffffffff814bac84, lo_flags = 0x1030000, lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x4}, sb_sx = {lock_object = {lo_name = 0xffffffff8149dc21, lo_flags = 0x2330000,
            lo_data = 0x0, lo_witness = 0x0}, sx_lock = 0x1}, sb_sel = 0xfffff800045183d0, sb_state = 0x0, sb_mb = 0x0, sb_mbtail = 0x0, sb_lastrecord = 0x0, sb_sndptr = 0x0, sb_fnrdy = 0x0,
        sb_sndptroff = 0x0, sb_acc = 0x0, sb_ccc = 0x0, sb_hiwat = 0x2400, sb_mbcnt = 0x0, sb_mcnt = 0x0, sb_ccnt = 0x0, sb_mbmax = 0x12000, sb_ctl = 0x0, sb_lowat = 0x800, sb_timeo = 0x0,
        sb_flags = 0x0, sb_upcall = 0x0, sb_upcallarg = 0x0, sb_aiojobq = {tqh_first = 0x0, tqh_last = 0xfffff80004518650}, sb_aiotask = {ta_link = {stqe_next = 0x0}, ta_pending = 0x0,
          ta_priority = 0x0, ta_func = 0xffffffff80ad64a0, ta_context = 0xfffff80004518358}}, so_list = {tqe_next = 0x0, tqe_prev = 0x0}, so_listen = 0x0, so_qstate = 0x0, so_peerlabel = 0x0,
      so_oobmark = 0x0}, {sol_incomp = {tqh_first = 0xffffffff814bac7d, tqh_last = 0x1030000}, sol_comp = {tqh_first = 0x0, tqh_last = 0x4}, sol_qlen = 0x8149dc2b, sol_incqlen = 0xffffffff,
      sol_qlimit = 0x2330000, sol_accept_filter = 0x0, sol_accept_filter_arg = 0x1, sol_accept_filter_str = 0xfffff80004518380, sol_upcall = 0x0, sol_upcallarg = 0x0, sol_sbrcv_lowat = 0x0,
      sol_sbsnd_lowat = 0x0, sol_sbrcv_hiwat = 0x0, sol_sbsnd_hiwat = 0x0, sol_sbrcv_flags = 0x0, sol_sbsnd_flags = 0x0, sol_sbrcv_timeo = 0x0, sol_sbsnd_timeo = 0x0}}}
(kgdb) p/x $4->sol_incqlen
$5 = 0xffffffff

--------------------------------------------------------------------------------

XXX-BZ vps2 0xfffff8000399b800 initproc = 0xfffff80004453540 swapper 0xfffff8000
4454540 reaper 0xfffff80004454540 pptr 0xfffff80004454540
XXX-BZ soalloc:451 NEW so 0xfffff8000451d358
XXX-BZ socreate:572 CREATE so 0xfffff8000451d358
XXX-BZ kern_socket:169 so 0xfffff8000451d358
Expensive timeout(9) function: 0xffffffff80af0a90(0) 0.005202369 s
Active VPS instances: 1
Name                 State    VFS Root                     %CPU   Virtual Size
testvps              suspended /vpsroot                        6        8732672
Name:          testvps
Status:        suspended
VFS root:      /vpsroot
Processes:            1
Sockets:              1
Interfaces:           2
Restore count:        0
root@:~ #


(kgdb) p/x *(struct socket *)0xfffff8000451d358
$1 = {so_lock = {lock_object = {lo_name = 0xffffffff814f5410, lo_flags = 0x1430000, lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x4}, so_count = 0x1, so_rdsel = {si_tdlist = {
      tqh_first = 0x0, tqh_last = 0xfffff8000451d380}, si_note = {kl_list = {slh_first = 0x0}, kl_lock = 0xffffffff80afa460, kl_unlock = 0xffffffff80afa4a0,
      kl_assert_locked = 0xffffffff80afa4e0, kl_assert_unlocked = 0xffffffff80afa530, kl_lockarg = 0xfffff8000451d358, kl_autodestroy = 0x0}, si_mtx = 0xfffffe00015d2eb0}, so_wrsel = {
    si_tdlist = {tqh_first = 0x0, tqh_last = 0x0}, si_note = {kl_list = {slh_first = 0x0}, kl_lock = 0xffffffff80afa570, kl_unlock = 0xffffffff80afa5b0, kl_assert_locked = 0xffffffff80afa5f0,
      kl_assert_unlocked = 0xffffffff80afa640, kl_lockarg = 0xfffff8000451d358, kl_autodestroy = 0x0}, si_mtx = 0x0}, so_type = 0x2, so_options = 0x0, so_linger = 0x0, so_state = 0x0,
  so_pcb = 0xfffff8000455d1a8, so_vnet = 0xfffff80003997e80, so_proto = 0xffffffff81a4e7a0, so_timeo = 0x0, so_error = 0x0, so_sigio = 0x0, so_cred = 0xfffff80004514100, so_label = 0x0,
  so_gencnt = 0x7f6, so_emuldata = 0x0, osd = {osd_nslots = 0x0, osd_slots = 0x0, osd_next = {le_next = 0x0, le_prev = 0x0}}, so_fibnum = 0x0, so_user_cookie = 0x0, so_ts_clock = 0x0,
  so_max_pacing_rate = 0x0, {{so_rcv = {sb_mtx = {lock_object = {lo_name = 0xffffffff814bac7d, lo_flags = 0x1030000, lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x4}, sb_sx = {lock_object = {
            lo_name = 0xffffffff8149dc2b, lo_flags = 0x2330000, lo_data = 0x0, lo_witness = 0x0}, sx_lock = 0x1}, sb_sel = 0xfffff8000451d380, sb_state = 0x0, sb_mb = 0x0, sb_mbtail = 0x0,
        sb_lastrecord = 0x0, sb_sndptr = 0x0, sb_fnrdy = 0x0, sb_sndptroff = 0x0, sb_acc = 0x0, sb_ccc = 0x0, sb_hiwat = 0xa460, sb_mbcnt = 0x0, sb_mcnt = 0x0, sb_ccnt = 0x0,
        sb_mbmax = 0x52300, sb_ctl = 0x0, sb_lowat = 0x1, sb_timeo = 0x0, sb_flags = 0x8, sb_upcall = 0x0, sb_upcallarg = 0x0, sb_aiojobq = {tqh_first = 0x0, tqh_last = 0xfffff8000451d560},
        sb_aiotask = {ta_link = {stqe_next = 0x0}, ta_pending = 0x0, ta_priority = 0x0, ta_func = 0xffffffff80ad5d30, ta_context = 0xfffff8000451d358}}, so_snd = {sb_mtx = {lock_object = {
            lo_name = 0xffffffff814bac84, lo_flags = 0x1030000, lo_data = 0x0, lo_witness = 0x0}, mtx_lock = 0x4}, sb_sx = {lock_object = {lo_name = 0xffffffff8149dc21, lo_flags = 0x2330000,
            lo_data = 0x0, lo_witness = 0x0}, sx_lock = 0x1}, sb_sel = 0xfffff8000451d3d0, sb_state = 0x0, sb_mb = 0x0, sb_mbtail = 0x0, sb_lastrecord = 0x0, sb_sndptr = 0x0, sb_fnrdy = 0x0,
        sb_sndptroff = 0x0, sb_acc = 0x0, sb_ccc = 0x0, sb_hiwat = 0x2400, sb_mbcnt = 0x0, sb_mcnt = 0x0, sb_ccnt = 0x0, sb_mbmax = 0x12000, sb_ctl = 0x0, sb_lowat = 0x800, sb_timeo = 0x0,
        sb_flags = 0x0, sb_upcall = 0x0, sb_upcallarg = 0x0, sb_aiojobq = {tqh_first = 0x0, tqh_last = 0xfffff8000451d650}, sb_aiotask = {ta_link = {stqe_next = 0x0}, ta_pending = 0x0,
          ta_priority = 0x0, ta_func = 0xffffffff80ad64a0, ta_context = 0xfffff8000451d358}}, so_list = {tqe_next = 0x0, tqe_prev = 0x0}, so_listen = 0x0, so_qstate = 0x0, so_peerlabel = 0x0,
      so_oobmark = 0x0}, {sol_incomp = {tqh_first = 0xffffffff814bac7d, tqh_last = 0x1030000}, sol_comp = {tqh_first = 0x0, tqh_last = 0x4}, sol_qlen = 0x8149dc2b, sol_incqlen = 0xffffffff,
      sol_qlimit = 0x2330000, sol_accept_filter = 0x0, sol_accept_filter_arg = 0x1, sol_accept_filter_str = 0xfffff8000451d380, sol_upcall = 0x0, sol_upcallarg = 0x0, sol_sbrcv_lowat = 0x0,
      sol_sbsnd_lowat = 0x0, sol_sbrcv_hiwat = 0x0, sol_sbsnd_hiwat = 0x0, sol_sbrcv_flags = 0x0, sol_sbsnd_flags = 0x0, sol_sbrcv_timeo = 0x0, sol_sbsnd_timeo = 0x0}}}


(kgdb) p/x $1->sol_qlen
$2 = 0x8149dc2b
(kgdb) p/x $1->sol_incqlen
$3 = 0xffffffff

NOT GOOD.

--------------------------------------------------------------------------------

(kgdb) break *__bz_sigsegv
Breakpoint 1 at 0xffffffff80f39ca0: file /tank/users/bz/vps_zambcom/vps_zabcom/sys/amd64/amd64/trap.c, line 166.
(kgdb) cont
Continuing.

Breakpoint 1, __bz_sigsegv (f=0xffffffff81529098 "trap_pfault", l=830, td=0xfffff80004233000, frame=0xfffffe00f7125c00) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/amd64/amd64/trap.c:166
166     {
(kgdb) p/x bz_log
$1 = {p = 0xfffff80004129540, td = 0xfffff80004233000, frame = 0xfffffe00f7125c00, stack = 0xfffffe00f7122000, frame_copy = {tf_rdi = 0x1, tf_rsi = 0x7fffffffecd0, tf_rdx = 0x0, tf_rcx = 0x0,
    tf_r8 = 0x0, tf_r9 = 0x0, tf_rax = 0x5d, tf_rbx = 0x1, tf_rbp = 0x7fffffffed70, tf_r10 = 0x6530, tf_r11 = 0x800896570, tf_r12 = 0x0, tf_r13 = 0x7fffffffedd0, tf_r14 = 0x7fffffffecd0,
    tf_r15 = 0x0, tf_trapno = 0xc, tf_fs = 0x13, tf_gs = 0x1b, tf_addr = 0x7fffffffecc8, tf_flags = 0x1, tf_es = 0x3b, tf_ds = 0x3b, tf_err = 0x4, tf_rip = 0x41b7f0, tf_cs = 0x43,
    tf_rflags = 0x246, tf_rsp = 0x7fffffffecc8, tf_ss = 0x3b}, map = 0xfffff800044a8000, eva = 0x7fffffffecc8, va = 0x7fffffffe000, ftype = 0x1, rv = 0x0}
(kgdb) i/x 0x41b7f0
Undefined info command: "/x 0x41b7f0".  Try "help info".
(kgdb) x/i 0x41b7f0
   0x41b7f0:    retq
(kgdb) where
#0  __bz_sigsegv (f=0xffffffff81529098 "trap_pfault", l=830, td=0xfffff80004233000, frame=0xfffffe00f7125c00) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/amd64/amd64/trap.c:166
#1  0xffffffff80f39a5d in trap_pfault (frame=<optimized out>, usermode=<optimized out>) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/amd64/amd64/trap.c:830
#2  0xffffffff80f39067 in trap (frame=0xfffffe00f7125c00) at /tank/users/bz/vps_zambcom/vps_zabcom/sys/amd64/amd64/trap.c:342
#3  0xffffffff80f1b101 in calltrap () at /tank/users/bz/vps_zambcom/vps_zabcom/sys/amd64/amd64/exception.S:236
#4  0x0000000000000001 in ?? ()
#5  0x00007fffffffecd0 in ?? ()
#6  0x0000000000000000 in ?? ()
(kgdb) p/x 0x41b7f0
$2 = 0x41b7f0
(kgdb) p/x *0x41b7f0
$3 = 0xccccccc3
(kgdb) p/x *(struct trapframe *)0xfffffe00f7125c00
$4 = {tf_rdi = 0x1, tf_rsi = 0x7fffffffecd0, tf_rdx = 0x0, tf_rcx = 0x0, tf_r8 = 0x0, tf_r9 = 0x0, tf_rax = 0x5d, tf_rbx = 0x1, tf_rbp = 0x7fffffffed70, tf_r10 = 0x6530, tf_r11 = 0x800896570,
  tf_r12 = 0x0, tf_r13 = 0x7fffffffedd0, tf_r14 = 0x7fffffffecd0, tf_r15 = 0x0, tf_trapno = 0xc, tf_fs = 0x13, tf_gs = 0x1b, tf_addr = 0x0, tf_flags = 0x1, tf_es = 0x3b, tf_ds = 0x3b,
  tf_err = 0x14, tf_rip = 0x0, tf_cs = 0x43, tf_rflags = 0x246, tf_rsp = 0x7fffffffecd0, tf_ss = 0x3b}

--------------------------------------------------------------------------------

vps1: bpf attached
tcp_output: VPS_VNET_SUSPENDED --> returning EINTR, so=0xfffff8000e8c16b0
Expensive timeout(9) function: 0xffffffff80c7e9e0(0xfffff8000ec2a6d0) 0.006426260 s
vps_suspend_relink_delete: get_next_dirent() error=2
Active VPS instances: 1
Name                 State    VFS Root                     %CPU   Virtual Size
testvps              suspended /vpsroot                        1      166039552
Name:          testvps
Status:        suspended
VFS root:      /vpsroot
Processes:           12
Sockets:              4
Interfaces:           2
Restore count:        0
root@rabbit3:~ # tcp_output: VPS_VNET_SUSPENDED --> returning EINTR, so=0xfffff8000e8c1358
Expensive timeout(9) function: 0xffffffff80c7fd20(0xfffff8000ec2aa38) 0.006429691 s



smmsp 425  0.0 25.0 550492 1024       -  I    13:57   0:00.00 sendmail: ./w063  25  423   0  33  0 select
root  427  0.0 25.0 541508 1024       -  Is   13:57   0:00.00 /usr/sbin/cron -   0    1   0  23  0 nanslp
root  457  0.0 23.4 550560  960       -  I    13:55   0:00.00 sendmail: w08Dsv   0  420   0  33  0 select
root  524  0.0 25.0 534276 1024       -  S    14:03   0:00.00 /sbin/init         0    1   0  20  0 nanslp
root  526  0.0 65.3  25868 2676 #C:0x9b  R+   14:03   0:00.00 ps axuwel          0  743   0  20  0 -
root  743  0.0 95.5  25420 3912 #C:0x9b  Ss   13:58   0:00.01 /bin/csh           0    1   0  20  0 pause
# procstat -k 524
  PID    TID COMM                TDNAME              KSTACK
  524 100115 init                -                   mi_switch sleepq_switch sleepq_catch_signals sleepq_timedwait_sig _sleep kern_clock_nanosleep sys_nanosleep amd64_syscall Xfast_syscall
# procstat -k 457
  PID    TID COMM                TDNAME              KSTACK
  457 100103 sendmail            -                   mi_switch sleepq_switch sleepq_catch_signals sleepq_timedwait_sig _cv_timedwait_sig_sbt seltdwait kern_select sys_select amd64_syscall Xfast_syscall
# procstat -k 427
  PID    TID COMM                TDNAME              KSTACK
  427 100104 cron                -                   mi_switch sleepq_switch sleepq_catch_signals sleepq_timedwait_sig _sleep kern_clock_nanosleep sys_nanosleep amd64_syscall Xfast_syscall
# procstat -k 425
  PID    TID COMM                TDNAME              KSTACK
  425 100105 sendmail            -                   mi_switch sleepq_switch sleepq_catch_signals sleepq_timedwait_sig _cv_timedwait_sig_sbt seltdwait kern_select sys_select amd64_syscall Xfast_syscall
# procstat -k 1
  PID    TID COMM                TDNAME              KSTACK
    1 100108 init                -                   mi_switch sleepq_switch sleepq_catch_signals sleepq_wait_sig _sleep kern_wait6 sys_wait4 amd64_syscall Xfast_syscall

--------------------------------------------------------------------------------




# end
